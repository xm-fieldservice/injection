# Injection工具 - 系统功能说明书

## 1. 系统概述

### 1.1 系统定位
Injection工具是一个Windows平台下的命令注入和日志管理工具，主要用于：
- 向目标应用程序注入预设的命令模板
- 管理和记录工作日志
- 提供脑图集成和项目管理功能
- 支持多模板管理和自动化工作流

### 1.2 核心价值
- **提高工作效率**: 通过模板化命令快速注入常用指令
- **统一日志管理**: 自动记录所有操作和工作总结  
- **项目绑定机制**: 支持多项目切换和独立配置
- **数据安全保障**: 多重备份机制确保数据不丢失

### 1.3 技术架构
- **开发语言**: Python 3.8+
- **UI框架**: PyQt5
- **数据存储**: JSON配置文件 + Markdown日志文件
- **进程通信**: Windows API (user32.dll)
- **文件监控**: QTimer + 文件系统监控

## 2. 核心功能模块

### 2.1 命令注入模块 ⭐⭐⭐⭐⭐

**功能描述**: 将预设的命令模板注入到目标应用程序的输入区域

**技术实现**:
```python
# 核心注入流程
def inject_command(self):
    1. 获取并验证输入内容
    2. 应用模板装饰（前缀+内容+后缀）
    3. 检测目标窗口
    4. 窗口激活和焦点获取
    5. 复制到剪贴板
    6. 模拟鼠标点击定位
    7. 粘贴内容（Ctrl+V）
    8. 发送回车键
    9. 验证注入结果
    10. 记录日志和创建备份
```

**关键特性**:
- ✅ **多重窗口激活策略**: ShowWindow + SetForegroundWindow
- ✅ **剪贴板内容验证**: 确保复制操作成功
- ✅ **注入结果检测**: 通过输入框状态验证注入是否成功
- ✅ **重试机制**: 窗口激活失败时自动重试
- ✅ **详细诊断日志**: 记录每个步骤的执行状态

**故障诊断系统**:
```python
# 诊断检测点
INJECTION_START              # 注入开始
PRE_WINDOW_ACTIVATION        # 窗口激活前状态
WINDOW_ACTIVATION            # 窗口激活操作
WINDOW_ACTIVATION_FAILED     # 窗口激活失败
CLIPBOARD_OPERATION          # 剪贴板操作
PASTE_OPERATION              # 粘贴操作
ENTER_KEY                    # 回车键操作
INJECTION_RESULT_SUCCESS     # 注入成功
INJECTION_RESULT_FAILED      # 注入失败
```

**错误处理**:
- 目标窗口未找到：提示用户进行校准
- 剪贴板操作失败：自动重试并记录错误
- 注入无响应：详细记录诊断信息供分析

### 2.2 模板管理模块 ⭐⭐⭐⭐

**功能描述**: 管理命令模板的场景、版本和内容配置

**数据结构**:
```json
{
  "自然模式": {
    "默认模板": {
      "prefix": "每次回答或者工作后，生成本次回答或者工作的总结...",
      "suffix": "",
      "variables": {}
    },
    "简化版本": {
      "prefix": "简化提示词...",
      "suffix": "",
      "variables": {}
    }
  }
}
```

**核心功能**:
- ✅ **场景分类管理**: 自然模式、编程模式、写作模式等
- ✅ **版本控制**: 每个场景下可有多个模板版本
- ✅ **模板变量**: 支持动态变量替换
- ✅ **默认模板机制**: 支持设置默认场景和版本
- ✅ **模板导入导出**: 支持模板的备份和共享

**默认模板长效机制**:
```python
# 持久化配置
{
  "default_scene": "自然模式",
  "default_version": "默认模板",
  "instance_id": "persistent_id"
}
```

**技术要点**:
- 使用持久化实例ID避免配置文件重复创建
- 启动时自动加载默认模板配置
- 界面中用★标记默认模板

### 2.3 日志管理模块 ⭐⭐⭐⭐⭐

**功能描述**: 统一管理所有操作的日志记录，采用结构化Markdown格式

**日志格式标准**:
```markdown
# 2025-06-08 12:22:39 (操作标题 - 项目：injection)

## 📥 输入
[用户的输入内容或操作描述]

## 📤 输出  
[系统的响应结果或工作总结]
```

**记录范围**:
- ✅ **命令注入记录**: 注入的命令内容和执行结果
- ✅ **笔记记录**: 用户手动记录的笔记内容
- ✅ **文本捕获记录**: 从其他窗口捕获的文本内容
- ✅ **标签使用记录**: 标签点击和插入操作
- ✅ **系统操作记录**: 配置变更、错误信息等

**技术实现**:
```python
def write_to_log(self, content_type, user_input, system_output):
    timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    project_name = self.project_name or "unknown"
    
    log_content = f"""
# {timestamp} ({content_type} - 项目：{project_name})

## 📥 输入
{user_input}

## 📤 输出
{system_output}
"""
    
    # 写入日志文件
    # 触发双重备份
    # 更新文件监控
```

### 2.4 备份保护模块 ⭐⭐⭐⭐⭐

**功能描述**: 多层次的数据保护机制，确保日志数据安全

**双备份机制**:
```python
# 每次日志更新后立即创建两个备份
backup_1 = f"{project_name}-log-bak-1.md"      # 固定名称，覆盖更新
backup_2 = f"{project_name}-log-bak-2.md"      # 固定名称，覆盖更新
```

**备份触发时机**:
- ✅ **程序启动时**: 创建startup备份（带时间戳）
- ✅ **命令注入后**: 创建双重备份
- ✅ **记录笔记后**: 创建双重备份
- ✅ **文本捕获后**: 创建双重备份
- ✅ **文件监控检测到变化**: 自动创建双重备份

**文件监控系统**:
```python
def start_log_file_monitoring(self):
    """启动日志文件监控，2秒间隔检查文件变化"""
    self.log_monitor_timer = QTimer()
    self.log_monitor_timer.timeout.connect(self.check_log_file_changes)
    self.log_monitor_timer.start(2000)
```

**完整性检查**:
- 文件缺失检测
- 文件大小异常检测
- 文件内容截断检测
- 自动恢复机制

**恢复策略**:
```python
def auto_recover_log_file(self):
    1. 检测日志文件状态
    2. 如发现问题，从最新备份恢复
    3. 记录恢复操作日志
    4. 创建recovery备份
```

### 2.5 项目绑定模块 ⭐⭐⭐⭐

**功能描述**: 支持多项目管理，每个项目独立配置和日志

**核心机制**:
```python
# 项目配置
{
  "project_name": "injection",
  "project_folder": "D:/AI-Projects/injection",
  "log_file": "injection-log.md",
  "config_file": "config_instance_xxxxx.json"
}
```

**功能特性**:
- ✅ **自动项目检测**: 启动时自动检测当前目录
- ✅ **手动项目选择**: 支持用户选择项目文件夹
- ✅ **独立配置管理**: 每个项目独立的模板和设置
- ✅ **独立日志文件**: 按项目名称生成独立的日志文件

**项目切换流程**:
```python
def switch_project(self, new_project_path):
    1. 释放当前项目锁
    2. 检查新项目实例冲突
    3. 保存当前项目配置
    4. 加载新项目配置
    5. 创建新项目锁
    6. 初始化新项目环境
    7. 更新UI界面显示
```

### 2.6 实例互斥模块 ⭐⭐⭐⭐

**功能描述**: 确保同一项目只能被一个工具实例绑定

**锁机制实现**:
```python
# 项目锁文件: .project_lock_{项目名称}
{
    "instance_id": "82833522",
    "pid": 12345,
    "project_name": "injection", 
    "lock_time": "2025-01-06T16:50:00",
    "project_folder": "D:/AI-Projects/injection"
}
```

**冲突检测**:
```python
def check_project_instance_conflict(self, project_name):
    1. 查找项目锁文件
    2. 验证锁定进程是否还在运行
    3. 如进程已结束，清理过期锁
    4. 如进程仍运行，返回冲突信息
```

**安全机制**:
- ✅ **进程验证**: 使用psutil验证进程真实状态
- ✅ **自动清理**: 启动时清理过期锁文件
- ✅ **优雅释放**: 程序退出时自动释放锁
- ✅ **冲突提示**: 用户友好的冲突提示界面

### 2.7 标签系统模块 ⭐⭐⭐

**功能描述**: 提供快速标签插入功能，便于内容分类和查询

**标签类型**:
- `[任务]` - 绿色按钮 (#4CAF50)
- `[里程碑]` - 蓝色按钮 (#2196F3)  
- `[问题]` - 橙色按钮 (#FF9800)

**交互逻辑**:
```python
def on_tag_clicked(self, tag_name):
    1. 获取当前文本框光标位置
    2. 生成标准标签格式: [标签名]
    3. 在光标位置插入标签
    4. 显示操作成功提示
```

**应用场景**:
- 在命令注入前标记内容类型
- 在笔记记录时分类内容
- 便于后续搜索和筛选

### 2.8 校准系统模块 ⭐⭐⭐

**功能描述**: 鼠标位置校准，确保注入命令能准确定位到目标输入框

**校准流程**:
```python
def start_calibration(self):
    1. 显示校准进度对话框
    2. 启动鼠标点击监听
    3. 捕获用户点击的位置
    4. 保存校准坐标
    5. 验证校准效果
```

**技术实现**:
- 使用Windows API监听全局鼠标点击
- 记录目标窗口句柄和相对坐标
- 支持多目标窗口校准
- 校准数据持久化保存

### 2.9 文本捕获模块 ⭐⭐⭐

**功能描述**: 从Cascade等其他窗口捕获文本内容

**捕获机制**:
```python
def capture_cascade_text(self):
    1. 枚举所有窗口查找Cascade
    2. 获取窗口文本内容
    3. 清理和格式化文本
    4. 自动记录到日志文件
    5. 触发双重备份
```

**支持的窗口类型**:
- Cascade AI助手窗口
- 其他常见的文本编辑器
- 浏览器页面内容（部分支持）

### 2.10 脑图集成模块 ⭐⭐⭐

**功能描述**: 集成JSMind脑图引擎，支持思维导图管理

**双模式设计**:
- **WebEngine模式**: 完整的JSMind功能，支持复杂交互
- **简化模式**: QTextBrowser显示，兼容性更好

**拖拽功能**:
```javascript
// JavaScript拖拽引擎
function enableNodeDragging() {
    1. 绑定mousedown事件开始拖拽
    2. mousemove事件实时更新位置
    3. mouseup事件结束拖拽
    4. 提供视觉反馈和边界检测
    5. 保存节点位置到本地存储
}
```

**Python接口**:
```python
def enable_node_dragging(self):
    """启用脑图节点拖拽功能"""
    
def add_mindmap_node(self, parent_id, node_text):
    """添加脑图节点"""
    
def get_node_position(self, node_id):
    """获取节点位置"""
```

## 3. 数据管理

### 3.1 配置文件结构

**主配置文件**: `config_instance_{实例ID}.json`
```json
{
    "default_scene": "自然模式",
    "default_version": "默认模板", 
    "project_name": "injection",
    "project_folder": "D:/AI-Projects/injection",
    "log_file": "injection-log.md",
    "mouse_position": {"x": 500, "y": 300},
    "window_geometry": {"x": 100, "y": 100, "width": 1200, "height": 700},
    "api_key": "encrypted_key"
}
```

**模板配置文件**: `templates.json`
```json
{
    "自然模式": {
        "默认模板": {
            "prefix": "每次回答或者工作后，生成本次回答或者工作的总结，并自动识别cursor所在的项目，然后将项目名称和总结内容一起，以更新的方式，保存在当前项目的{项目名称}-log.md文档中",
            "suffix": "",
            "variables": {
                "项目名称": "injection"
            }
        }
    }
}
```

### 3.2 日志文件结构

**文件命名**: `{项目名称}-log.md`
**备份命名**: 
- `{项目名称}-log-bak-1.md` (双备份1)
- `{项目名称}-log-bak-2.md` (双备份2)  
- `{项目名称}-log-bak-startup-{时间戳}.md` (启动备份)

**内容结构**: 严格按照"📥输入 + 📤输出"交互块格式

### 3.3 临时文件管理

**项目锁文件**: `.project_lock_{项目名称}`
**监控记录文件**: `.log_write_attempts.json`
**诊断日志文件**: `injection_failure_log_{时间戳}.json`

## 4. 安全机制

### 4.1 数据保护
- ✅ **多重备份**: 双备份 + 启动备份 + 自动监控备份
- ✅ **完整性检查**: 文件大小、内容验证
- ✅ **自动恢复**: 检测到问题时从备份恢复
- ✅ **版本追溯**: 保留多个历史版本

### 4.2 进程安全
- ✅ **实例互斥**: 防止同项目多实例冲突
- ✅ **进程验证**: 验证锁定进程真实状态
- ✅ **优雅退出**: 程序退出时清理资源

### 4.3 操作安全
- ✅ **操作确认**: 重要操作需要用户确认
- ✅ **错误恢复**: 操作失败时自动恢复
- ✅ **日志审计**: 详细记录所有操作

## 5. 性能优化

### 5.1 启动优化
- 延迟加载非关键组件
- 并行初始化独立模块
- 缓存配置文件减少磁盘IO

### 5.2 运行时优化
- 文件监控使用定时器而非实时监控
- 日志写入采用批量操作
- UI更新使用信号槽机制避免阻塞

### 5.3 内存管理
- 及时释放临时对象
- 控制日志文件大小
- 定期清理过期备份文件

## 6. 错误处理

### 6.1 分级错误处理
- **致命错误**: 程序崩溃，生成crash报告
- **严重错误**: 核心功能失效，显示错误对话框
- **一般错误**: 操作失败，显示状态栏提示
- **警告信息**: 潜在问题，显示mini通知

### 6.2 诊断系统
```python
# 故障诊断信息收集
{
    "timestamp": "2025-06-08T12:22:39",
    "operation_type": "INJECTION_ATTEMPT",
    "system_info": {...},
    "window_info": {...},
    "error_details": {...},
    "diagnostic_steps": [...]
}
```

### 6.3 恢复策略
- **配置文件损坏**: 重建默认配置
- **日志文件损坏**: 从备份恢复
- **模板文件损坏**: 重建默认模板
- **锁文件异常**: 清理并重新创建

## 7. 扩展性设计

### 7.1 插件架构预留
- 模块化设计便于扩展新功能
- 统一的事件总线机制
- 标准的插件接口定义

### 7.2 配置系统扩展
- JSON格式便于程序化修改
- 版本兼容性设计
- 配置迁移机制

### 7.3 UI框架扩展
- 响应式布局设计
- 主题切换支持
- 多语言预留

## 8. 部署要求

### 8.1 系统要求
- **操作系统**: Windows 7/8.1/10/11
- **Python版本**: 3.8及以上
- **内存要求**: 最小512MB，推荐1GB
- **磁盘空间**: 最小100MB

### 8.2 依赖组件
```txt
PyQt5>=5.15.0
psutil>=5.8.0
markdown>=3.3.0
win32gui (pywin32)
win32api (pywin32)
win32con (pywin32)
```

### 8.3 安装部署
- 支持源码运行
- 支持PyInstaller打包
- 支持便携版部署
- 配置文件自动生成

## 9. 维护和监控

### 9.1 日志监控
- 程序运行日志
- 错误统计信息
- 性能指标监控

### 9.2 数据维护
- 定期清理过期文件
- 日志文件大小管控
- 配置文件备份

### 9.3 版本更新
- 配置文件兼容性检查
- 数据迁移脚本
- 功能升级向导

## 10. 开发规范

### 10.1 代码规范
- PEP8 Python编码规范
- 函数注释和类型提示
- 统一的错误处理模式

### 10.2 测试要求
- 单元测试覆盖核心功能
- 集成测试验证完整流程
- UI自动化测试

### 10.3 文档维护
- 代码注释实时更新
- 功能文档同步更新
- 用户手册定期修订

---

**系统功能说明书版本**: v1.0
**最后更新**: 2025-01-08
**适用版本**: Injection Tool v2.0+ 