# Injection V2 重新设计方案

## 🎯 设计理念

**推倒重来的原因**：
- 当前V2界面与真实需求差距过大
- 架构设计不匹配用户期望
- 缺失核心功能（脑图、泳道、数据联动）
- 需要重新审视和设计整个系统

**新设计目标**：
- 完全按照用户截图和需求文档设计
- 实现真正的多区域协同工作
- 保留V1的命令注入核心能力
- 构建现代化的工作流管理平台

## 📐 界面架构重设计

### 整体布局

```
┌─────────────────────────────────────────────────────────────────┐
│                          标题栏                                 │
├─────────────┬─────────────────────┬─────────────────────────────┤
│   命令工作区   │      阅读分析区      │        列表和甬道区          │
│             │                    │                           │
│ ┌─────────┐ │ ┌─────────────────┐ │ ┌─────────────────────────┐ │
│ │🔥命令注入│ │ │  节点详情页      │ │ │      任务列表            │ │
│ │🧠脑图   │ │ │  MD阅读器       │ │ │                        │ │
│ └─────────┘ │ └─────────────────┘ │ └─────────────────────────┘ │
│             │                    │                           │
│ 场景列表     │                    │                           │
│ ★自然模式   │                    │                           │
│  编程模式    │                    │                           │
│  写作模式    │                    │                           │
│             │                    │                           │
├─────────────┴─────────────────────┴─────────────────────────────┤
│                    底部泳道区域 (5个泳道)                         │
│ ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐                      │
│ │泳道1│ │泳道2│ │泳道3│ │泳道4│ │泳道5│                      │
│ │     │ │     │ │     │ │     │ │     │                      │
│ └─────┘ └─────┘ └─────┘ └─────┘ └─────┘                      │
└─────────────────────────────────────────────────────────────────┘
```

### 三大工作区域

#### 1. 命令工作区 (左侧 300px)
- **选项卡1: 🔥命令注入**
  - 命令输入框
  - 模板应用
  - 快捷标签插入
  - 注入执行按钮
  
- **选项卡2: 🧠脑图**
  - JSMind思维导图
  - 节点添加/删除/编辑
  - 拖拽关系调整
  - 中心节点设置

- **底部: 场景列表**
  - 模板场景管理
  - 版本选择
  - 默认设置

#### 2. 阅读分析区 (中间 可伸缩)
- **选项卡1: 节点详情页**
  - 显示选中节点的详细信息
  - 与脑图实时联动
  - 支持编辑和更新
  
- **选项卡2: MD阅读器**
  - 实时显示命令注入结果
  - Markdown格式渲染
  - 内容历史记录

#### 3. 列表和甬道区 (右侧 250px)
- **任务列表**
  - 项目任务展示
  - 点击设为脑图中心节点
  - 任务状态跟踪

#### 4. 底部泳道区域 (高度 200px)
- **5个泳道**
  - 支持任务项拖拽
  - 状态流转管理
  - 父子关系调整
  - 与脑图双向同步

## 🔧 核心功能重设计

### 1. 脑图系统 (JSMind集成)

```python
class MindMapManager:
    def __init__(self):
        self.webview = QWebEngineView()
        self.current_center_node = None
        self.node_data = {}
        
    def init_mindmap(self):
        # 加载JSMind引擎
        # 初始化基础脑图结构
        # 绑定JavaScript回调
        
    def add_node(self, parent_id, text, category="default"):
        # 添加新节点到脑图
        
    def set_center_node(self, node_id):
        # 设置中心节点，重新组织脑图视图
        
    def on_node_click(self, node_id):
        # 节点点击事件，触发详情页更新
        # 触发数据联动
```

### 2. 数据联动系统

```python
class DataSyncEngine:
    def __init__(self):
        self.mindmap_manager = None
        self.detail_panel = None
        self.md_reader = None
        self.task_list = None
        self.swimlanes = None
        
    def sync_mindmap_to_detail(self, node_id):
        # 脑图节点选择 → 详情页更新
        node_info = self.mindmap_manager.get_node_info(node_id)
        self.detail_panel.update_content(node_info)
        
    def sync_command_to_reader(self, content):
        # 命令注入 → MD阅读器更新
        formatted_content = self.format_markdown(content)
        self.md_reader.update_content(formatted_content)
        
    def sync_task_to_mindmap(self, task_id):
        # 任务列表选择 → 脑图中心节点
        self.mindmap_manager.set_center_node(task_id)
        
    def sync_swimlane_to_mindmap(self, item_id, lane_index):
        # 泳道拖拽 → 脑图关系更新
        self.mindmap_manager.update_node_relation(item_id, lane_index)
```

### 3. 泳道管理系统

```python
class SwimlaneManager:
    def __init__(self):
        self.lanes = []
        self.drag_manager = DragDropManager()
        
    def create_swimlanes(self):
        # 创建5个泳道
        for i in range(5):
            lane = SwimlaneWidget(f"泳道{i+1}")
            lane.enable_drop()
            self.lanes.append(lane)
            
    def handle_item_drop(self, item, source_lane, target_lane):
        # 处理拖拽操作
        # 更新任务状态
        # 触发脑图同步
        
class SwimlaneWidget(QListWidget):
    def __init__(self, title):
        super().__init__()
        self.title = title
        self.setAcceptDrops(True)
        
    def dragEnterEvent(self, event):
        # 拖拽进入事件
        
    def dropEvent(self, event):
        # 拖拽放置事件
```

### 4. 选项卡管理系统

```python
class TabWorkspaceManager:
    def __init__(self):
        self.command_tabs = None
        self.analysis_tabs = None
        
    def setup_command_workspace(self):
        # 命令工作区选项卡
        self.command_tabs = QTabWidget()
        
        # 命令注入选项卡
        injection_widget = CommandInjectionWidget()
        self.command_tabs.addTab(injection_widget, "🔥命令注入")
        
        # 脑图选项卡
        mindmap_widget = MindMapWidget()
        self.command_tabs.addTab(mindmap_widget, "🧠脑图")
        
    def setup_analysis_workspace(self):
        # 阅读分析区选项卡
        self.analysis_tabs = QTabWidget()
        
        # 节点详情选项卡
        detail_widget = NodeDetailWidget()
        self.analysis_tabs.addTab(detail_widget, "节点详情")
        
        # MD阅读器选项卡
        reader_widget = MarkdownReaderWidget()
        self.analysis_tabs.addTab(reader_widget, "MD阅读器")
```

## 📊 数据模型重设计

### 1. 节点数据模型

```python
@dataclass
class MindMapNode:
    id: str
    text: str
    parent_id: Optional[str]
    children: List[str]
    category: str
    metadata: Dict
    position: Tuple[int, int]
    swimlane_index: Optional[int]
    
class NodeRepository:
    def __init__(self):
        self.nodes = {}
        
    def add_node(self, node: MindMapNode):
        self.nodes[node.id] = node
        
    def get_node(self, node_id: str) -> MindMapNode:
        return self.nodes.get(node_id)
        
    def update_relation(self, child_id: str, new_parent_id: str):
        # 更新父子关系
```

### 2. 任务数据模型

```python
@dataclass
class Task:
    id: str
    title: str
    content: str
    status: str  # swimlane_1, swimlane_2, etc.
    related_node_id: Optional[str]
    created_time: datetime
    updated_time: datetime
    
class TaskRepository:
    def __init__(self):
        self.tasks = {}
        
    def move_task(self, task_id: str, new_status: str):
        # 移动任务到新状态
```

### 3. 配置数据模型

```python
@dataclass
class WorkspaceConfig:
    current_center_node: Optional[str]
    active_tabs: Dict[str, int]  # 各区域当前选中的选项卡
    swimlane_names: List[str]
    layout_sizes: List[int]
    
    # V1兼容配置
    default_scene: str
    default_version: str
    templates: Dict
```

## 🚀 技术实现架构

### 1. 主窗口架构

```python
class InjectionV2MainWindow(QMainWindow):
    def __init__(self):
        super().__init__()
        
        # 核心管理器
        self.data_sync = DataSyncEngine()
        self.mindmap_manager = MindMapManager()
        self.swimlane_manager = SwimlaneManager()
        self.tab_manager = TabWorkspaceManager()
        
        # 数据仓库
        self.node_repo = NodeRepository()
        self.task_repo = TaskRepository()
        
        # V1兼容层
        self.v1_compat = V1CompatibilityLayer()
        
        self.init_ui()
        self.setup_connections()
        
    def init_ui(self):
        # 创建上下分割布局
        main_splitter = QSplitter(Qt.Vertical)
        
        # 上半部分：三区域工作空间
        workspace = self.create_workspace()
        
        # 下半部分：泳道区域
        swimlanes = self.create_swimlanes()
        
        main_splitter.addWidget(workspace)
        main_splitter.addWidget(swimlanes)
        main_splitter.setSizes([600, 200])
        
        self.setCentralWidget(main_splitter)
        
    def create_workspace(self):
        # 创建三区域横向布局
        workspace_splitter = QSplitter(Qt.Horizontal)
        
        # 左侧：命令工作区
        command_area = self.tab_manager.setup_command_workspace()
        
        # 中间：阅读分析区
        analysis_area = self.tab_manager.setup_analysis_workspace()
        
        # 右侧：列表和甬道区
        list_area = self.create_list_area()
        
        workspace_splitter.addWidget(command_area)
        workspace_splitter.addWidget(analysis_area)
        workspace_splitter.addWidget(list_area)
        workspace_splitter.setSizes([300, 600, 250])
        
        return workspace_splitter
```

### 2. JSMind集成方案

```python
class MindMapWidget(QWidget):
    def __init__(self):
        super().__init__()
        
        # 使用QWebEngineView集成JSMind
        self.webview = QWebEngineView()
        
        # 加载JSMind HTML
        self.load_mindmap_engine()
        
        # 建立Python-JavaScript通信
        self.setup_js_bridge()
        
    def load_mindmap_engine(self):
        # 加载包含JSMind的HTML页面
        html_content = self.generate_mindmap_html()
        self.webview.setHtml(html_content)
        
    def setup_js_bridge(self):
        # 设置JavaScript回调
        channel = QWebChannel()
        self.bridge = JSBridge()
        channel.registerObject("pybridge", self.bridge)
        self.webview.page().setWebChannel(channel)
        
        # 连接信号
        self.bridge.node_clicked.connect(self.on_node_clicked)
        self.bridge.node_added.connect(self.on_node_added)
```

### 3. 拖拽系统实现

```python
class DragDropManager:
    def __init__(self):
        self.drag_source = None
        self.drag_data = None
        
    def start_drag(self, source_widget, item_data):
        # 开始拖拽操作
        
    def accept_drop(self, target_widget, item_data):
        # 接受拖拽操作
        # 触发数据同步
```

## 📁 文件结构重组

```
injection-v2/
├── client/
│   ├── ui/
│   │   ├── main_window.py          # 重新设计的主窗口
│   │   ├── widgets/
│   │   │   ├── mindmap_widget.py   # 脑图组件
│   │   │   ├── swimlane_widget.py  # 泳道组件
│   │   │   ├── command_widget.py   # 命令注入组件
│   │   │   ├── detail_widget.py    # 节点详情组件
│   │   │   └── reader_widget.py    # MD阅读器组件
│   │   └── resources/
│   │       └── mindmap.html        # JSMind HTML模板
│   ├── core/
│   │   ├── data_sync.py           # 数据联动引擎
│   │   ├── mindmap_manager.py     # 脑图管理器
│   │   ├── swimlane_manager.py    # 泳道管理器
│   │   └── v1_compat.py          # V1兼容层
│   └── models/
│       ├── node.py               # 节点数据模型
│       ├── task.py               # 任务数据模型
│       └── workspace.py          # 工作空间模型
└── launch_v2_new.py              # 新的启动器
```

## 🎯 实施计划

### 阶段1: 架构重建 (3-4天)
1. 清理现有V2代码
2. 重新设计主窗口布局
3. 实现选项卡工作区
4. 建立基础数据模型

### 阶段2: 脑图集成 (3-4天)
1. 集成JSMind引擎
2. 实现Python-JS通信
3. 基础节点管理功能
4. 脑图与界面数据绑定

### 阶段3: 泳道系统 (2-3天)
1. 实现5个泳道UI
2. 拖拽功能开发
3. 任务状态管理
4. 泳道数据持久化

### 阶段4: 数据联动 (3-4天)
1. 脑图↔详情页联动
2. 命令注入↔阅读器联动
3. 任务列表↔脑图联动
4. 泳道↔脑图联动

### 阶段5: V1兼容 (2-3天)
1. 命令注入功能迁移
2. 模板系统兼容
3. 配置文件迁移
4. 快捷键和托盘

### 阶段6: 测试优化 (2-3天)
1. 功能完整性测试
2. 用户体验优化
3. 性能调优
4. 文档更新

## 🔍 关键设计原则

1. **需求驱动**: 严格按照截图和需求文档设计
2. **模块化**: 每个功能独立开发，便于测试和维护
3. **数据一致性**: 所有区域间数据实时同步
4. **向后兼容**: 保留V1的核心功能和操作习惯
5. **扩展性**: 为后续功能扩展留出接口

---

**重新设计的核心目标**: 构建真正符合用户需求的多区域协同工作平台，实现思维导图、任务管理、命令注入的完美融合。 