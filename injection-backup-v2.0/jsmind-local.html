<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <!-- ç¼“å­˜æ§åˆ¶ -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>jsMind æœ¬åœ°ç‰ˆæ¼”ç¤ºï¼ˆæ”¯æŒæ‹–æ‹½åŠŸèƒ½ï¼‰</title>
    <!-- å¼•å…¥æœ¬åœ°å®‰è£…çš„ jsMind -->
    <link type="text/css" rel="stylesheet" href="./node_modules/jsmind/style/jsmind.css" />
    <script type="text/javascript" src="./node_modules/jsmind/es6/jsmind.js"></script>
    <!-- å¼•å…¥æœ¬åœ°æ‹–æ‹½åŠŸèƒ½æ’ä»¶ -->
    <script type="text/javascript" src="./node_modules/jsmind/es6/jsmind.draggable-node.js"></script>
    <!-- å¼•å…¥æˆªå›¾å¯¼å‡ºåŠŸèƒ½ä¾èµ– -->
    <script src="https://unpkg.com/dom-to-image@2.6.0/dist/dom-to-image.min.js"></script>
    <script type="text/javascript" src="./node_modules/jsmind/es6/jsmind.screenshot.js"></script>
    <!-- QWebChannel for PyQt communication -->
    <script src="qrc:///qtwebchannel/qwebchannel.js"></script>
    
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.15);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 5px;
            text-align: center;
            min-height: 20px;
        }
        
        .header h1 {
            margin: 0 0 10px 0;
            font-size: 28px;
            font-weight: 600;
        }
        
        .header .subtitle {
            font-size: 16px;
            opacity: 0.9;
            margin: 0 0 15px 0;
        }
        
        .feature-highlight {
            background: rgba(255,255,255,0.1);
            padding: 12px 18px;
            border-radius: 8px;
            margin-top: 15px;
            font-size: 14px;
            font-weight: 500;
        }
        
        .toolbar {
            background: #f8f9fa;
            padding: 20px;
            text-align: center;
            border-bottom: 2px solid #dee2e6;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
        }
        
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 18px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .btn:hover {
            background: #0056b3;
            transform: translateY(-1px);
        }
        
        .btn-success { background: #28a745; }
        .btn-success:hover { background: #1e7e34; }
        
        .btn-danger { background: #dc3545; }
        .btn-danger:hover { background: #c82333; }
        
        .btn-warning { background: #ffc107; color: #212529; }
        .btn-warning:hover { background: #e0a800; }
        
        .btn-secondary { background: #6c757d; }
        .btn-secondary:hover { background: #545b62; }
        
        .btn-info { background: #17a2b8; }
        .btn-info:hover { background: #138496; }
        
        #jsmind_container {
            height: calc(100vh - 200px);
            background: #f8f9fa;
            border-radius: 8px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.1);
        }
        
        .main-layout {
            display: flex;
            height: calc(100vh - 200px);
            gap: 20px;
            margin: 20px;
        }
        
        .mindmap-container {
            flex: 1;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #dee2e6;
            box-shadow: 0 2px 12px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .mindmap-container.fullwidth {
            width: 100%;
        }
        
        .placeholder-content {
            text-align: center;
            color: #6c757d;
            padding: 40px 20px;
            border: 2px dashed #dee2e6;
            border-radius: 6px;
            background: #f8f9fa;
            margin-bottom: 20px;
        }
        
        .placeholder-content .icon {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.5;
        }
        
        .placeholder-content .title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .placeholder-content .subtitle {
            font-size: 14px;
            opacity: 0.7;
        }
        
        .main-content {
            margin: 20px 0;
        }
        
        .node-info-panel {
            background: #f8f9fa;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            height: fit-content;
            max-height: 650px;
            overflow-y: auto;
        }
        
        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            border-bottom: 1px solid #dee2e6;
            background: #e9ecef;
            border-radius: 8px 8px 0 0;
        }
        
        .panel-header h3 {
            margin: 0;
            font-size: 16px;
            color: #495057;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 20px;
            color: #6c757d;
            cursor: pointer;
        }
        
        .close-btn:hover {
            color: #343a40;
        }
        
        .panel-content {
            padding: 10px 0;
        }
        
        /* èŠ‚ç‚¹è¯¦æƒ…é¢æ¿åœ¨æ“ä½œæŒ‡å—åŒºåŸŸå†…çš„æ ·å¼ */
        .help-item.node-details .panel-content {
            max-height: 400px;
            overflow-y: auto;
            padding: 10px 0;
        }
        
        .help-item.node-details .node-detail-form {
            margin-top: 10px;
        }
        
        .placeholder {
            color: #586069;
            font-style: italic;
            text-align: center;
            padding: 15px 0;
        }
        
        .node-info-item {
            margin-bottom: 12px;
        }
        
        .node-info-item label {
            display: block;
            font-weight: 600;
            font-size: 13px;
            color: #495057;
            margin-bottom: 4px;
        }
        
        .node-info-item .value {
            font-size: 14px;
            word-break: break-word;
        }
        
        .node-info-item .tag-list {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }
        
        .node-info-item .tag {
            background: #e9ecef;
            color: #495057;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 12px;
        }
        
        .node-path {
            font-size: 12px;
            color: #6c757d;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px dashed #dee2e6;
        }
        
        .node-path span {
            color: #007bff;
        }
        
        /* è¡¨å•æ ·å¼ */
        .node-detail-form {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .form-input, .form-textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            font-size: 14px;
            color: #495057;
            transition: border-color 0.2s ease;
        }
        
        .form-input:focus, .form-textarea:focus {
            border-color: #80bdff;
            outline: 0;
            box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
        }
        
        .form-textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        .form-actions {
            display: flex;
            justify-content: flex-start;
            gap: 10px;
            margin-top: 15px;
        }
        
        .form-btn {
            padding: 8px 16px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            background: #f8f9fa;
            color: #495057;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .form-btn:hover {
            background: #e9ecef;
        }
        
        .form-btn-primary {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }
        
        .form-btn-primary:hover {
            background: #0069d9;
            border-color: #0062cc;
        }
        
        /* æ ‡ç­¾æ ·å¼ */
        .tags-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .tags-list {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }
        
        .tag {
            background: #e9ecef;
            color: #495057;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 12px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        .tag a {
            color: #6c757d;
            text-decoration: none;
            font-weight: bold;
        }
        
        .tag a:hover {
            color: #dc3545;
        }
        
        .tag-input {
            padding: 5px 10px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            font-size: 12px;
            width: 100%;
        }
        
        .relation-info, .time-info {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            font-size: 13px;
            line-height: 1.5;
        }
        
        .drag-hint {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 15px;
            margin: 20px;
            border-radius: 8px;
            text-align: center;
            font-weight: 500;
        }
        
        .drag-hint strong {
            color: #d63384;
        }
        
        .status {
            background: linear-gradient(135deg, #343a40 0%, #495057 100%);
            color: white;
            padding: 12px 20px;
            font-size: 13px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #28a745;
        }
        
        .help {
            padding: 25px;
            background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
        }
        
        .help h3 {
            margin: 0 0 20px 0;
            color: #1565c0;
            font-size: 18px;
            font-weight: 600;
        }
        
        .help-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }
        
        .help-item {
            background: rgba(255,255,255,0.9);
            padding: 18px;
            border-radius: 8px;
            border-left: 4px solid;
        }
        
        .help-item.mouse { border-left-color: #007bff; }
        .help-item.keyboard { border-left-color: #28a745; }
        .help-item.drag { border-left-color: #fd7e14; }
        .help-item.features { border-left-color: #6f42c1; }
        
        .help-item h4 {
            margin: 0 0 12px 0;
            color: #2c3e50;
            font-size: 15px;
            font-weight: 600;
        }
        
        .help-item ul {
            margin: 0;
            padding-left: 20px;
            font-size: 13px;
            line-height: 1.6;
        }
        
        .help-item li {
            margin: 6px 0;
        }
        
        @media (max-width: 768px) {
            .toolbar {
                padding: 15px;
                gap: 8px;
            }
            
            .btn {
                padding: 8px 14px;
                font-size: 13px;
            }
            
            .main-layout {
                flex-direction: column;
                height: auto;
                gap: 15px;
                margin: 15px;
            }
            

            
            .mindmap-container {
                order: 1;
                height: 400px;
            }
            
            #jsmind_container {
                height: 400px;
            }
        }
        
        /* è„‘å›¾é€‰é¡¹å¡æ ·å¼ */
        .mindmap-tab-container {
            height: 100%;
            display: flex;
            flex-direction: column;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .mindmap-tab-header {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            flex-shrink: 0;
        }
        
        .mindmap-tab-button {
            flex: 1;
            padding: 12px 15px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #6c757d;
            transition: all 0.3s ease;
            position: relative;
            border-right: 1px solid #dee2e6;
        }
        
        .mindmap-tab-button:last-child {
            border-right: none;
        }
        
        .mindmap-tab-button:hover {
            background: #e9ecef;
            color: #495057;
        }
        
        .mindmap-tab-button.active {
            background: white;
            color: #007bff;
            font-weight: 600;
        }
        
        .mindmap-tab-button.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: #007bff;
        }
        
        .mindmap-tab-content {
            display: none;
            flex: 1;
            position: relative;
            overflow: hidden;
        }
        
        .mindmap-tab-content.active {
            display: block;
        }
        
        .jsmind-tab-canvas {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
        }
        
        /* å³é”®èœå•æ ·å¼ */
        .context-menu {
            position: fixed;
            background: white;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            padding: 5px 0;
            z-index: 10000;
            display: none;
        }
        
        .context-menu-item {
            padding: 8px 16px;
            cursor: pointer;
            font-size: 14px;
            color: #333;
            white-space: nowrap;
        }
        
        .context-menu-item:hover {
            background: #f0f0f0;
        }
        
        .context-menu-divider {
            height: 1px;
            background: #eee;
            margin: 5px 0;
        }
        
        /* è¯¦æƒ…é¡µç®€åŒ–æ ·å¼ */
        
        .tab-pane h4 {
            margin: 0 0 15px 0;
            color: #495057;
            font-size: 16px;
            font-weight: 600;
        }
        
        .info-row {
            display: flex;
            margin-bottom: 12px;
            align-items: flex-start;
        }
        
        .info-label {
            min-width: 80px;
            font-weight: 600;
            color: #6c757d;
            font-size: 13px;
            margin-right: 10px;
            flex-shrink: 0;
        }
        
        .info-value {
            flex: 1;
            font-size: 14px;
            color: #495057;
            word-break: break-word;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-label {
            display: block;
            font-weight: 600;
            color: #495057;
            font-size: 13px;
            margin-bottom: 6px;
        }
        
        .form-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }
        
        .form-textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
            min-height: 320px;
            resize: vertical;
            box-sizing: border-box;
        }
        
        .detail-header {
            position: relative;
            margin-bottom: 15px;
        }
        
        .author-input-small {
            position: absolute;
            top: 0;
            right: 0;
            width: 150px;
            padding: 4px 8px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 12px;
            background: #f8f9fa;
        }
        
        .tag-input-group {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
        }
        
        .tag-input {
            flex: 1;
            padding: 6px 10px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 13px;
        }
        
        .tag-select {
            flex: 1;
            padding: 6px 10px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 13px;
            background: white;
            margin-right: 8px;
        }
        
        .tag-add-btn {
            padding: 6px 12px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
        }
        
        .tag-list {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 8px;
        }
        
        .tag-item {
            background: #e9ecef;
            color: #495057;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .tag-remove {
            background: none;
            border: none;
            color: #6c757d;
            cursor: pointer;
            font-size: 14px;
            padding: 0;
            margin-left: 4px;
        }
        
        .form-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #dee2e6;
        }
        
        .btn-primary {
            padding: 8px 16px;
            background: #007bff;
            color: white;
            border: 1px solid #007bff;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .btn-secondary {
            padding: 8px 16px;
            background: #6c757d;
            color: white;
            border: 1px solid #6c757d;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .history-item {
            padding: 12px;
            border-left: 3px solid #007bff;
            background: #f8f9fa;
            margin-bottom: 10px;
            border-radius: 0 4px 4px 0;
        }
        
        .history-time {
            font-size: 12px;
            color: #6c757d;
            margin-bottom: 4px;
        }
        
        .history-action {
            font-weight: 600;
            color: #495057;
            margin-bottom: 2px;
        }
        
        .history-detail {
            font-size: 13px;
            color: #6c757d;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #6c757d;
        }
        
        .empty-state .icon {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.5;
        }
        
        .path-breadcrumb {
            background: #f8f9fa;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            color: #6c757d;
            margin-bottom: 15px;
        }
        
        .path-breadcrumb .path-separator {
            margin: 0 8px;
            color: #adb5bd;
        }
        
        .path-breadcrumb .path-node {
            color: #007bff;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <!-- ä¿ç•™åŒºåŸŸå¤‡ç”¨ -->
        </div>
        
        <div class="toolbar">
            <!-- éšè—çš„æ–‡ä»¶è¾“å…¥å…ƒç´  -->
            <input type="file" id="import_file_input" accept=".json,.jm,.mm" style="display: none;" onchange="handleFileImport(this)">
            
            <button class="btn btn-primary" onclick="showUserGuide()" style="background: #007bff; border: 2px solid #0056b3; font-size: 16px; font-weight: 600; padding: 12px 24px; box-shadow: 0 4px 12px rgba(0,123,255,0.3); transition: all 0.3s ease;">
                ğŸ“š ä½¿ç”¨æŒ‡å—
            </button>
            <button class="btn btn-info" onclick="exportToCustomFile()">
                ğŸ“ è‡ªå®šä¹‰å­˜å‚¨
            </button>
            <button class="btn btn-primary" onclick="createNewContent()">
                âœ¨ æ–°å†…å®¹
            </button>
            <button class="btn btn-success" onclick="triggerImport()">
                ğŸ“‚ å¯¼å…¥æ–‡ä»¶
            </button>
            <button class="btn btn-danger" onclick="clearSavedData()">
                ğŸ—‘ï¸ æ¸…é™¤å­˜å‚¨
            </button>
            <button class="btn btn-success" onclick="syncCurrentNodeTags()" title="åŒæ­¥æ ‡ç­¾ç®¡ç†è„‘å›¾çš„æ ‡ç­¾åˆ°å½“å‰é€‰ä¸­èŠ‚ç‚¹">
                ğŸ”„ æ ‡ç­¾åŒæ­¥
            </button>
            <button class="btn btn-warning" onclick="debugTagSync()" title="è°ƒè¯•æ ‡ç­¾åŒæ­¥åŠŸèƒ½">
                ğŸ”§ è°ƒè¯•æ ‡ç­¾
            </button>

        </div>
        

        
        <div class="main-layout">
            <div class="mindmap-container fullwidth">
                <div class="mindmap-tab-container">
                    <div class="mindmap-tab-header">
                        <button class="mindmap-tab-button" onclick="switchMindmapTab('workspace')">
                            ğŸ”¬ ä¸´æ—¶å·¥ä½œåŒºA
                        </button>
                        <button class="mindmap-tab-button" onclick="switchMindmapTab('knowledge')">
                            ğŸ·ï¸ æ ‡ç­¾ç®¡ç†
                        </button>
                        <button class="mindmap-tab-button active" onclick="switchMindmapTab('project')">
                            ğŸš€ é¡¹ç›®ç®¡ç†
                        </button>
                    </div>
                    
                    <!-- ä¸´æ—¶å·¥ä½œåŒºAé€‰é¡¹å¡ -->
                    <div id="mindmap-tab-workspace" class="mindmap-tab-content">
                        <div id="jsmind_container_workspace" class="jsmind-tab-canvas"></div>
                    </div>
                    
                    <!-- æ ‡ç­¾ç®¡ç†é€‰é¡¹å¡ -->
                    <div id="mindmap-tab-knowledge" class="mindmap-tab-content">
                        <div id="jsmind_container_knowledge" class="jsmind-tab-canvas"></div>
                    </div>
                    
                    <!-- é¡¹ç›®ç®¡ç†è„‘å›¾é€‰é¡¹å¡ï¼ˆä¸»æ˜¾ç¤ºåŒºï¼‰ -->
                    <div id="mindmap-tab-project" class="mindmap-tab-content active">
                        <div id="jsmind_container_project" class="jsmind-tab-canvas"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="status">
            <div class="status-item">
                <div class="status-indicator"></div>
                <span>jsMind æœ¬åœ°ç‰ˆæœ¬å·²åŠ è½½</span>
            </div>
            <div class="status-item">
                å½“å‰ä¸»é¢˜: <span id="currentTheme">primary</span>
            </div>
            <div class="status-item">
                é€‰ä¸­èŠ‚ç‚¹: <span id="selectedNode">æ— </span>
            </div>
            <div class="status-item">
                æ‹–æ‹½çŠ¶æ€: <span id="dragEnabled">å·²å¯ç”¨</span>
            </div>
        </div>
        
        <div class="help">
            <h3>ğŸ“– å®Œæ•´æ“ä½œæŒ‡å—</h3>
            <div class="help-grid">
                <div class="help-item mouse">
                    <h4>ğŸ‘›ï¸ é¼ æ ‡æ“ä½œ</h4>
                    <ul>
                        <li>å•å‡»èŠ‚ç‚¹é€‰ä¸­</li>
                        <li>åŒå‡»èŠ‚ç‚¹ç¼–è¾‘å†…å®¹</li>
                        <li>æ‹–æ‹½ç”»å¸ƒç§»åŠ¨è§†å›¾</li>
                        <li>æ»šè½®ç¼©æ”¾æ€ç»´å¯¼å›¾</li>
                        <li><strong>æ‹–æ‹½èŠ‚ç‚¹é‡æ–°ç»„ç»‡ç»“æ„</strong></li>
                    </ul>
                </div>
                <div class="help-item keyboard">
                    <h4>âŒ¨ï¸ å¿«æ·é”®</h4>
                    <ul>
                        <li>Ctrl+Enter - æ·»åŠ å­èŠ‚ç‚¹</li>
                        <li>Enter - æ·»åŠ å…„å¼ŸèŠ‚ç‚¹</li>
                        <li>F2 - ç¼–è¾‘èŠ‚ç‚¹</li>
                        <li>Delete - åˆ é™¤èŠ‚ç‚¹</li>
                        <li>Space - å±•å¼€/æ”¶èµ·èŠ‚ç‚¹</li>
                        <li>æ–¹å‘é”® - é€‰æ‹©ç›¸é‚»èŠ‚ç‚¹</li>
                        <li><strong>Ctrl+S - å¯¼å‡ºå®Œæ•´JSONæ–‡ä»¶</strong></li>
                        <li><strong>Ctrl+E - è‡ªå®šä¹‰æ–‡ä»¶åå¯¼å‡º</strong></li>
                        <li><strong>Ctrl+Q - å¿«é€Ÿå¯¼å‡º</strong></li>
                        <li><strong>Ctrl+O - å¯¼å…¥æ–‡ä»¶</strong></li>
                    </ul>
                </div>
                <div class="help-item drag">
                    <h4>ğŸ”€ æ‹–æ‹½åŠŸèƒ½è¯¦è§£</h4>
                    <ul>
                        <li>æŒ‰ä½é¼ æ ‡å·¦é”®å¼€å§‹æ‹–æ‹½</li>
                        <li>æ‹–æ‹½åˆ°ç›®æ ‡èŠ‚ç‚¹ä¸Šæ–¹</li>
                        <li>é‡Šæ”¾é¼ æ ‡å®Œæˆç§»åŠ¨</li>
                        <li>æ”¯æŒè·¨åˆ†æ”¯æ‹–æ‹½ç§»åŠ¨</li>
                        <li>å¯å¼€å¯/å…³é—­æ‹–æ‹½åŠŸèƒ½</li>
                        <li>è‡ªåŠ¨é‡æ–°æ’åˆ—å¸ƒå±€</li>
                    </ul>
                </div>
                <div class="help-item features">
                    <h4>ğŸ¨ é«˜çº§åŠŸèƒ½</h4>
                    <ul>
                        <li>15ç§å†…ç½®ä¸»é¢˜</li>
                        <li>è‡ªå®šä¹‰èŠ‚ç‚¹æ ·å¼</li>
                        <li><strong>æœ¬åœ°æ–‡ä»¶å¯¼å‡º (Ctrl+S/E/Q)</strong></li>
                        <li><strong>æœ¬åœ°æ–‡ä»¶å¯¼å…¥ (Ctrl+O)</strong></li>
                        <li><strong>è‡ªåŠ¨æŒä¹…åŒ–å­˜å‚¨</strong></li>
                        <li>è‡ªå®šä¹‰æ–‡ä»¶åæ”¯æŒ</li>
                        <li>èŠ‚ç‚¹è¯¦ç»†ä¿¡æ¯å¯¼å‡º</li>
                        <li>å¤šæ ¼å¼æ–‡ä»¶å¯¼å…¥ (JSON/JM/MM)</li>
                        <li>é¡µé¢å…³é—­æ•°æ®ä¿æŠ¤</li>
                        <li>ç§»åŠ¨ç«¯æ”¯æŒ</li>
                        <li>å¿«æ·é”®æ“ä½œ</li>
                        <li>å®æ—¶çŠ¶æ€åé¦ˆ</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- å³é”®èœå• -->
    <div id="contextMenu" class="context-menu">
        <div class="context-menu-item" onclick="focusNodeToWorkspaces()">
            ğŸ”¬ å•ç‹¬æ˜¾ç¤ºåˆ°ä¸´æ—¶å·¥ä½œåŒº
        </div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-item" onclick="hideContextMenu()">
            âŒ å–æ¶ˆ
        </div>
    </div>

    <script type="text/javascript">
        // WebChannelé€šä¿¡åˆå§‹åŒ–
        function initWebChannel() {
            console.log('ğŸ”§ å¼€å§‹åˆå§‹åŒ–WebChannelé€šä¿¡...');
            console.log('å½“å‰ç¯å¢ƒæ£€æŸ¥:', {
                'QWebChannelå¯ç”¨': typeof QWebChannel !== 'undefined',
                'qtå¯¹è±¡å¯ç”¨': typeof qt !== 'undefined',
                'webChannelTransportå¯ç”¨': typeof qt !== 'undefined' && typeof qt.webChannelTransport !== 'undefined'
            });
            
            // æ£€æŸ¥QWebChannelæ˜¯å¦å¯ç”¨
            if (typeof QWebChannel !== 'undefined' && typeof qt !== 'undefined' && qt.webChannelTransport) {
                console.log('âœ… QWebChannelç¯å¢ƒå®Œæ•´ï¼Œå¼€å§‹è¿æ¥...');
                try {
                    new QWebChannel(qt.webChannelTransport, function(channel) {
                        console.log('ğŸ“¡ WebChannelè¿æ¥å›è°ƒè§¦å‘');
                        console.log('å¯ç”¨å¯¹è±¡:', Object.keys(channel.objects));
                        
                        // è·å–PyQt bridgeå¯¹è±¡
                        if (channel.objects.pyqt_bridge) {
                            window.pyqt_bridge = channel.objects.pyqt_bridge;
                            console.log('âœ… QWebChannel bridgeè¿æ¥æˆåŠŸ');
                            
                            // æµ‹è¯•é€šä¿¡
                            if (typeof window.pyqt_bridge.updateNodeDetails === 'function') {
                                console.log('âœ… PyQt bridgeå¯¹è±¡å¯ç”¨ï¼Œé€šä¿¡å·²å»ºç«‹');
                                
                                // å‘é€æµ‹è¯•æ¶ˆæ¯
                                window.pyqt_bridge.updateNodeDetails(JSON.stringify({
                                    test: true,
                                    message: 'WebChannelè¿æ¥æµ‹è¯•',
                                    timestamp: new Date().toISOString()
                                }));
                                console.log('ğŸ“¤ å·²å‘é€æµ‹è¯•æ¶ˆæ¯');
                            } else {
                                console.log('âŒ PyQt bridgeå¯¹è±¡çš„updateNodeDetailsæ–¹æ³•ä¸å¯ç”¨');
                            }
                        } else {
                            console.log('âŒ æœªæ‰¾åˆ°pyqt_bridgeå¯¹è±¡');
                        }
                    });
                } catch (error) {
                    console.error('âŒ WebChannelåˆå§‹åŒ–å¤±è´¥:', error);
                }
            } else {
                console.log('âš ï¸ QWebChannelç¯å¢ƒä¸å®Œæ•´ï¼Œä½¿ç”¨å¤‡ç”¨é€šä¿¡æ–¹å¼');
            }
        }
        
        // å¤šç§åˆå§‹åŒ–æ—¶æœº
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸ“„ DOMåŠ è½½å®Œæˆï¼Œå»¶è¿Ÿåˆå§‹åŒ–WebChannel...');
            setTimeout(initWebChannel, 500);
        });
        
        window.addEventListener('load', function() {
            console.log('ğŸŒ é¡µé¢å®Œå…¨åŠ è½½ï¼Œå†æ¬¡å°è¯•åˆå§‹åŒ–WebChannel...');
            setTimeout(initWebChannel, 1000);
        });
        
        // æ€ç»´å¯¼å›¾æ•°æ®
        var mindData = {
            meta: {
                name: "jsMindæœ¬åœ°æ‹–æ‹½æ¼”ç¤º",
                author: "NodeMind Demo",
                version: "1.0.0"
            },
            format: "node_tree",
            data: {
                id: "root",
                topic: "ğŸ§  jsMind æœ¬åœ°æ‹–æ‹½æ¼”ç¤º",
                children: [
                    {
                        id: "features",
                        topic: "ğŸš€ æ ¸å¿ƒç‰¹æ€§",
                        direction: "right",
                        children: [
                            { id: "feature1", topic: "çº¯JavaScriptå®ç°" },
                            { id: "feature2", topic: "HTML5 Canvasæ¸²æŸ“" },
                            { id: "feature3", topic: "èŠ‚ç‚¹æ‹–æ‹½åŠŸèƒ½" },
                            { id: "feature4", topic: "æœ¬åœ°åº“æ–‡ä»¶æ”¯æŒ" }
                        ]
                    },
                    {
                        id: "drag_features",
                        topic: "ğŸ”€ æ‹–æ‹½ç‰¹æ€§",
                        direction: "right",
                        children: [
                            { id: "drag1", topic: "æ‹–æ‹½èŠ‚ç‚¹ç§»åŠ¨" },
                            { id: "drag2", topic: "è·¨åˆ†æ”¯é‡ç»„" },
                            { id: "drag3", topic: "å®æ—¶è§†è§‰åé¦ˆ" },
                            { id: "drag4", topic: "è‡ªåŠ¨å¸ƒå±€è°ƒæ•´" }
                        ]
                    },
                    {
                        id: "applications",
                        topic: "ğŸ“‹ åº”ç”¨åœºæ™¯",
                        direction: "right",
                        children: [
                            { id: "app1", topic: "çŸ¥è¯†ç®¡ç†" },
                            { id: "app2", topic: "é¡¹ç›®è§„åˆ’" },
                            { id: "app3", topic: "å­¦ä¹ ç¬”è®°" },
                            { id: "app4", topic: "å›¢é˜Ÿåä½œ" }
                        ]
                    },
                    {
                        id: "advantages",
                        topic: "â­ æŠ€æœ¯ä¼˜åŠ¿",
                        direction: "right",
                        children: [
                            { id: "adv1", topic: "ç¦»çº¿ä½¿ç”¨" },
                            { id: "adv2", topic: "é«˜æ€§èƒ½æ¸²æŸ“" },
                            { id: "adv3", topic: "æ˜“äºé›†æˆ" },
                            { id: "adv4", topic: "å¼€æºå…è´¹" }
                        ]
                    }
                ]
            }
        };

        // ä¸‰ä¸ªè„‘å›¾å®ä¾‹
        var mindmaps = {
            workspace: null,
            knowledge: null,
            project: null
        };
        
        // å½“å‰æ´»è·ƒçš„è„‘å›¾ï¼ˆé¡¹ç›®ç®¡ç†ä¸ºä¸»æ˜¾ç¤ºåŒºï¼‰
        var currentMindmap = 'project';
        
        // è·å–å½“å‰æ´»è·ƒçš„jsMindå®ä¾‹
        function getCurrentJsMind() {
            return mindmaps[currentMindmap];
        }
        
        // å½“å‰å³é”®é€‰ä¸­çš„èŠ‚ç‚¹
        var contextMenuTargetNode = null;
        
        // ä¸‰ä¸ªè„‘å›¾çš„åˆå§‹æ•°æ®
        var mindmapData = {
            workspace: {
                meta: {
                    name: "ä¸´æ—¶å·¥ä½œåŒºA",
                    author: "NodeMind",
                    version: "1.0.0"
                },
                format: "node_tree",
                data: {
                    id: "workspace_root",
                    topic: "ğŸ”¬ ä¸´æ—¶å·¥ä½œåŒºA",
                    children: []
                }
            },
            knowledge: {
                meta: {
                    name: "æ ‡ç­¾ç®¡ç†",
                    author: "NodeMind",
                    version: "1.0.0"
                },
                format: "node_tree",
                data: {
                    id: "tags_root",
                    topic: "ğŸ·ï¸ æ ‡ç­¾ç®¡ç†ä¸­å¿ƒ",
                    children: [
                        {
                            id: "category_tags",
                            topic: "ğŸ“‚ åˆ†ç±»æ ‡ç­¾",
                            direction: "right",
                            children: []
                        },
                        {
                            id: "technical_tags", 
                            topic: "âš™ï¸ æŠ€æœ¯æ ‡ç­¾",
                            direction: "right",
                            children: []
                        },
                        {
                            id: "status_tags",
                            topic: "ğŸ“Š çŠ¶æ€æ ‡ç­¾", 
                            direction: "left",
                            children: []
                        },
                        {
                            id: "custom_tags",
                            topic: "ğŸ¨ è‡ªå®šä¹‰æ ‡ç­¾",
                            direction: "left", 
                    children: []
                        }
                    ]
                }
            },
            project: {
                meta: {
                    name: "é¡¹ç›®ç®¡ç†",
                    author: "NodeMind",
                    version: "1.0.0"
                },
                format: "node_tree",
                data: {
                    id: "project_root",
                    topic: "ğŸš€ é¡¹ç›®ç®¡ç†",
                    children: [
                        { id: "pj_1", topic: "éœ€æ±‚åˆ†æ", direction: "right" },
                        { id: "pj_2", topic: "è®¾è®¡é˜¶æ®µ", direction: "right" },
                        { id: "pj_3", topic: "å¼€å‘å®æ–½", direction: "left" },
                        { id: "pj_4", topic: "æµ‹è¯•éƒ¨ç½²", direction: "left" }
                    ]
                }
            }
        };
        
        // é…ç½®é€‰é¡¹ï¼Œå¯ç”¨æ‹–æ‹½åŠŸèƒ½
        var baseOptions = {
            editable: true,
            theme: 'primary',
            view: {
                engine: 'canvas',
                hmargin: 120,
                vmargin: 60,
                line_width: 2,
                line_color: '#566',
                // ğŸ”¥ ã€æ–°å¢ã€‘è‡ªå®šä¹‰èŠ‚ç‚¹æ¸²æŸ“ - éšè—ç³»ç»Ÿæ ¹èŠ‚ç‚¹
                custom_node_render: function(jm, element, node) {
                    // å¦‚æœæ˜¯æ ¹èŠ‚ç‚¹ï¼Œç›´æ¥éšè—
                    if (node.isroot) {
                        element.style.display = 'none';
                        console.log('ğŸ¯ å®˜æ–¹æœºåˆ¶éšè—æ ¹èŠ‚ç‚¹:', node.topic);
                        return true; // å·²å¤„ç†è¯¥èŠ‚ç‚¹æ¸²æŸ“
                    }
                    return false; // ä½¿ç”¨é»˜è®¤æ¸²æŸ“
                }
            },
            layout: {
                hspace: 30,
                vspace: 20,
                pspace: 13
            },
            shortcut: {
                enable: true,
                handles: {},
                mapping: {
                    addchild: 4096 + 13,  // Ctrl+Enter æ·»åŠ å­èŠ‚ç‚¹
                    addbrother: 13,  // Enter
                    editnode: 113,   // F2
                    delnode: 46,     // Delete
                    toggle: 32,      // Space
                    left: 37, up: 38, right: 39, down: 40
                }
            }
        };

        // åˆå§‹åŒ–èŠ‚ç‚¹æ•°æ®åº“
        var nodeDatabase = {};
        
        // æ ‡ç­¾ç®¡ç†æ•°æ®åº“ - ç‹¬ç«‹å­˜å‚¨æ ‡ç­¾ä¿¡æ¯
        var tagDatabase = {
            categories: [],      // åˆ†ç±»æ ‡ç­¾
            technical: [],       // æŠ€æœ¯æ ‡ç­¾  
            status: [],          // çŠ¶æ€æ ‡ç­¾
            custom: []           // è‡ªå®šä¹‰æ ‡ç­¾
        };
        
        // é€’å½’éå†æ€ç»´å¯¼å›¾æ•°æ®ï¼Œåˆå§‹åŒ–èŠ‚ç‚¹æ•°æ®åº“
        function initNodeDatabase() {
            // ä¸ºæ‰€æœ‰å·¥ä½œåŒºåˆå§‹åŒ–èŠ‚ç‚¹æ•°æ®åº“
            Object.keys(mindmaps).forEach(function(tabName) {
                var mindmap = mindmaps[tabName];
                if (mindmap) {
                    var data = mindmap.get_data();
                    if (data && data.data) {
                        var rootNode = mindmap.get_node(data.data.id);
                        if (rootNode) {
                            traverseNode(rootNode);
                        }
                    }
                }
            });
            console.log('æ‰€æœ‰å·¥ä½œåŒºèŠ‚ç‚¹æ•°æ®åº“åˆå§‹åŒ–å®Œæˆ:', nodeDatabase);
        }
        
        // éå†èŠ‚ç‚¹åŠå…¶å­èŠ‚ç‚¹
        function traverseNode(node) {
            if (!node) return;
            
            // åˆ›å»ºèŠ‚ç‚¹è¯¦ç»†ä¿¡æ¯
            nodeDatabase[node.id] = {
                id: node.id,
                title: node.topic,
                content: '',
                relations: {
                    parent: node.parent ? node.parent.id : null,
                    children: node.children ? node.children.map(child => child.id) : []
                },
                tags: {
                    categories: [],
                    technical: [],
                    status: [],
                    custom: []
                },
                time: {
                    created: new Date().toLocaleString(),
                    modified: new Date().toLocaleString()
                },
                author: ''
            };
            
            // é€’å½’éå†å­èŠ‚ç‚¹
            if (node.children) {
                node.children.forEach(child => traverseNode(child));
            }
        }
        
        // åˆ›å»ºä¸‰ä¸ªjsMindå®ä¾‹
        function initMindmaps() {
            // åˆ›å»ºå·¥ä½œç©ºé—´è„‘å›¾
            mindmaps.workspace = new jsMind({
                ...baseOptions,
                container: 'jsmind_container_workspace'
            });
            mindmaps.workspace.show(mindmapData.workspace);
            
            // åˆ›å»ºçŸ¥è¯†åº“è„‘å›¾
            mindmaps.knowledge = new jsMind({
                ...baseOptions,
                container: 'jsmind_container_knowledge'
            });
            mindmaps.knowledge.show(mindmapData.knowledge);
            
            // åˆ›å»ºé¡¹ç›®ç®¡ç†è„‘å›¾
            mindmaps.project = new jsMind({
                ...baseOptions,
                container: 'jsmind_container_project'
            });
            mindmaps.project.show(mindmapData.project);
            
            // å¯ç”¨æ‹–æ‹½åŠŸèƒ½ - ä¸ºæ‰€æœ‰å®ä¾‹
            Object.values(mindmaps).forEach((mindmap, index) => {
                try {
                    if (typeof mindmap.enable_draggable_node === 'function') {
                        mindmap.enable_draggable_node();
                        console.log(`âœ… è„‘å›¾${index + 1}æ‹–æ‹½åŠŸèƒ½å·²å¯ç”¨`);
                    } else {
                        console.log(`âš ï¸ è„‘å›¾${index + 1}æ‹–æ‹½åŠŸèƒ½ä¸æ”¯æŒï¼ˆjsMindç‰ˆæœ¬é—®é¢˜ï¼‰`);
                    }
                } catch (dragError) {
                    console.log(`âš ï¸ è„‘å›¾${index + 1}æ‹–æ‹½åŠŸèƒ½å¯ç”¨å¤±è´¥:`, dragError.message);
                }
            });
        }
        
        // åˆå§‹åŒ–æ‰€æœ‰è„‘å›¾
        initMindmaps();
        
        // è·å–å½“å‰æ´»è·ƒçš„jsMindå®ä¾‹ï¼ˆå…¼å®¹åŸæœ‰ä»£ç ï¼‰
        var jm = getCurrentJsMind();
        
        // åˆå§‹åŒ–èŠ‚ç‚¹æ•°æ®åº“
        initNodeDatabase();
        
        // åˆå§‹åŒ–æ ‡ç­¾ç®¡ç†ç³»ç»Ÿ
        setTimeout(() => {
            initTagManagement();
            // ğŸ¯ ç¡®ä¿æ ‡ç­¾ç®¡ç†è„‘å›¾æœ‰é»˜è®¤æ•°æ®
            ensureDefaultTagsInMindmap();
        }, 300);
        
        // ç­‰å¾…DOMå®Œå…¨æ¸²æŸ“åç»‘å®šå¢å¼ºäº‹ä»¶ç›‘å¬
        setTimeout(() => {
            bindEnhancedEvents();
        }, 500);

        // å¢å¼ºäº‹ä»¶ç›‘å¬ç³»ç»Ÿ
        function bindEnhancedEvents() {
            // ä¸ºæ‰€æœ‰è„‘å›¾å®¹å™¨ç»‘å®šäº‹ä»¶ç›‘å¬
            ['workspace', 'knowledge', 'project'].forEach(function(tabName) {
                try {
                    const container = document.getElementById('jsmind_container_' + tabName);
                    if (container) {
                        console.log('ğŸ–±ï¸ ç»‘å®š' + tabName + 'è„‘å›¾äº‹ä»¶ç›‘å¬å™¨...');
                        
                        // å·¦é”®ç‚¹å‡»äº‹ä»¶
                        container.addEventListener('click', function(e) {
                            // éšè—å³é”®èœå•
                            hideContextMenu();
                            
                            // æŸ¥æ‰¾èŠ‚ç‚¹å…ƒç´ 
                            let nodeEl = e.target.closest('.jmnode') || e.target.closest('[nodeid]');
                            
                            if (nodeEl) {
                                const nodeId = nodeEl.getAttribute('nodeid');
                                if (nodeId) {
                                    console.log('ğŸ¯ DOMæ•è·' + tabName + 'èŠ‚ç‚¹ç‚¹å‡»:', nodeId);
                                    
                                    // åˆ‡æ¢åˆ°å¯¹åº”çš„è„‘å›¾
                                    if (currentMindmap !== tabName) {
                                        switchMindmapTab(tabName);
                                    }
                                    
                                    // ç¡®ä¿èŠ‚ç‚¹è¢«é€‰ä¸­
                                    mindmaps[tabName].select_node(nodeId);
                                    
                                    // æ˜¾ç¤ºè¯¦æƒ…
                                    showNodeDetails(nodeId);
                                    updateSelectedNodeDisplay();
                                }
                            }
                        });
                        
                        // å³é”®èœå•äº‹ä»¶ï¼ˆåªå¯¹é¡¹ç›®ç®¡ç†é€‰é¡¹å¡å¯ç”¨ï¼‰
                        if (tabName === 'project') {
                            container.addEventListener('contextmenu', function(e) {
                                e.preventDefault();
                                
                                // æŸ¥æ‰¾èŠ‚ç‚¹å…ƒç´ 
                                let nodeEl = e.target.closest('.jmnode') || e.target.closest('[nodeid]');
                                
                                if (nodeEl) {
                                    const nodeId = nodeEl.getAttribute('nodeid');
                                    if (nodeId) {
                                        // è®¾ç½®å³é”®ç›®æ ‡èŠ‚ç‚¹
                                        contextMenuTargetNode = mindmaps[tabName].get_node(nodeId);
                                        
                                        // æ˜¾ç¤ºå³é”®èœå•
                                        showContextMenu(e.clientX, e.clientY);
                                        
                                        console.log('ğŸ–±ï¸ å³é”®ç‚¹å‡»èŠ‚ç‚¹:', contextMenuTargetNode.topic);
                                    }
                                }
                            });
                        }
                        
                        console.log('âœ… ' + tabName + 'äº‹ä»¶ç›‘å¬å™¨å·²ç»‘å®š');
                    } else {
                        console.log('âŒ æœªæ‰¾åˆ°' + tabName + 'å®¹å™¨');
                    }
                } catch (error) {
                    console.log('âŒ ' + tabName + 'äº‹ä»¶ç»‘å®šå¤±è´¥:', error.message);
                }
            });
            
            // ç‚¹å‡»å…¶ä»–åŒºåŸŸéšè—å³é”®èœå•
            document.addEventListener('click', function(e) {
                if (!e.target.closest('#contextMenu')) {
                    hideContextMenu();
                }
            });
        }

        // ä¸»é¢˜åˆ—è¡¨
        var themes = [
            { name: 'primary', label: 'è“è‰²ä¸»é¢˜' },
            { name: 'success', label: 'æˆåŠŸç»¿' },
            { name: 'warning', label: 'è­¦å‘Šæ©™' },
            { name: 'danger', label: 'å±é™©çº¢' },
            { name: 'info', label: 'ä¿¡æ¯é’' },
            { name: 'greensea', label: 'æµ·ç»¿è‰²' },
            { name: 'nephritis', label: 'ç¿¡ç¿ ç»¿' },
            { name: 'belizehole', label: 'æ·±è“è‰²' },
            { name: 'wisteria', label: 'ç´«è—¤è‰²' },
            { name: 'asphalt', label: 'æ²¥é’ç°' },
            { name: 'orange', label: 'æ©™çº¢è‰²' },
            { name: 'pumpkin', label: 'å—ç“œè‰²' },
            { name: 'pomegranate', label: 'çŸ³æ¦´çº¢' },
            { name: 'clouds', label: 'äº‘æœµç™½' },
            { name: 'asbestos', label: 'çŸ³æ£‰ç°' }
        ];

        var currentThemeIndex = 0;
        var isDragEnabled = true;

        // æ·»åŠ èŠ‚ç‚¹
        function addNode() {
            var currentJm = getCurrentJsMind();
            var selected = currentJm.get_selected_node();
            if (!selected) {
                alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªèŠ‚ç‚¹');
                return;
            }
            
            var topic = prompt('è¯·è¾“å…¥æ–°èŠ‚ç‚¹çš„å†…å®¹:', 'æ–°èŠ‚ç‚¹');
            if (topic && topic.trim()) {
                var nodeId = 'node_' + Date.now();
                currentJm.add_node(selected, nodeId, topic.trim());
                showMessage('å·²æ·»åŠ èŠ‚ç‚¹: ' + topic);
                updateSelectedNodeDisplay();
            }
        }

        // ç¼–è¾‘èŠ‚ç‚¹
        function editNode() {
            var currentJm = getCurrentJsMind();
            var selected = currentJm.get_selected_node();
            if (!selected) {
                alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªèŠ‚ç‚¹');
                return;
            }
            
            var newTopic = prompt('è¯·è¾“å…¥æ–°çš„èŠ‚ç‚¹å†…å®¹:', selected.topic);
            if (newTopic && newTopic.trim()) {
                currentJm.update_node(selected.id, newTopic.trim());
                showMessage('å·²æ›´æ–°èŠ‚ç‚¹: ' + newTopic);
                updateSelectedNodeDisplay();
            }
        }

        // åˆ é™¤èŠ‚ç‚¹
        function removeNode() {
            var currentJm = getCurrentJsMind();
            var selected = currentJm.get_selected_node();
            if (!selected) {
                alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªèŠ‚ç‚¹');
                return;
            }
            
            if (selected.id === currentJm.get_root().id) {
                alert('æ ¹èŠ‚ç‚¹ä¸èƒ½åˆ é™¤');
                return;
            }
            
            if (confirm('ç¡®å®šè¦åˆ é™¤èŠ‚ç‚¹ "' + selected.topic + '" åŠå…¶æ‰€æœ‰å­èŠ‚ç‚¹å—ï¼Ÿ')) {
                var topic = selected.topic;
                currentJm.remove_node(selected);
                showMessage('å·²åˆ é™¤èŠ‚ç‚¹: ' + topic);
                updateSelectedNodeDisplay();
            }
        }

        // å±•å¼€å…¨éƒ¨
        function expandAll() {
            var currentJm = getCurrentJsMind();
            currentJm.expand_all();
            showMessage('å·²å±•å¼€æ‰€æœ‰èŠ‚ç‚¹');
        }

        // æ”¶èµ·å…¨éƒ¨
        function collapseAll() {
            var currentJm = getCurrentJsMind();
            var root = currentJm.get_root();
            if (root.children) {
                root.children.forEach(function(child) {
                    currentJm.collapse_node(child);
                });
            }
            showMessage('å·²æ”¶èµ·æ‰€æœ‰å­èŠ‚ç‚¹');
        }

        // åˆ‡æ¢ä¸»é¢˜
        function changeTheme() {
            currentThemeIndex = (currentThemeIndex + 1) % themes.length;
            var theme = themes[currentThemeIndex];
            
            // ä¸ºæ‰€æœ‰è„‘å›¾å®ä¾‹è®¾ç½®ä¸»é¢˜
            Object.values(mindmaps).forEach(function(mindmap) {
                mindmap.set_theme(theme.name);
            });
            
            document.getElementById('currentTheme').textContent = theme.label;
            showMessage('å·²åˆ‡æ¢åˆ°ä¸»é¢˜: ' + theme.label);
            // è‡ªåŠ¨ä¿å­˜ä¸»é¢˜è®¾ç½®
            setTimeout(autoSaveData, 100);
        }

        // åˆ‡æ¢æ‹–æ‹½åŠŸèƒ½
        function toggleDrag() {
            if (isDragEnabled) {
                // ç¦ç”¨æ‰€æœ‰è„‘å›¾çš„æ‹–æ‹½åŠŸèƒ½
                Object.values(mindmaps).forEach(function(mindmap) {
                    mindmap.disable_draggable_node();
                });
                isDragEnabled = false;
                document.getElementById('dragStatus').textContent = 'å¯ç”¨æ‹–æ‹½';
                document.getElementById('dragEnabled').textContent = 'å·²ç¦ç”¨';
                showMessage('å·²ç¦ç”¨æ‹–æ‹½åŠŸèƒ½');
            } else {
                // å¯ç”¨æ‰€æœ‰è„‘å›¾çš„æ‹–æ‹½åŠŸèƒ½
                Object.values(mindmaps).forEach(function(mindmap) {
                    mindmap.enable_draggable_node();
                });
                isDragEnabled = true;
                document.getElementById('dragStatus').textContent = 'ç¦ç”¨æ‹–æ‹½';
                document.getElementById('dragEnabled').textContent = 'å·²å¯ç”¨';
                showMessage('å·²å¯ç”¨æ‹–æ‹½åŠŸèƒ½');
            }
            // è‡ªåŠ¨ä¿å­˜æ‹–æ‹½çŠ¶æ€
            setTimeout(autoSaveData, 100);
        }
        
        // æ›´æ–°æ‹–æ‹½çŠ¶æ€æ˜¾ç¤º
        function updateDragStatusDisplay() {
            if (isDragEnabled) {
                document.getElementById('dragStatus').textContent = 'ç¦ç”¨æ‹–æ‹½';
                document.getElementById('dragEnabled').textContent = 'å·²å¯ç”¨';
            } else {
                document.getElementById('dragStatus').textContent = 'å¯ç”¨æ‹–æ‹½';
                document.getElementById('dragEnabled').textContent = 'å·²ç¦ç”¨';
            }
        }

        // å¯¼å‡ºæ•°æ®
        function exportData() {
            var data = jm.get_data('node_tree');
            var jsonStr = JSON.stringify(data, null, 2);
            
            var newWindow = window.open('', '_blank', 'width=900,height=700');
                                                   var htmlContent = '<!DOCTYPE html><html><head><title>æœ¬åœ°ç‰ˆæ€ç»´å¯¼å›¾æ•°æ®å¯¼å‡º</title>';
            htmlContent += '<style>body{font-family:Monaco,Consolas,monospace;margin:30px;background:#f8f9fa;}';
            htmlContent += '.container{background:white;padding:25px;border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,0.1);}';
            htmlContent += 'h2{color:#2c3e50;margin:0 0 20px 0;}';
            htmlContent += 'pre{background:#f8f9fa;padding:20px;border-radius:6px;overflow:auto;border:1px solid #dee2e6;}</style>';
            htmlContent += '</head><body><div class="container">';
            htmlContent += '<h2>ğŸ§  jsMind æœ¬åœ°ç‰ˆæ•°æ®å¯¼å‡º</h2>';
            htmlContent += '<pre>' + jsonStr + '</pre>';
            htmlContent += '</div></body></html>';
            
            newWindow.document.write(htmlContent);
            newWindow.document.close();
        }

        // æ›´æ–°é€‰ä¸­èŠ‚ç‚¹æ˜¾ç¤º
        function updateSelectedNodeDisplay() {
            var selected = jm.get_selected_node();
            var display = selected ? selected.topic : 'æ— ';
            if (display.length > 15) {
                display = display.substring(0, 15) + '...';
            }
            document.getElementById('selectedNode').textContent = display;
        }

        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(message) {
            console.log('jsMind: ' + message);
            
            // åˆ›å»ºä¸´æ—¶æ¶ˆæ¯æç¤º
            var toast = document.createElement('div');
            toast.style.cssText = 'position:fixed;top:20px;right:20px;background:#28a745;color:white;padding:12px 20px;border-radius:6px;z-index:9999;font-size:14px;box-shadow:0 4px 12px rgba(0,0,0,0.15);opacity:0;transition:opacity 0.3s ease;';
            toast.textContent = message;
            document.body.appendChild(toast);
            
            // æ˜¾ç¤ºåŠ¨ç”»
            setTimeout(function() {
                toast.style.opacity = '1';
            }, 10);
            
            // éšè—åŠ¨ç”»
            setTimeout(function() {
                toast.style.opacity = '0';
                setTimeout(function() {
                    if (document.body.contains(toast)) {
                        document.body.removeChild(toast);
                    }
                }, 300);
            }, 2500);
        }
        
        // æ˜¾ç¤ºèŠ‚ç‚¹è¯¦ç»†ä¿¡æ¯ - é€šä¿¡åˆ°PyQtç‰ˆæœ¬
        function showNodeDetails(nodeId) {
            var node = getCurrentJsMind().get_node(nodeId);
            if (!node) return;
            
            // æ›´æ–°å½“å‰ç¼–è¾‘çš„èŠ‚ç‚¹ID
            currentEditingNodeId = nodeId;
            
            // ç¡®ä¿èŠ‚ç‚¹åœ¨æ•°æ®åº“ä¸­å­˜åœ¨ï¼ˆä¿æŒåŸæœ‰é€»è¾‘ï¼‰
            if (!nodeDatabase[nodeId]) {
                nodeDatabase[nodeId] = {
                    id: nodeId,
                    title: node.topic,
                    content: '',
                    relations: {
                        parent: node.parent ? node.parent.id : null,
                        children: node.children ? node.children.map(child => child.id) : []
                    },
                    tags: {
                        categories: [],
                        technical: [],
                        status: [],
                        custom: []
                    },
                    time: {
                        created: new Date().toLocaleString(),
                        modified: new Date().toLocaleString()
                    },
                    author: ''
                };
            }
            
            // ğŸ¯ åŒæ—¶ç¡®ä¿ç»Ÿä¸€æ•°æ®ç»“æ„å­˜åœ¨
            if (!node.data) {
                node.data = {
                    content: nodeDatabase[nodeId].content || '',
                    summary: '',
                    author: nodeDatabase[nodeId].author || '',
                    tags: { 
                        categories: nodeDatabase[nodeId].tags.categories || [], 
                        technical: nodeDatabase[nodeId].tags.technical || [], 
                        status: nodeDatabase[nodeId].tags.status || [],
                        priority: '', 
                        custom: nodeDatabase[nodeId].tags.custom || []
                    },
                    time: { 
                        created: nodeDatabase[nodeId].time.created || new Date().toISOString(), 
                        modified: nodeDatabase[nodeId].time.modified || new Date().toISOString() 
                    },
                    relations: { 
                        parent: node.parent ? node.parent.id : null,
                        children: node.children ? node.children.map(child => child.id) : [],
                        references: [], 
                        dependencies: [], 
                        links: [] 
                    },
                    metadata: { version: '1.0', source: 'manual', confidence: 1.0 },
                    collaboration: { assignee: '', reviewers: [], comments: [], attachments: [] },
                    flags: { isComplete: false, isArchived: false, hasUnsavedChanges: false }
                };
            }
            
            // ğŸ¯ æ¸²æŸ“è¯¦æƒ…é¡µé¢ï¼ˆä½¿ç”¨æ–°çš„äºŒçº§æ ‡ç­¾ç®¡ç†ï¼‰
            renderDetailInfoWithGroupedTags(nodeId);
            
            // å‘é€èŠ‚ç‚¹è¯¦æƒ…åˆ°PyQtç•Œé¢
            sendNodeDetailsToQt(nodeId);
        }
        
        // ğŸ¯ ä¿®å¤ç‰ˆï¼šå…¼å®¹ç»Ÿä¸€æ•°æ®ç»“æ„å’ŒnodeDatabaseçš„èŠ‚ç‚¹è¯¦æƒ…å‘é€
        function sendNodeDetailsToQt(nodeId) {
            var node = getCurrentJsMind().get_node(nodeId);
            if (!node) return;
            
            var path = getNodePath(node);
            
            // ğŸ¯ æ™ºèƒ½æ•°æ®è·å–ï¼šä¼˜å…ˆä½¿ç”¨node.dataï¼Œå›é€€åˆ°nodeDatabase
            var nodeData = node.data || nodeDatabase[nodeId] || {};
            
            // ç¡®ä¿åŸºæœ¬å­—æ®µå­˜åœ¨ï¼Œä¿®å¤PyQtç«¯æ•°æ®å¤„ç†é—®é¢˜
            var nodeDetails = {
                id: nodeId,
                title: node.topic || 'æœªå‘½åèŠ‚ç‚¹',  // ç¡®ä¿titleå­—æ®µå­˜åœ¨
                content: nodeData.content || 'æš‚æ— è¯¦ç»†å†…å®¹',
                summary: nodeData.summary || '',
                path: path.map(item => item.replace(/<[^>]*>/g, '')).join(' â†’ '),
                parentNode: node.parent ? node.parent.topic : 'æ— ï¼ˆæ ¹èŠ‚ç‚¹ï¼‰',
                childrenCount: node.children ? node.children.length : 0,
                createdTime: nodeData.time ? nodeData.time.created : new Date().toISOString(),
                modifiedTime: nodeData.time ? nodeData.time.modified : new Date().toISOString(),
                author: nodeData.author || 'æœªè®¾ç½®',
                // ğŸ¯ ç¡®ä¿æ ‡ç­¾æ•°æ®ç»“æ„å®Œæ•´
                tags: {
                    categories: (nodeData.tags && nodeData.tags.categories) || [],
                    technical: (nodeData.tags && nodeData.tags.technical) || [],
                    status: (nodeData.tags && nodeData.tags.status) || [],
                    priority: (nodeData.tags && nodeData.tags.priority) || '',
                    custom: (nodeData.tags && nodeData.tags.custom) || []
                },
                metadata: nodeData.metadata || {},
                flags: nodeData.flags || {},
                // ğŸ¯ æ·»åŠ æ ‡ç­¾åŒæ­¥åŠŸèƒ½æ ‡è¯†
                hasTagSyncFunction: true,
                tagSyncFunctionName: 'syncTagsFromMindmap',
                // ğŸ¯ æ·»åŠ è°ƒè¯•ä¿¡æ¯
                debugInfo: {
                    nodeExists: !!node,
                    nodeDataExists: !!nodeData,
                    currentMindmap: currentMindmap,
                    timestamp: new Date().toISOString()
                }
            };
            
            console.log('ğŸ”„ å‡†å¤‡å‘é€èŠ‚ç‚¹è¯¦æƒ…åˆ°PyQt:', nodeDetails.title);
            
            // å°è¯•é€šè¿‡ä¸åŒæ–¹å¼å‘é€åˆ°PyQt
            try {
                // æ–¹æ³•1: é€šè¿‡QWebChannel bridgeå¯¹è±¡ï¼ˆæ¨èæ–¹å¼ï¼‰
                if (typeof window.pyqt_bridge !== 'undefined') {
                    window.pyqt_bridge.updateNodeDetails(JSON.stringify(nodeDetails));
                    console.log('âœ… èŠ‚ç‚¹è¯¦æƒ…å·²é€šè¿‡QWebChannel bridgeå‘é€åˆ°PyQt');
                    return;
                }
                
                // æ–¹æ³•2: é€šè¿‡Qt å…¨å±€å¯¹è±¡ï¼ˆå¤‡ç”¨æ–¹å¼ï¼‰
                if (typeof qt !== 'undefined' && qt.webChannelTransport) {
                    qt.webChannelTransport.send(JSON.stringify({
                        type: 'nodeDetails',
                        data: nodeDetails
                    }));
                    console.log('âœ… èŠ‚ç‚¹è¯¦æƒ…å·²é€šè¿‡qtå¯¹è±¡å‘é€åˆ°PyQt');
                    return;
                }
                
                // æ–¹æ³•3: é€šè¿‡consoleè¾“å‡ºï¼ˆPyQtå¯ä»¥ç›‘å¬ï¼‰
                console.log('PYQT_NODE_DETAILS:', JSON.stringify(nodeDetails));
                console.log('âš ï¸ ä½¿ç”¨consoleæ–¹å¼å‘é€èŠ‚ç‚¹è¯¦æƒ…ï¼ˆWebChannelä¸å¯ç”¨ï¼‰');
                
                // æ–¹æ³•4: é€šè¿‡windowå¯¹è±¡å­˜å‚¨ï¼ˆä¾›PyQtè¯»å–ï¼‰
                window.lastSelectedNodeDetails = nodeDetails;
                window.lastSelectedNodeTime = new Date().toISOString();
                
                // å‘é€è‡ªå®šä¹‰äº‹ä»¶ï¼ˆä¾›PyQtç›‘å¬ï¼‰
                if (typeof window.dispatchEvent === 'function') {
                    var event = new CustomEvent('nodeDetailsChanged', { 
                        detail: nodeDetails 
                    });
                    window.dispatchEvent(event);
                    console.log('âœ… èŠ‚ç‚¹è¯¦æƒ…å·²é€šè¿‡CustomEventå‘é€');
                }
                
            } catch (error) {
                console.error('âŒ å‘é€èŠ‚ç‚¹è¯¦æƒ…åˆ°PyQtå¤±è´¥:', error);
                console.log('ğŸ“Š å½“å‰å¯ç”¨çš„é€šä¿¡å¯¹è±¡:', {
                    'window.pyqt_bridge': typeof window.pyqt_bridge,
                    'qt': typeof qt,
                    'qt.webChannelTransport': typeof qt !== 'undefined' ? typeof qt.webChannelTransport : 'undefined'
                });
            }
        }
        
        // æ¸²æŸ“èŠ‚ç‚¹è¯¦æƒ…ä¿¡æ¯
        function renderNodeDetails(nodeId) {
            var node = getCurrentJsMind().get_node(nodeId);
            var nodeData = nodeDatabase[nodeId];
            var path = getNodePath(node);
            
            var content = `
                <div style="padding: 20px;">
                    <h4 style="margin: 0 0 15px 0; color: #495057; font-size: 16px; font-weight: 600;">
                        ğŸ“‹ èŠ‚ç‚¹è¯¦ç»†ä¿¡æ¯
                    </h4>
                    
                    <div class="path-breadcrumb" style="margin-bottom: 15px; font-size: 12px; color: #6c757d;">
                        èŠ‚ç‚¹è·¯å¾„: ${path.map((item, index) => 
                            index < path.length - 1 ? 
                            `<span style="color: #007bff;">${item.replace(/<[^>]*>/g, '')}</span> â†’ ` : 
                            `<span style="color: #007bff; font-weight: 600;">${item.replace(/<[^>]*>/g, '')}</span>`
                        ).join('')}
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <strong style="color: #495057;">èŠ‚ç‚¹æ ‡é¢˜:</strong><br>
                        <span style="color: #333; font-size: 14px;">${nodeData.title}</span>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <strong style="color: #495057;">åŸºæœ¬ä¿¡æ¯:</strong><br>
                        <div style="font-size: 13px; color: #666; line-height: 1.6;">
                            â€¢ èŠ‚ç‚¹ID: ${nodeData.id}<br>
                            â€¢ çˆ¶èŠ‚ç‚¹: ${nodeData.relations.parent ? 
                                (getCurrentJsMind().get_node(nodeData.relations.parent) ? 
                                getCurrentJsMind().get_node(nodeData.relations.parent).topic : nodeData.relations.parent)
                                : 'æ— ï¼ˆæ ¹èŠ‚ç‚¹ï¼‰'}<br>
                            â€¢ å­èŠ‚ç‚¹æ•°é‡: ${nodeData.relations.children.length} ä¸ª<br>
                            â€¢ åˆ›å»ºæ—¶é—´: ${nodeData.time.created}<br>
                            â€¢ ä¿®æ”¹æ—¶é—´: ${nodeData.time.modified}<br>
                            â€¢ ä½œè€…: ${nodeData.author || 'æœªè®¾ç½®'}
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <strong style="color: #495057;">è¯¦ç»†å†…å®¹:</strong><br>
                        <div style="background: #f8f9fa; padding: 12px; border-radius: 4px; border: 1px solid #dee2e6; font-size: 13px; color: #333; min-height: 60px;">
                            ${nodeData.content || 'æš‚æ— è¯¦ç»†å†…å®¹'}
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <strong style="color: #495057;">æ ‡ç­¾ä¿¡æ¯:</strong><br>
                        <div style="margin-top: 8px;">
                            ${nodeData.tags.categories.length > 0 ? 
                                `<div style="margin-bottom: 8px;">
                                    <span style="font-size: 12px; color: #6c757d;">ğŸ·ï¸ åˆ†ç±»:</span> 
                                    ${nodeData.tags.categories.map(tag => 
                                        `<span style="background: #e9ecef; color: #495057; padding: 2px 8px; border-radius: 12px; font-size: 11px; margin-right: 4px;">${tag}</span>`
                                    ).join('')}
                                </div>` : ''}
                            ${nodeData.tags.technical.length > 0 ? 
                                `<div style="margin-bottom: 8px;">
                                    <span style="font-size: 12px; color: #6c757d;">ğŸ’» æŠ€æœ¯:</span> 
                                    ${nodeData.tags.technical.map(tag => 
                                        `<span style="background: #e3f2fd; color: #1976d2; padding: 2px 8px; border-radius: 12px; font-size: 11px; margin-right: 4px;">${tag}</span>`
                                    ).join('')}
                                </div>` : ''}
                            ${nodeData.tags.status.length > 0 ? 
                                `<div style="margin-bottom: 8px;">
                                    <span style="font-size: 12px; color: #6c757d;">ğŸ“Š çŠ¶æ€:</span> 
                                    ${nodeData.tags.status.map(tag => 
                                        `<span style="background: #fff3e0; color: #f57c00; padding: 2px 8px; border-radius: 12px; font-size: 11px; margin-right: 4px;">${tag}</span>`
                                    ).join('')}
                                </div>` : ''}
                            ${nodeData.tags.categories.length === 0 && nodeData.tags.technical.length === 0 && nodeData.tags.status.length === 0 ? 
                                '<span style="color: #6c757d; font-size: 12px;">æš‚æ— æ ‡ç­¾</span>' : ''}
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #dee2e6; font-size: 12px; color: #6c757d;">
                        ğŸ’¡ æç¤ºï¼šåŒå‡»èŠ‚ç‚¹å¯ä»¥ç¼–è¾‘æ ‡é¢˜ï¼Œå³é”®èœå•å¯ä»¥è¿›è¡Œæ›´å¤šæ“ä½œ
                    </div>
                </div>
            `;
            
            var detailElement = document.getElementById('detail-info-content');
            if (detailElement) {
                detailElement.innerHTML = content;
            }
        }
        
        // åˆ·æ–°é€‰é¡¹å¡å†…å®¹
        function refreshTabContent(tabName, nodeId) {
            var node = getCurrentJsMind().get_node(nodeId);
            if (!node || !nodeDatabase[nodeId]) return;
            
            switch(tabName) {
                case 'basic':
                    renderBasicInfo(nodeId);
                    break;
                case 'detail':
                    renderDetailInfo(nodeId);
                    break;
                case 'history':
                    renderHistoryInfo(nodeId);
                    break;
            }
        }
        
        // æ¸²æŸ“åŸºæœ¬ä¿¡æ¯é€‰é¡¹å¡
        function renderBasicInfo(nodeId) {
            var node = getCurrentJsMind().get_node(nodeId);
            var nodeData = nodeDatabase[nodeId];
            var path = getNodePath(node);
            
            var content = `
                <div class="path-breadcrumb">
                    ${path.map((item, index) => 
                        index < path.length - 1 ? 
                        `<span class="path-node">${item.replace(/<[^>]*>/g, '')}</span><span class="path-separator">â†’</span>` : 
                        `<span class="path-node">${item.replace(/<[^>]*>/g, '')}</span>`
                    ).join('')}
                </div>
                
                <div class="info-row">
                    <div class="info-label">èŠ‚ç‚¹ID:</div>
                    <div class="info-value">${nodeData.id}</div>
                </div>
                
                <div class="info-row">
                    <div class="info-label">æ ‡é¢˜:</div>
                    <div class="info-value">${nodeData.title}</div>
                </div>
                
                <div class="info-row">
                    <div class="info-label">çˆ¶èŠ‚ç‚¹:</div>
                    <div class="info-value">${nodeData.relations.parent ? 
                        getCurrentJsMind().get_node(nodeData.relations.parent) ? getCurrentJsMind().get_node(nodeData.relations.parent).topic : nodeData.relations.parent
                        : 'æ— ï¼ˆæ ¹èŠ‚ç‚¹ï¼‰'}</div>
                </div>
                
                <div class="info-row">
                    <div class="info-label">å­èŠ‚ç‚¹:</div>
                    <div class="info-value">${nodeData.relations.children.length} ä¸ª</div>
                </div>
                
                <div class="info-row">
                    <div class="info-label">åˆ›å»ºæ—¶é—´:</div>
                    <div class="info-value">${nodeData.time.created}</div>
                </div>
                
                <div class="info-row">
                    <div class="info-label">ä¿®æ”¹æ—¶é—´:</div>
                    <div class="info-value">${nodeData.time.modified}</div>
                </div>
                
                <div class="info-row">
                    <div class="info-label">ä½œè€…:</div>
                    <div class="info-value">${nodeData.author || 'æœªè®¾ç½®'}</div>
                </div>
                
                ${renderAllTags(nodeId)}
            `;
            
            var basicElement = document.getElementById('basic-info-content');
            if (basicElement) {
                basicElement.innerHTML = content;
            }
        }
        
        // æ¸²æŸ“è¯¦ç»†ä¿¡æ¯é€‰é¡¹å¡
        function renderDetailInfo(nodeId) {
            var nodeData = nodeDatabase[nodeId];
            
            // ç¡®ä¿æ ‡ç­¾ç»“æ„å®Œæ•´
            if (!nodeData.tags) {
                nodeData.tags = {
                    categories: [],
                    technical: [],
                    status: [],
                    custom: []
                };
            }
            
            // ç¡®ä¿æ¯ä¸ªæ ‡ç­¾ç±»å‹éƒ½å­˜åœ¨
            if (!nodeData.tags.categories) nodeData.tags.categories = [];
            if (!nodeData.tags.technical) nodeData.tags.technical = [];
            if (!nodeData.tags.status) nodeData.tags.status = [];
            if (!nodeData.tags.custom) nodeData.tags.custom = [];
            
            var content = `
                <form onsubmit="event.preventDefault(); saveNodeDetails('${nodeId}');" class="node-detail-form">
                    <div class="detail-header">
                        <input type="text" id="node_author_${nodeId}" value="${nodeData.author || ''}" class="author-input-small" placeholder="ä½œè€…">
                    </div>
                    
                    <div class="form-group">
                        <label for="node_title_${nodeId}" class="form-label">èŠ‚ç‚¹æ ‡é¢˜:</label>
                        <input type="text" id="node_title_${nodeId}" value="${nodeData.title || ''}" class="form-input">
                    </div>
                    
                    <div class="form-group">
                        <label for="node_content_${nodeId}" class="form-label">è¯¦ç»†å†…å®¹:</label>
                        <textarea id="node_content_${nodeId}" class="form-textarea" placeholder="è¾“å…¥èŠ‚ç‚¹çš„è¯¦ç»†æè¿°ã€è¯´æ˜æˆ–å¤‡æ³¨...">${nodeData.content || ''}</textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">ğŸ·ï¸ åˆ†ç±»æ ‡ç­¾:</label>
                        <div id="categories_${nodeId}" class="tag-list">
                            ${nodeData.tags.categories.map(tag => `<span class="tag-item">${tag} <button type="button" onclick="removeNodeTag('${nodeId}', 'categories', '${tag}')" class="tag-remove">Ã—</button></span>`).join('')}
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">ğŸ’» æŠ€æœ¯æ ‡ç­¾:</label>
                        <div id="technical_${nodeId}" class="tag-list">
                            ${nodeData.tags.technical.map(tag => `<span class="tag-item">${tag} <button type="button" onclick="removeNodeTag('${nodeId}', 'technical', '${tag}')" class="tag-remove">Ã—</button></span>`).join('')}
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">ğŸ“Š çŠ¶æ€æ ‡ç­¾:</label>
                        <div id="status_${nodeId}" class="tag-list">
                            ${nodeData.tags.status.map(tag => `<span class="tag-item">${tag} <button type="button" onclick="removeNodeTag('${nodeId}', 'status', '${tag}')" class="tag-remove">Ã—</button></span>`).join('')}
                        </div>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" onclick="syncTagsFromMindmapInternal('${nodeId}')" class="btn-primary">
                            ğŸ”„ æ ‡ç­¾åŒæ­¥
                        </button>
                    </div>
                </form>
            `;
            
            var detailElement2 = document.getElementById('detail-info-content');
            if (detailElement2) {
                detailElement2.innerHTML = content;
            }
        }
        
        // æ¸²æŸ“å†å²è®°å½•é€‰é¡¹å¡
        function renderHistoryInfo(nodeId) {
            var nodeData = nodeDatabase[nodeId];
            
            // ç”Ÿæˆå†å²è®°å½•ï¼ˆæ¨¡æ‹Ÿæ•°æ®ï¼Œå®é™…é¡¹ç›®ä¸­åº”è¯¥ä»çœŸå®å†å²æ•°æ®è·å–ï¼‰
            var historyItems = [
                {
                    time: nodeData.time.created,
                    action: 'èŠ‚ç‚¹åˆ›å»º',
                    detail: `åˆ›å»ºäº†èŠ‚ç‚¹ï¼š"${nodeData.title}"`
                },
                {
                    time: nodeData.time.modified,
                    action: 'æœ€åä¿®æ”¹',
                    detail: 'æ›´æ–°äº†èŠ‚ç‚¹ä¿¡æ¯'
                }
            ];
            
            // å¦‚æœæœ‰æ ‡ç­¾ï¼Œæ·»åŠ æ ‡ç­¾ç›¸å…³å†å²
            var allTags = [];
            if (nodeData.tags.categories) allTags = allTags.concat(nodeData.tags.categories);
            if (nodeData.tags.technical) allTags = allTags.concat(nodeData.tags.technical);
            if (nodeData.tags.status) allTags = allTags.concat(nodeData.tags.status);
            if (nodeData.tags.custom) allTags = allTags.concat(nodeData.tags.custom);
            
            if (allTags.length > 0) {
                historyItems.push({
                    time: nodeData.time.modified,
                    action: 'æ ‡ç­¾ç®¡ç†',
                    detail: `è®¾ç½®äº† ${allTags.length} ä¸ªæ ‡ç­¾ï¼š${allTags.slice(0, 3).join('ã€')}${allTags.length > 3 ? '...' : ''}`
                });
            }
            
            // å¦‚æœæœ‰å†…å®¹ï¼Œæ·»åŠ å†…å®¹ç¼–è¾‘å†å²
            if (nodeData.content.trim()) {
                historyItems.push({
                    time: nodeData.time.modified,
                    action: 'å†…å®¹ç¼–è¾‘',
                    detail: `æ·»åŠ äº†è¯¦ç»†æè¿°ï¼ˆ${nodeData.content.length} å­—ç¬¦ï¼‰`
                });
            }
            
            // æŒ‰æ—¶é—´æ’åº
            historyItems.sort((a, b) => new Date(b.time) - new Date(a.time));
            
            var content = `
                <h4>ğŸ“š èŠ‚ç‚¹å†å²è®°å½•</h4>
                ${historyItems.length > 0 ? 
                    historyItems.map(item => `
                        <div class="history-item">
                            <div class="history-time">${item.time}</div>
                            <div class="history-action">${item.action}</div>
                            <div class="history-detail">${item.detail}</div>
                        </div>
                    `).join('') :
                    `<div class="empty-state">
                        <div class="icon">ğŸ“š</div>
                        <div>æš‚æ— å†å²è®°å½•</div>
                    </div>`
                }
            `;
            
            var historyElement = document.getElementById('history-info-content');
            if (historyElement) {
                historyElement.innerHTML = content;
            }
        }
        
        // æ¸²æŸ“æ‰€æœ‰æ ‡ç­¾ï¼ˆç”¨äºåŸºæœ¬ä¿¡æ¯é€‰é¡¹å¡ï¼‰
        function renderAllTags(nodeId) {
            var nodeData = nodeDatabase[nodeId];
            
            // ç¡®ä¿æ ‡ç­¾ç»“æ„å®Œæ•´
            if (!nodeData.tags) {
                nodeData.tags = {
                    categories: [],
                    technical: [],
                    status: [],
                    custom: []
                };
            }
            
            var hasAnyTags = (nodeData.tags.categories && nodeData.tags.categories.length > 0) || 
                           (nodeData.tags.technical && nodeData.tags.technical.length > 0) || 
                           (nodeData.tags.status && nodeData.tags.status.length > 0) ||
                           (nodeData.tags.custom && nodeData.tags.custom.length > 0);
            
            if (!hasAnyTags) {
                return `
                    <div class="info-row">
                        <div class="info-label">æ ‡ç­¾:</div>
                        <div class="info-value">æ— æ ‡ç­¾</div>
                    </div>
                `;
            }
            
            var tagsHTML = '';
            
            if (nodeData.tags.categories && nodeData.tags.categories.length > 0) {
                tagsHTML += `
                    <div class="info-row">
                        <div class="info-label">åˆ†ç±»æ ‡ç­¾:</div>
                        <div class="info-value">
                            <div class="tag-list">
                                ${nodeData.tags.categories.map(tag => `<span class="tag-item">${tag}</span>`).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }
            
            if (nodeData.tags.technical && nodeData.tags.technical.length > 0) {
                tagsHTML += `
                    <div class="info-row">
                        <div class="info-label">æŠ€æœ¯æ ‡ç­¾:</div>
                        <div class="info-value">
                            <div class="tag-list">
                                ${nodeData.tags.technical.map(tag => `<span class="tag-item">${tag}</span>`).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }
            
            if (nodeData.tags.status && nodeData.tags.status.length > 0) {
                tagsHTML += `
                    <div class="info-row">
                        <div class="info-label">çŠ¶æ€æ ‡ç­¾:</div>
                        <div class="info-value">
                            <div class="tag-list">
                                ${nodeData.tags.status.map(tag => `<span class="tag-item">${tag}</span>`).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }
            
            if (nodeData.tags.custom && nodeData.tags.custom.length > 0) {
                tagsHTML += `
                    <div class="info-row">
                        <div class="info-label">è‡ªå®šä¹‰æ ‡ç­¾:</div>
                        <div class="info-value">
                            <div class="tag-list">
                                ${nodeData.tags.custom.map(tag => `<span class="tag-item">${tag}</span>`).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }
            
            return tagsHTML;
        }
        
        // éšè—èŠ‚ç‚¹ä¿¡æ¯é¢æ¿
        function hideNodeInfoPanel() {
            var panel = document.getElementById('node-info-panel');
            panel.style.display = 'none';
        }

        // è„‘å›¾é€‰é¡¹å¡åˆ‡æ¢å‡½æ•°
        function switchMindmapTab(tabName) {
            // å…ˆè‡ªåŠ¨ä¿å­˜å½“å‰ç¼–è¾‘å†…å®¹
            autoSaveCurrentNodeDetails();
            
            // æ›´æ–°å½“å‰æ´»è·ƒçš„è„‘å›¾
            currentMindmap = tabName;
            
            // æ¸…é™¤æ‰€æœ‰è„‘å›¾é€‰é¡¹å¡çš„activeçŠ¶æ€
            var tabButtons = document.querySelectorAll('.mindmap-tab-button');
            var tabContents = document.querySelectorAll('.mindmap-tab-content');
            
            tabButtons.forEach(function(btn) {
                btn.classList.remove('active');
            });
            
            tabContents.forEach(function(content) {
                content.classList.remove('active');
            });
            
            // æ¿€æ´»é€‰ä¸­çš„è„‘å›¾é€‰é¡¹å¡
            document.querySelector('.mindmap-tab-button[onclick="switchMindmapTab(\'' + tabName + '\')"]').classList.add('active');
            document.getElementById('mindmap-tab-' + tabName).classList.add('active');
            
            // ğŸ¯ ä¿®å¤è„‘å›¾æ˜¾ç¤ºé—®é¢˜ï¼šç­‰å¾…DOMæ›´æ–°åé‡æ–°è°ƒæ•´è„‘å›¾å¸ƒå±€
            setTimeout(function() {
                try {
                    // æ›´æ–°å…¨å±€jmå˜é‡æŒ‡å‘å½“å‰æ´»è·ƒçš„è„‘å›¾
            jm = getCurrentJsMind();
            
                    // ğŸ”§ å¼ºåˆ¶é‡æ–°è°ƒæ•´è„‘å›¾å¸ƒå±€ï¼ˆä¿®å¤compatibility modeé—®é¢˜ï¼‰
                    if (jm && typeof jm.resize === 'function') {
                        jm.resize();
                        console.log('âœ… è„‘å›¾å¸ƒå±€å·²é‡æ–°è°ƒæ•´');
                    }
                    
                    // å¦‚æœæ–°è„‘å›¾æœ‰é€‰ä¸­çš„èŠ‚ç‚¹ï¼Œæ˜¾ç¤ºå…¶è¯¦æƒ…
            var selectedNode = jm.get_selected_node();
            if (selectedNode) {
                showNodeDetails(selectedNode.id);
                updateSelectedNodeDisplay();
            } else {
                        // æ¸…é™¤è¯¦æƒ…æ˜¾ç¤º
                clearNodeDetails();
            }
            
                    console.log('ğŸ”„ åˆ‡æ¢åˆ°è„‘å›¾:', tabName);
                    
                } catch (error) {
                    console.error('âŒ åˆ‡æ¢è„‘å›¾æ ‡ç­¾é¡µæ—¶å‡ºé”™:', error);
                }
            }, 100); // ç»™DOMä¸€ç‚¹æ—¶é—´å®Œæˆæ¸²æŸ“
        }
        
        // æ˜¾ç¤ºå³é”®èœå•
        function showContextMenu(x, y) {
            var menu = document.getElementById('contextMenu');
            menu.style.left = x + 'px';
            menu.style.top = y + 'px';
            menu.style.display = 'block';
            
            // ç¡®ä¿èœå•ä¸è¶…å‡ºå±å¹•è¾¹ç•Œ
            var rect = menu.getBoundingClientRect();
            if (rect.right > window.innerWidth) {
                menu.style.left = (x - rect.width) + 'px';
            }
            if (rect.bottom > window.innerHeight) {
                menu.style.top = (y - rect.height) + 'px';
            }
        }
        
        // éšè—å³é”®èœå•
        function hideContextMenu() {
            var menu = document.getElementById('contextMenu');
            menu.style.display = 'none';
            contextMenuTargetNode = null;
        }
        
        // å°†ç„¦ç‚¹èŠ‚ç‚¹å¤åˆ¶åˆ°ä¸´æ—¶å·¥ä½œåŒº
        function focusNodeToWorkspaces() {
            if (!contextMenuTargetNode) {
                hideContextMenu();
                return;
            }
            
            try {
                // å¤åˆ¶èŠ‚ç‚¹åŠå…¶å­æ ‘
                var nodeTree = copyNodeTree(contextMenuTargetNode);
                
                // å¤åˆ¶åˆ°ä¸´æ—¶å·¥ä½œåŒºA
                var workspaceData = {
                    meta: {
                        name: "ä¸´æ—¶å·¥ä½œåŒºA - " + contextMenuTargetNode.topic,
                        author: "NodeMind",
                        version: "1.0.0"
                    },
                    format: "node_tree",
                    data: nodeTree
                };
                mindmaps.workspace.show(workspaceData);
                
                // å¤åˆ¶åˆ°æ ‡ç­¾ç®¡ç†åŒº
                var knowledgeData = {
                    meta: {
                        name: "æ ‡ç­¾ç®¡ç† - " + contextMenuTargetNode.topic,
                        author: "NodeMind",
                        version: "1.0.0"
                    },
                    format: "node_tree",
                    data: nodeTree
                };
                mindmaps.knowledge.show(knowledgeData);
                
                showMessage('ğŸ”¬ å·²å°†ç„¦ç‚¹èŠ‚ç‚¹"' + contextMenuTargetNode.topic + '"å¤åˆ¶åˆ°ä¸´æ—¶å·¥ä½œåŒº');
                console.log('âœ… ç„¦ç‚¹èŠ‚ç‚¹å·²å¤åˆ¶åˆ°ä¸´æ—¶å·¥ä½œåŒº:', contextMenuTargetNode.topic);
                
                hideContextMenu();
                
            } catch (error) {
                console.error('âŒ å¤åˆ¶èŠ‚ç‚¹åˆ°ä¸´æ—¶å·¥ä½œåŒºå¤±è´¥:', error);
                showMessage('âŒ å¤åˆ¶å¤±è´¥: ' + error.message);
                hideContextMenu();
            }
        }
        
        // é€’å½’å¤åˆ¶èŠ‚ç‚¹æ ‘ï¼ˆä¿æŒåŸå§‹IDå’Œæ‰€æœ‰è¯¦ç»†ä¿¡æ¯ï¼‰
        function copyNodeTree(node) {
            var newNode = {
                id: node.id,  // ä¿æŒåŸå§‹èŠ‚ç‚¹IDï¼Œç¡®ä¿è¯¦ç»†ä¿¡æ¯èƒ½æ­£ç¡®å…³è”
                topic: node.topic
            };
            
            // ç¡®ä¿èŠ‚ç‚¹çš„è¯¦ç»†ä¿¡æ¯åœ¨nodeDatabaseä¸­å­˜åœ¨
            if (!nodeDatabase[node.id]) {
                // å¦‚æœnodeDatabaseä¸­æ²¡æœ‰è¿™ä¸ªèŠ‚ç‚¹çš„ä¿¡æ¯ï¼Œåˆ›å»ºé»˜è®¤ä¿¡æ¯
                nodeDatabase[node.id] = {
                    id: node.id,
                    title: node.topic,
                    content: '',
                    author: '',
                    time: {
                        created: new Date().toLocaleString(),
                        modified: new Date().toLocaleString()
                    },
                    tags: {
                        categories: [],
                        technical: [],
                        status: []
                    }
                };
            }
            
            // å¦‚æœæœ‰å­èŠ‚ç‚¹ï¼Œé€’å½’å¤åˆ¶
            if (node.children && node.children.length > 0) {
                newNode.children = [];
                node.children.forEach(function(child, index) {
                    var childNode = copyNodeTree(child);
                    // è®¾ç½®æ–¹å‘ï¼šå·¦å³äº¤æ›¿åˆ†å¸ƒ
                    childNode.direction = index % 2 === 0 ? 'right' : 'left';
                    newNode.children.push(childNode);
                });
            }
            
            return newNode;
        }
        
        // æ¸…é™¤èŠ‚ç‚¹è¯¦æƒ…æ˜¾ç¤º
        function clearNodeDetails() {
            var emptyStates = [
                { id: 'basic-info-content', icon: 'ğŸ“‹', text: 'ç‚¹å‡»æ€ç»´å¯¼å›¾ä¸­çš„èŠ‚ç‚¹æŸ¥çœ‹åŸºæœ¬ä¿¡æ¯' },
                { id: 'detail-info-content', icon: 'ğŸ“', text: 'ç‚¹å‡»æ€ç»´å¯¼å›¾ä¸­çš„èŠ‚ç‚¹ç¼–è¾‘è¯¦ç»†æè¿°' },
                { id: 'history-info-content', icon: 'ğŸ“š', text: 'ç‚¹å‡»æ€ç»´å¯¼å›¾ä¸­çš„èŠ‚ç‚¹æŸ¥çœ‹å†å²è®°å½•' }
            ];
            
            emptyStates.forEach(state => {
                var element = document.getElementById(state.id);
                if (element) {
                    element.innerHTML = `
                        <div class="empty-state">
                            <div class="icon">${state.icon}</div>
                            <div>${state.text}</div>
                        </div>
                    `;
                }
            });
            
            // æ¸…é™¤å½“å‰ç¼–è¾‘èŠ‚ç‚¹ID
            currentEditingNodeId = null;
            
            // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
            document.getElementById('selectedNode').textContent = 'æ— ';
        }
        
        // è¯¦æƒ…é¡µé€‰é¡¹å¡åˆ‡æ¢åŠŸèƒ½å·²ç§»é™¤ï¼Œç°åœ¨ç›´æ¥æ˜¾ç¤ºèŠ‚ç‚¹è¯¦æƒ…
        
        // ä¿å­˜èŠ‚ç‚¹è¯¦ç»†ä¿¡æ¯å¹¶åŒæ­¥åˆ°æ‰€æœ‰å·¥ä½œåŒº
        function saveNodeDetails(nodeId) {
            var node = getCurrentJsMind().get_node(nodeId);
            if (!node || !nodeDatabase[nodeId]) return;
            
            // è·å–è¡¨å•æ•°æ®
            var title = document.getElementById('node_title_' + nodeId).value;
            var content = document.getElementById('node_content_' + nodeId).value;
            var author = document.getElementById('node_author_' + nodeId).value;
            
            // æ›´æ–°èŠ‚ç‚¹æ•°æ®åº“
            nodeDatabase[nodeId].title = title;
            nodeDatabase[nodeId].content = content;
            nodeDatabase[nodeId].author = author;
            nodeDatabase[nodeId].time.modified = new Date().toLocaleString();
            
            // åŒæ­¥æ›´æ–°æ‰€æœ‰å·¥ä½œåŒºä¸­çš„ç›¸åŒèŠ‚ç‚¹æ ‡é¢˜
            Object.keys(mindmaps).forEach(function(tabName) {
                var mindmap = mindmaps[tabName];
                var targetNode = mindmap.get_node(nodeId);
                if (targetNode && targetNode.topic !== title) {
                    mindmap.update_node(nodeId, title);
                }
            });
            
            showMessage('ğŸ’¾ èŠ‚ç‚¹è¯¦ç»†ä¿¡æ¯å·²ä¿å­˜');
            
            // åˆ·æ–°å…¶ä»–é€‰é¡¹å¡å†…å®¹ï¼ˆå¦‚åŸºæœ¬ä¿¡æ¯é€‰é¡¹å¡ä¸­çš„ä½œè€…æ˜¾ç¤ºï¼‰
            var currentTab = document.querySelector('.tab-content.active');
            if (currentTab && currentTab.id === 'tab-detail') {
                // å¦‚æœåœ¨è¯¦ç»†æè¿°é€‰é¡¹å¡ï¼Œå¯ä»¥é€‰æ‹©æ€§åˆ·æ–°åŸºæœ¬ä¿¡æ¯é€‰é¡¹å¡çš„å†…å®¹
                setTimeout(() => {
                    renderBasicInfo(nodeId);
                }, 100);
            }
            
            // è‡ªåŠ¨ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            setTimeout(autoSaveData, 200);
        }
        
        // é‡ç½®èŠ‚ç‚¹è¯¦ç»†ä¿¡æ¯
        function resetNodeDetails(nodeId) {
            var activeTab = document.querySelector('.tab-content.active');
            if (activeTab) {
                var tabName = activeTab.id.replace('tab-', '');
                refreshTabContent(tabName, nodeId);
            }
            showMessage('èŠ‚ç‚¹è¯¦ç»†ä¿¡æ¯å·²é‡ç½®');
        }
        
        // æ›´æ–°èŠ‚ç‚¹æ ‡é¢˜
        function updateNodeTitle(nodeId, newTitle) {
            var node = jm.get_node(nodeId);
            if (node && newTitle && newTitle.trim()) {
                jm.update_node(nodeId, newTitle.trim());
                nodeDatabase[nodeId].title = newTitle.trim();
                nodeDatabase[nodeId].time.modified = new Date().toLocaleString();
            }
        }
        
        // ä»è¾“å…¥æ¡†æ·»åŠ æ ‡ç­¾ï¼ˆå·²åºŸå¼ƒ - ç•Œé¢ç®€åŒ–ï¼‰
        function addTagFromInput(nodeId, tagType) {
            // åŠŸèƒ½å·²ç§»é™¤ï¼Œä½¿ç”¨æ ‡ç­¾åŒæ­¥æŒ‰é’®ä»£æ›¿
            showMessage('è¯·ä½¿ç”¨"æ ‡ç­¾åŒæ­¥"æŒ‰é’®ä»æ ‡ç­¾ç®¡ç†è„‘å›¾åŒæ­¥æ ‡ç­¾');
        }
        

        
        // è·å–æ ‡ç­¾ç±»å‹ä¸­æ–‡åç§°
        
        // ================ æ ‡ç­¾ç®¡ç†ç³»ç»Ÿ ================
        
        // åˆå§‹åŒ–æ ‡ç­¾ç®¡ç†ç³»ç»Ÿ
        function initTagManagement() {
            console.log('ğŸ·ï¸ åˆå§‹åŒ–æ ‡ç­¾ç®¡ç†ç³»ç»Ÿ...');
            
            // ä»localStorageåŠ è½½æ ‡ç­¾æ•°æ®
            loadTagDatabase();
            
            // åŒæ­¥æ ‡ç­¾åˆ°è„‘å›¾æ˜¾ç¤º
            syncTagsToMindmap();
            
            // ç›‘å¬æ ‡ç­¾ç®¡ç†è„‘å›¾çš„å˜åŒ–
            bindTagMindmapEvents();
            
            console.log('âœ… æ ‡ç­¾ç®¡ç†ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ');
        }
        
        // åŠ è½½æ ‡ç­¾æ•°æ®åº“
        function loadTagDatabase() {
            try {
                var savedTags = localStorage.getItem('TAG_DATABASE');
                if (savedTags) {
                    tagDatabase = JSON.parse(savedTags);
                    console.log('ğŸ“¥ å·²åŠ è½½æ ‡ç­¾æ•°æ®:', tagDatabase);
                } else {
                    // åˆå§‹åŒ–é»˜è®¤æ ‡ç­¾
                    tagDatabase = {
                        categories: ['å‰ç«¯', 'åç«¯', 'æ•°æ®åº“', 'æµ‹è¯•', 'éƒ¨ç½²'],
                        technical: ['JavaScript', 'Python', 'HTML', 'CSS', 'SQL'],
                        status: ['å¾…å¼€å§‹', 'è¿›è¡Œä¸­', 'å·²å®Œæˆ', 'å·²æš‚åœ', 'éœ€å®¡æ ¸'],
                        custom: ['é‡è¦', 'ç´§æ€¥', 'ä¼˜åŒ–', 'ä¿®å¤', 'æ–°åŠŸèƒ½']
                    };
                    saveTagDatabase();
                }
            } catch (error) {
                console.error('âŒ åŠ è½½æ ‡ç­¾æ•°æ®å¤±è´¥:', error);
                // ä½¿ç”¨é»˜è®¤æ ‡ç­¾
                tagDatabase = {
                    categories: ['å‰ç«¯', 'åç«¯', 'æ•°æ®åº“'],
                    technical: ['JavaScript', 'Python', 'HTML'],
                    status: ['å¾…å¼€å§‹', 'è¿›è¡Œä¸­', 'å·²å®Œæˆ'],
                    custom: ['é‡è¦', 'ç´§æ€¥', 'ä¼˜åŒ–']
                };
            }
        }
        
        // ä¿å­˜æ ‡ç­¾æ•°æ®åº“
        function saveTagDatabase() {
            try {
                localStorage.setItem('TAG_DATABASE', JSON.stringify(tagDatabase));
                console.log('ğŸ’¾ æ ‡ç­¾æ•°æ®å·²ä¿å­˜');
            } catch (error) {
                console.error('âŒ ä¿å­˜æ ‡ç­¾æ•°æ®å¤±è´¥:', error);
            }
        }
        
        // åŒæ­¥æ ‡ç­¾åˆ°è„‘å›¾æ˜¾ç¤º
        function syncTagsToMindmap() {
            if (!mindmaps.knowledge) return;
            
            try {
                // æ›´æ–°å„ä¸ªæ ‡ç­¾åˆ†ç±»çš„å­èŠ‚ç‚¹
                updateTagCategory('category_tags', tagDatabase.categories);
                updateTagCategory('technical_tags', tagDatabase.technical);
                updateTagCategory('status_tags', tagDatabase.status);
                updateTagCategory('custom_tags', tagDatabase.custom);
                
                console.log('ğŸ”„ æ ‡ç­¾å·²åŒæ­¥åˆ°è„‘å›¾æ˜¾ç¤º');
            } catch (error) {
                console.error('âŒ åŒæ­¥æ ‡ç­¾åˆ°è„‘å›¾å¤±è´¥:', error);
            }
        }
        
        // æ›´æ–°æ ‡ç­¾åˆ†ç±»çš„å­èŠ‚ç‚¹
        function updateTagCategory(categoryId, tags) {
            var categoryNode = mindmaps.knowledge.get_node(categoryId);
            if (!categoryNode) return;
            
            // åˆ é™¤ç°æœ‰å­èŠ‚ç‚¹
            if (categoryNode.children) {
                [...categoryNode.children].forEach(child => {
                    mindmaps.knowledge.remove_node(child.id);
                });
            }
            
            // æ·»åŠ æ–°çš„æ ‡ç­¾èŠ‚ç‚¹
            tags.forEach((tag, index) => {
                var tagId = categoryId + '_tag_' + index;
                mindmaps.knowledge.add_node(categoryNode, tagId, tag);
            });
        }
        
        // ç›‘å¬æ ‡ç­¾ç®¡ç†è„‘å›¾çš„å˜åŒ–
        function bindTagMindmapEvents() {
            if (!mindmaps.knowledge) return;
            
            // ç›‘å¬èŠ‚ç‚¹æ·»åŠ äº‹ä»¶
            mindmaps.knowledge.add_event_listener(function(type, data) {
                if (type === 'edit_node' || type === 'add_node' || type === 'remove_node') {
                    // å»¶è¿ŸåŒæ­¥ï¼Œé¿å…äº‹ä»¶å†²çª
                    setTimeout(() => {
                        syncMindmapToTagDatabase();
                    }, 100);
                }
            });
            
            console.log('ğŸ¯ æ ‡ç­¾è„‘å›¾äº‹ä»¶ç›‘å¬å·²ç»‘å®š');
        }
        
        // ğŸ¯ ç¡®ä¿æ ‡ç­¾ç®¡ç†è„‘å›¾æœ‰é»˜è®¤æ ‡ç­¾æ•°æ®
        function ensureDefaultTagsInMindmap() {
            if (!mindmaps.knowledge) {
                console.log('âŒ æ ‡ç­¾ç®¡ç†è„‘å›¾æœªåˆå§‹åŒ–');
                return;
            }
            
            try {
                console.log('ğŸ·ï¸ æ£€æŸ¥å¹¶æ·»åŠ é»˜è®¤æ ‡ç­¾åˆ°è„‘å›¾...');
                
                // æ£€æŸ¥å„ä¸ªåˆ†ç±»èŠ‚ç‚¹æ˜¯å¦æœ‰å­èŠ‚ç‚¹ï¼Œå¦‚æœæ²¡æœ‰åˆ™æ·»åŠ é»˜è®¤æ ‡ç­¾
                const defaultTags = {
                    'category_tags': ['å‰ç«¯', 'åç«¯', 'æ•°æ®åº“', 'æµ‹è¯•', 'éƒ¨ç½²'],
                    'technical_tags': ['JavaScript', 'Python', 'HTML', 'CSS', 'SQL'],
                    'status_tags': ['å¾…å¼€å§‹', 'è¿›è¡Œä¸­', 'å·²å®Œæˆ', 'å·²æš‚åœ', 'éœ€å®¡æ ¸'],
                    'custom_tags': ['é‡è¦', 'ç´§æ€¥', 'ä¼˜åŒ–', 'ä¿®å¤', 'æ–°åŠŸèƒ½']
                };
                
                Object.keys(defaultTags).forEach(categoryId => {
                    const categoryNode = mindmaps.knowledge.get_node(categoryId);
                    if (categoryNode) {
                        // å¦‚æœåˆ†ç±»èŠ‚ç‚¹æ²¡æœ‰å­èŠ‚ç‚¹ï¼Œæ·»åŠ é»˜è®¤æ ‡ç­¾
                        if (!categoryNode.children || categoryNode.children.length === 0) {
                            console.log(`ğŸ“‚ ä¸º ${categoryId} æ·»åŠ é»˜è®¤æ ‡ç­¾...`);
                            defaultTags[categoryId].forEach((tag, index) => {
                                const tagId = categoryId + '_default_' + index;
                                mindmaps.knowledge.add_node(categoryNode, tagId, tag);
                            });
                        } else {
                            console.log(`âœ… ${categoryId} å·²æœ‰ ${categoryNode.children.length} ä¸ªæ ‡ç­¾`);
                        }
                    } else {
                        console.log(`âŒ æœªæ‰¾åˆ°åˆ†ç±»èŠ‚ç‚¹: ${categoryId}`);
                    }
                });
                
                // åŒæ­¥åˆ°æ ‡ç­¾æ•°æ®åº“
                setTimeout(() => {
                    syncMindmapToTagDatabase();
                    console.log('âœ… é»˜è®¤æ ‡ç­¾å·²æ·»åŠ å¹¶åŒæ­¥åˆ°æ•°æ®åº“');
                }, 200);
                
            } catch (error) {
                console.error('âŒ æ·»åŠ é»˜è®¤æ ‡ç­¾å¤±è´¥:', error);
            }
        }
        
        // ä»è„‘å›¾åŒæ­¥åˆ°æ ‡ç­¾æ•°æ®åº“
        function syncMindmapToTagDatabase() {
            if (!mindmaps.knowledge) return;
            
            try {
                // è·å–å„ä¸ªåˆ†ç±»çš„å­èŠ‚ç‚¹
                var newTagDatabase = {
                    categories: getTagsFromCategory('category_tags'),
                    technical: getTagsFromCategory('technical_tags'),
                    status: getTagsFromCategory('status_tags'),
                    custom: getTagsFromCategory('custom_tags')
                };
                
                // æ›´æ–°æ ‡ç­¾æ•°æ®åº“
                tagDatabase = newTagDatabase;
                
                // ä¿å­˜åˆ°localStorage
                saveTagDatabase();
                
                console.log('ğŸ”„ è„‘å›¾å˜åŒ–å·²åŒæ­¥åˆ°æ ‡ç­¾æ•°æ®åº“:', tagDatabase);
                
            } catch (error) {
                console.error('âŒ åŒæ­¥è„‘å›¾åˆ°æ ‡ç­¾æ•°æ®åº“å¤±è´¥:', error);
            }
        }
        
        // è·å–æŒ‡å®šåˆ†ç±»çš„æ‰€æœ‰æ ‡ç­¾
        function getTagsFromCategory(categoryId) {
            var categoryNode = mindmaps.knowledge.get_node(categoryId);
            if (!categoryNode || !categoryNode.children) return [];
            
            return categoryNode.children.map(child => child.topic).filter(topic => topic && topic.trim());
        }
        
                 // è·å–æ‰€æœ‰å¯ç”¨æ ‡ç­¾ï¼ˆä¾›è¯¦æƒ…é¡µä½¿ç”¨ï¼‰
         function getAllAvailableTags() {
             return {
                 categories: [...tagDatabase.categories],
                 technical: [...tagDatabase.technical],
                 status: [...tagDatabase.status],
                 custom: [...tagDatabase.custom]
             };
         }
         
         // è·å–å¯ç”¨æ ‡ç­¾é€‰é¡¹HTML
         function getAvailableTagOptions(tagType) {
             if (!tagDatabase[tagType]) return '';
             
             return tagDatabase[tagType].map(tag => 
                 `<option value="${tag}">${tag}</option>`
             ).join('');
         }
         
         // ä»ä¸‹æ‹‰é€‰æ‹©æ·»åŠ æ ‡ç­¾ï¼ˆå·²åºŸå¼ƒ - ç•Œé¢ç®€åŒ–ï¼‰
         function addTagFromSelect(nodeId, tagType) {
             // åŠŸèƒ½å·²ç§»é™¤ï¼Œä½¿ç”¨æ ‡ç­¾åŒæ­¥æŒ‰é’®ä»£æ›¿
             showMessage('è¯·ä½¿ç”¨"æ ‡ç­¾åŒæ­¥"æŒ‰é’®ä»æ ‡ç­¾ç®¡ç†è„‘å›¾åŒæ­¥æ ‡ç­¾');
         }
         
         // æ·»åŠ èŠ‚ç‚¹æ ‡ç­¾ï¼ˆé‡å‘½ååŸaddTagå‡½æ•°ï¼‰
         function addNodeTag(nodeId, tagType, tagValue) {
            if (!tagValue || !tagValue.trim()) return;
            
            tagValue = tagValue.trim();
            
             // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒæ ‡ç­¾
            if (nodeDatabase[nodeId].tags[tagType].includes(tagValue)) {
                 showMessage('æ ‡ç­¾å·²å­˜åœ¨ï¼š' + tagValue);
                return;
            }
            
             // æ·»åŠ æ ‡ç­¾
            nodeDatabase[nodeId].tags[tagType].push(tagValue);
            
             // æ›´æ–°ä¿®æ”¹æ—¶é—´
            nodeDatabase[nodeId].time.modified = new Date().toLocaleString();
            
             showMessage('å·²æ·»åŠ ' + getTagTypeLabel(tagType) + 'ï¼š' + tagValue);
            
             // åˆ·æ–°è¯¦æƒ…æ˜¾ç¤º
             renderDetailInfo(nodeId);
             
             // è‡ªåŠ¨ä¿å­˜
            setTimeout(autoSaveData, 200);
        }
        
         // åˆ é™¤èŠ‚ç‚¹æ ‡ç­¾ï¼ˆé‡å‘½ååŸremoveTagå‡½æ•°ï¼‰
         function removeNodeTag(nodeId, tagType, tagValue) {
             var index = nodeDatabase[nodeId].tags[tagType].indexOf(tagValue);
             if (index > -1) {
                 nodeDatabase[nodeId].tags[tagType].splice(index, 1);
                 nodeDatabase[nodeId].time.modified = new Date().toLocaleString();
                 
                 showMessage('å·²åˆ é™¤' + getTagTypeLabel(tagType) + 'ï¼š' + tagValue);
                 
                 // åˆ·æ–°è¯¦æƒ…æ˜¾ç¤º
                 renderDetailInfo(nodeId);
                 
                 // è‡ªåŠ¨ä¿å­˜
                 setTimeout(autoSaveData, 200);
             }
         }
         
                 // ğŸ¯ å…¨å±€æ ‡ç­¾åŒæ­¥å‡½æ•° - ä¾›PyQtè°ƒç”¨
        window.syncTagsFromMindmap = function(nodeId) {
            return syncTagsFromMindmapInternal(nodeId);
        };
        
        // ğŸ¯ æµ‹è¯•å‡½æ•° - åŒæ­¥å½“å‰é€‰ä¸­èŠ‚ç‚¹çš„æ ‡ç­¾
        window.testTagSync = function() {
            var selectedNode = getCurrentJsMind().get_selected_node();
            if (selectedNode) {
                console.log('ğŸ§ª æµ‹è¯•æ ‡ç­¾åŒæ­¥ï¼Œé€‰ä¸­èŠ‚ç‚¹:', selectedNode.topic);
                return syncTagsFromMindmapInternal(selectedNode.id);
            } else {
                console.log('âŒ è¯·å…ˆé€‰ä¸­ä¸€ä¸ªèŠ‚ç‚¹');
                showMessage('âŒ è¯·å…ˆé€‰ä¸­ä¸€ä¸ªèŠ‚ç‚¹');
                return false;
            }
        };
        
        // ğŸ”„ æ ‡ç­¾åŒæ­¥åŠŸèƒ½ - ä»è„‘å›¾ç®¡ç†æŒ‰é”®ç»„è°ƒç”¨
        window.syncCurrentNodeTags = function() {
            var jm = getCurrentJsMind();
            var selectedNode = jm.get_selected_node();
            
            if (!selectedNode) {
                showMessage('âŒ è¯·å…ˆé€‰æ‹©ä¸€ä¸ªèŠ‚ç‚¹');
                return;
            }
            
            // è°ƒç”¨æ ‡ç­¾åŒæ­¥å‡½æ•°
            syncTagsFromMindmapToNode(selectedNode.id);
        };

        // ğŸ”§ è°ƒè¯•æ ‡ç­¾åŒæ­¥åŠŸèƒ½
        window.debugTagSync = function() {
            console.log('ğŸ”§ å¼€å§‹è°ƒè¯•æ ‡ç­¾åŒæ­¥åŠŸèƒ½...');
            
            try {
                // 1. æ£€æŸ¥å…³é”®å‡½æ•°æ˜¯å¦å­˜åœ¨
                const requiredFunctions = [
                    'syncTagsFromMindmap',
                    'testTagSync', 
                    'syncTagsFromMindmapInternal',
                    'ensureDefaultTagsInMindmap',
                    'syncMindmapToTagDatabase',
                    'loadTagDatabase',
                    'saveTagDatabase'
                ];

                console.log('ğŸ“‹ æ£€æŸ¥å‡½æ•°å­˜åœ¨æ€§:');
                let allFunctionsExist = true;
                requiredFunctions.forEach(funcName => {
                    const exists = typeof window[funcName] === 'function';
                    console.log(`${exists ? 'âœ…' : 'âŒ'} ${funcName}: ${exists ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'}`);
                    if (!exists) allFunctionsExist = false;
                });

                // 2. æ£€æŸ¥å…¨å±€å˜é‡
                console.log('\nğŸ“Š æ£€æŸ¥å…¨å±€å˜é‡:');
                const globalVars = ['tagDatabase', 'nodeDatabase', 'mindmaps', 'currentMindmap'];
                globalVars.forEach(varName => {
                    const exists = typeof window[varName] !== 'undefined';
                    console.log(`${exists ? 'âœ…' : 'âŒ'} ${varName}: ${exists ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'}`);
                    if (exists && varName === 'tagDatabase') {
                        console.log('   ğŸ“ tagDatabaseå†…å®¹:', window[varName]);
                    }
                });

                // 3. æ£€æŸ¥æ ‡ç­¾ç®¡ç†è„‘å›¾
                console.log('\nğŸ·ï¸ æ£€æŸ¥æ ‡ç­¾ç®¡ç†è„‘å›¾:');
                if (window.mindmaps && window.mindmaps.knowledge) {
                    console.log('âœ… æ ‡ç­¾ç®¡ç†è„‘å›¾å­˜åœ¨');
                    
                    const categoryNodes = ['category_tags', 'technical_tags', 'status_tags', 'custom_tags'];
                    categoryNodes.forEach(nodeId => {
                        const node = window.mindmaps.knowledge.get_node(nodeId);
                        if (node) {
                            const childCount = node.children ? node.children.length : 0;
                            console.log(`   ğŸ“‚ ${nodeId}: ${childCount} ä¸ªå­æ ‡ç­¾`);
                            if (node.children && node.children.length > 0) {
                                const tags = node.children.map(child => child.topic).slice(0, 3);
                                console.log(`      æ ‡ç­¾ç¤ºä¾‹: ${tags.join(', ')}${childCount > 3 ? '...' : ''}`);
                            }
                        } else {
                            console.log(`   âŒ ${nodeId}: èŠ‚ç‚¹ä¸å­˜åœ¨`);
                        }
                    });
                } else {
                    console.log('âŒ æ ‡ç­¾ç®¡ç†è„‘å›¾ä¸å­˜åœ¨');
                }

                // 4. ğŸ¯ ä¿®å¤ï¼šç¡®ä¿åœ¨æ ‡ç­¾ç®¡ç†è„‘å›¾ä¸­è¿›è¡Œæµ‹è¯•
                console.log('\nğŸ§ª æµ‹è¯•æ ‡ç­¾åŒæ­¥åŠŸèƒ½:');
                
                // é¦–å…ˆç¡®ä¿æˆ‘ä»¬åœ¨æ ‡ç­¾ç®¡ç†è„‘å›¾ä¸­
                if (currentMindmap !== 'knowledge') {
                    console.log('ğŸ”„ åˆ‡æ¢åˆ°æ ‡ç­¾ç®¡ç†è„‘å›¾è¿›è¡Œæµ‹è¯•...');
                    switchMindmapTab('knowledge');
                    
                    // ç­‰å¾…åˆ‡æ¢å®Œæˆåç»§ç»­æµ‹è¯•
                    setTimeout(() => {
                        performTagSyncTest(allFunctionsExist);
                    }, 600);
                } else {
                    performTagSyncTest(allFunctionsExist);
                }
                
            } catch (error) {
                console.error('âŒ è°ƒè¯•è¿‡ç¨‹å‡ºé”™:', error);
                showMessage('âŒ è°ƒè¯•è¿‡ç¨‹å‡ºé”™: ' + error.message);
            }
        };
        
        // ğŸ¯ æ‰§è¡Œæ ‡ç­¾åŒæ­¥æµ‹è¯•çš„è¾…åŠ©å‡½æ•°
        function performTagSyncTest(allFunctionsExist) {
            try {
                if (typeof window.testTagSync === 'function') {
                    // åœ¨æ ‡ç­¾ç®¡ç†è„‘å›¾ä¸­é€‰æ‹©ä¸€ä¸ªåˆ†ç±»èŠ‚ç‚¹è¿›è¡Œæµ‹è¯•
                    if (window.mindmaps && window.mindmaps.knowledge) {
                        const root = window.mindmaps.knowledge.get_root();
                        if (root && root.children && root.children.length > 0) {
                            // é€‰æ‹©ç¬¬ä¸€ä¸ªåˆ†ç±»èŠ‚ç‚¹ï¼ˆå¦‚åˆ†ç±»æ ‡ç­¾ï¼‰
                            const testNode = root.children[0];
                            window.mindmaps.knowledge.select_node(testNode.id);
                            console.log(`âœ… å·²é€‰ä¸­æ ‡ç­¾ç®¡ç†æµ‹è¯•èŠ‚ç‚¹: ${testNode.topic}`);
                            
                            // ğŸ¯ ç¡®ä¿èŠ‚ç‚¹æ•°æ®å­˜åœ¨
                            if (!nodeDatabase[testNode.id]) {
                                nodeDatabase[testNode.id] = {
                                    id: testNode.id,
                                    title: testNode.topic,
                                    content: 'æ ‡ç­¾åˆ†ç±»èŠ‚ç‚¹',
                                    relations: {
                                        parent: testNode.parent ? testNode.parent.id : null,
                                        children: testNode.children ? testNode.children.map(child => child.id) : []
                                    },
                                    tags: {
                                        categories: [],
                                        technical: [],
                                        status: [],
                                        custom: []
                                    },
                                    time: {
                                        created: new Date().toLocaleString(),
                                        modified: new Date().toLocaleString()
                                    },
                                    author: 'ç³»ç»Ÿ'
                                };
                                console.log('âœ… å·²åˆ›å»ºæµ‹è¯•èŠ‚ç‚¹æ•°æ®');
                            }
                            
                            // æ‰§è¡Œæ ‡ç­¾åŒæ­¥æµ‹è¯•
                            const result = window.testTagSync();
                            console.log(`ğŸ”„ æ ‡ç­¾åŒæ­¥æµ‹è¯•ç»“æœ: ${result ? 'æˆåŠŸ' : 'å¤±è´¥'}`);
                            
                            // ğŸ¯ å¼ºåˆ¶åˆ·æ–°è¯¦æƒ…é¢æ¿æ˜¾ç¤º
                            setTimeout(() => {
                                showNodeDetails(testNode.id);
                                sendNodeDetailsToQt(testNode.id);
                            }, 300);
                            
                            showMessage(`ğŸ”§ è°ƒè¯•å®Œæˆï¼${allFunctionsExist ? 'æ‰€æœ‰å‡½æ•°æ­£å¸¸' : 'éƒ¨åˆ†å‡½æ•°ç¼ºå¤±'}ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°è¯¦æƒ…`);
                        } else {
                            console.log('âŒ æ ‡ç­¾ç®¡ç†è„‘å›¾æ²¡æœ‰å¯ç”¨çš„æµ‹è¯•èŠ‚ç‚¹');
                            showMessage('âŒ æ ‡ç­¾ç®¡ç†è„‘å›¾æ²¡æœ‰å¯ç”¨çš„æµ‹è¯•èŠ‚ç‚¹');
                        }
                    } else {
                        console.log('âŒ æ ‡ç­¾ç®¡ç†è„‘å›¾ä¸å­˜åœ¨');
                        showMessage('âŒ æ ‡ç­¾ç®¡ç†è„‘å›¾ä¸å­˜åœ¨');
                    }
                } else {
                    console.log('âŒ testTagSyncå‡½æ•°ä¸å­˜åœ¨');
                    showMessage('âŒ testTagSyncå‡½æ•°ä¸å­˜åœ¨');
                }
                
                console.log('\nğŸ¯ è°ƒè¯•å®Œæˆï¼');
                
            } catch (error) {
                console.error('âŒ æ ‡ç­¾åŒæ­¥æµ‹è¯•å¤±è´¥:', error);
                showMessage('âŒ æ ‡ç­¾åŒæ­¥æµ‹è¯•å¤±è´¥: ' + error.message);
            }
        }
        
        // ä»æ ‡ç­¾è„‘å›¾åŒæ­¥æ ‡ç­¾åˆ°å½“å‰èŠ‚ç‚¹
        function syncTagsFromMindmapInternal(nodeId) {
            try {
                console.log('ğŸ”„ å¼€å§‹æ ‡ç­¾åŒæ­¥ï¼ŒèŠ‚ç‚¹ID:', nodeId);
                
                // ğŸ¯ é¦–å…ˆç¡®ä¿èŠ‚ç‚¹æ•°æ®å­˜åœ¨
                if (!nodeDatabase[nodeId]) {
                    console.log('ğŸ”§ èŠ‚ç‚¹æ•°æ®ä¸å­˜åœ¨ï¼Œæ­£åœ¨åˆ›å»º...');
                    var node = getCurrentJsMind().get_node(nodeId);
                    if (!node) {
                        console.error('âŒ æ— æ³•æ‰¾åˆ°èŠ‚ç‚¹:', nodeId);
                        showMessage('âŒ æ— æ³•æ‰¾åˆ°èŠ‚ç‚¹');
                        return false;
                    }
                    
                    // åˆ›å»ºèŠ‚ç‚¹æ•°æ®
                    nodeDatabase[nodeId] = {
                        id: nodeId,
                        title: node.topic,
                        content: '',
                        relations: {
                            parent: node.parent ? node.parent.id : null,
                            children: node.children ? node.children.map(child => child.id) : []
                        },
                        tags: {
                            categories: [],
                            technical: [],
                            status: [],
                            custom: []
                        },
                        time: {
                            created: new Date().toLocaleString(),
                            modified: new Date().toLocaleString()
                        },
                        author: ''
                    };
                    console.log('âœ… èŠ‚ç‚¹æ•°æ®å·²åˆ›å»º');
                }
                
                // ç¡®ä¿æ ‡ç­¾æ•°æ®åº“æ˜¯æœ€æ–°çš„
                syncMindmapToTagDatabase();
                
                console.log('ğŸ“Š å½“å‰æ ‡ç­¾æ•°æ®åº“çŠ¶æ€:', tagDatabase);
                console.log('ğŸ¯ å½“å‰èŠ‚ç‚¹æ•°æ®:', nodeDatabase[nodeId]);
                
                // æ¸…ç©ºå½“å‰èŠ‚ç‚¹çš„æ‰€æœ‰æ ‡ç­¾
                nodeDatabase[nodeId].tags = {
                    categories: [],
                    technical: [],
                    status: [],
                    custom: []
                };
                
                // ä»æ ‡ç­¾æ•°æ®åº“åŒæ­¥æ‰€æœ‰å¯ç”¨æ ‡ç­¾åˆ°å½“å‰èŠ‚ç‚¹
                var syncedCount = 0;
                
                // åŒæ­¥åˆ†ç±»æ ‡ç­¾
                if (tagDatabase.categories && tagDatabase.categories.length > 0) {
                    nodeDatabase[nodeId].tags.categories = [...tagDatabase.categories];
                    syncedCount += tagDatabase.categories.length;
                    console.log('ğŸ“‚ åŒæ­¥åˆ†ç±»æ ‡ç­¾:', tagDatabase.categories.length, 'ä¸ª');
                }
                
                // åŒæ­¥æŠ€æœ¯æ ‡ç­¾
                if (tagDatabase.technical && tagDatabase.technical.length > 0) {
                    nodeDatabase[nodeId].tags.technical = [...tagDatabase.technical];
                    syncedCount += tagDatabase.technical.length;
                    console.log('âš™ï¸ åŒæ­¥æŠ€æœ¯æ ‡ç­¾:', tagDatabase.technical.length, 'ä¸ª');
                }
                
                // åŒæ­¥çŠ¶æ€æ ‡ç­¾
                if (tagDatabase.status && tagDatabase.status.length > 0) {
                    nodeDatabase[nodeId].tags.status = [...tagDatabase.status];
                    syncedCount += tagDatabase.status.length;
                    console.log('ğŸ“Š åŒæ­¥çŠ¶æ€æ ‡ç­¾:', tagDatabase.status.length, 'ä¸ª');
                }
                
                // åŒæ­¥è‡ªå®šä¹‰æ ‡ç­¾
                if (tagDatabase.custom && tagDatabase.custom.length > 0) {
                    nodeDatabase[nodeId].tags.custom = [...tagDatabase.custom];
                    syncedCount += tagDatabase.custom.length;
                    console.log('ğŸ¨ åŒæ­¥è‡ªå®šä¹‰æ ‡ç­¾:', tagDatabase.custom.length, 'ä¸ª');
                }
                
                // æ›´æ–°ä¿®æ”¹æ—¶é—´
                nodeDatabase[nodeId].time.modified = new Date().toLocaleString();
                
                console.log('ğŸ”„ åŒæ­¥åèŠ‚ç‚¹æ ‡ç­¾:', nodeDatabase[nodeId].tags);
                
                // åˆ·æ–°è¯¦æƒ…é¡µæ˜¾ç¤º
                renderDetailInfo(nodeId);
                
                // è‡ªåŠ¨ä¿å­˜
                setTimeout(autoSaveData, 200);
                
                showMessage(`âœ… æ ‡ç­¾åŒæ­¥å®Œæˆï¼å·²åŒæ­¥ ${syncedCount} ä¸ªæ ‡ç­¾åˆ°å½“å‰èŠ‚ç‚¹`);
                
                console.log('âœ… æ ‡ç­¾åŒæ­¥å®Œæˆ:', {
                    nodeId: nodeId,
                    syncedTags: nodeDatabase[nodeId].tags,
                    totalCount: syncedCount
                });
                
            } catch (error) {
                console.error('âŒ æ ‡ç­¾åŒæ­¥å¤±è´¥:', error);
                showMessage('âŒ æ ‡ç­¾åŒæ­¥å¤±è´¥: ' + error.message);
            }
        }
        function getTagTypeLabel(tagType) {
            switch(tagType) {
                case 'categories': return 'åˆ†ç±»æ ‡ç­¾';
                case 'technical': return 'æŠ€æœ¯æ ‡ç­¾';
                case 'status': return 'çŠ¶æ€æ ‡ç­¾';
                default: return 'æ ‡ç­¾';
            }
        }
        
        // ç§»é™¤æ ‡ç­¾
        function removeTag(nodeId, tagType, tagValue) {
            // ä»æ•°ç»„ä¸­ç§»é™¤æ ‡ç­¾
            var index = nodeDatabase[nodeId].tags[tagType].indexOf(tagValue);
            if (index !== -1) {
                nodeDatabase[nodeId].tags[tagType].splice(index, 1);
            }
            
            // æ›´æ–°ä¿®æ”¹æ—¶é—´
            nodeDatabase[nodeId].time.modified = new Date().toLocaleString();
            
            showMessage('å·²ç§»é™¤' + getTagTypeLabel(tagType) + 'ï¼š' + tagValue);
            
            // åˆ·æ–°å½“å‰é€‰é¡¹å¡å†…å®¹
            var activeTab = document.querySelector('.tab-content.active');
            if (activeTab) {
                var tabName = activeTab.id.replace('tab-', '');
                refreshTabContent(tabName, nodeId);
            }
            
            // è‡ªåŠ¨ä¿å­˜
            setTimeout(autoSaveData, 200);
        }
        
        // æ›´æ–°èŠ‚ç‚¹å…³ç³»
        function updateNodeRelations(nodeId) {
            var node = jm.get_node(nodeId);
            if (!node || !nodeDatabase[nodeId]) return;
            
            // æ›´æ–°çˆ¶èŠ‚ç‚¹å…³ç³»
            nodeDatabase[nodeId].relations.parent = node.parent ? node.parent.id : null;
            
            // æ›´æ–°å­èŠ‚ç‚¹å…³ç³»
            nodeDatabase[nodeId].relations.children = node.children ? node.children.map(child => child.id) : [];
            
            // å¦‚æœå½“å‰èŠ‚ç‚¹æ˜¯é€‰ä¸­èŠ‚ç‚¹ï¼Œæ›´æ–°æ˜¾ç¤º
            var selected = jm.get_selected_node();
            if (selected && selected.id === nodeId) {
                showNodeDetails(nodeId);
            }
        }
        
        // è·å–èŠ‚ç‚¹è·¯å¾„
        function getNodePath(node) {
            var path = [];
            var current = node;
            
            while (current) {
                path.unshift(`<span>${current.topic}</span>`);
                current = current.parent;
            }
            
            return path;
        }
        
        // è·å–èŠ‚ç‚¹çš„è‡ªå®šä¹‰å±æ€§
        function getCustomProperties(node) {
            var props = [];
            var standardProps = ['id', 'topic', 'direction', 'expanded', 'parent', 'children', 'data', '_data', 'isroot'];
            
            for (var key in node) {
                if (node.hasOwnProperty(key) && !standardProps.includes(key)) {
                    var value = node[key];
                    if (typeof value !== 'function' && typeof value !== 'object') {
                        props.push({
                            key: key,
                            value: value
                        });
                    }
                }
            }
            
            return props;
        }

        // è®¾ç½®è‡ªåŠ¨ä¿å­˜
        function setupAutoSave() {
            // å®šæœŸè‡ªåŠ¨ä¿å­˜ï¼ˆæ¯30ç§’ï¼‰
            setInterval(function() {
                autoSaveCurrentNodeDetails(); // ä¿å­˜å½“å‰ç¼–è¾‘å†…å®¹
                autoSaveData();
            }, 30000);
            
            // é¡µé¢ç¦»å¼€æ—¶ä¿å­˜
            window.addEventListener('beforeunload', function() {
                autoSaveCurrentNodeDetails(); // ä¿å­˜å½“å‰ç¼–è¾‘å†…å®¹
                autoSaveData();
            });
            
            // é¡µé¢å¤±å»ç„¦ç‚¹æ—¶ä¿å­˜
            window.addEventListener('blur', function() {
                autoSaveCurrentNodeDetails(); // ä¿å­˜å½“å‰ç¼–è¾‘å†…å®¹
                autoSaveData();
            });
        }

        // å½“å‰æ­£åœ¨ç¼–è¾‘çš„èŠ‚ç‚¹IDï¼ˆç”¨äºè‡ªåŠ¨ä¿å­˜ï¼‰
        var currentEditingNodeId = null;
        
        // ğŸ¯ ä¿®å¤ç‰ˆï¼šå…¼å®¹ç»Ÿä¸€æ•°æ®ç»“æ„å’ŒnodeDatabaseçš„è‡ªåŠ¨ä¿å­˜æœºåˆ¶
        function autoSaveCurrentNodeDetails() {
            if (!currentEditingNodeId) return;
            
            try {
                var node = getCurrentJsMind().get_node(currentEditingNodeId);
                if (!node) return;
                
                // ç¡®ä¿nodeDatabaseä¸­æœ‰èŠ‚ç‚¹æ•°æ®ï¼ˆä¿æŒå‘åå…¼å®¹ï¼‰
                if (!nodeDatabase[currentEditingNodeId]) {
                    nodeDatabase[currentEditingNodeId] = {
                        id: currentEditingNodeId,
                        title: node.topic,
                        content: '',
                        relations: {
                            parent: node.parent ? node.parent.id : null,
                            children: node.children ? node.children.map(child => child.id) : []
                        },
                        tags: { categories: [], technical: [], status: [] },
                        time: { created: new Date().toLocaleString(), modified: new Date().toLocaleString() },
                        author: ''
                    };
                }
                
                // åŒæ—¶ç¡®ä¿node.dataå­˜åœ¨ï¼ˆæ–°çš„ç»Ÿä¸€æ•°æ®ç»“æ„ï¼‰
                if (!node.data) {
                    node.data = {
                        content: nodeDatabase[currentEditingNodeId].content || '',
                        summary: '',
                        author: nodeDatabase[currentEditingNodeId].author || '',
                        tags: { 
                            categories: nodeDatabase[currentEditingNodeId].tags.categories || [], 
                            technical: nodeDatabase[currentEditingNodeId].tags.technical || [], 
                            status: nodeDatabase[currentEditingNodeId].tags.status || [],
                            priority: '', 
                            custom: [] 
                        },
                        time: { 
                            created: nodeDatabase[currentEditingNodeId].time.created || new Date().toISOString(), 
                            modified: nodeDatabase[currentEditingNodeId].time.modified || new Date().toISOString() 
                        },
                        relations: nodeDatabase[currentEditingNodeId].relations || { references: [], dependencies: [], links: [] },
                        metadata: { version: '1.0', source: 'manual', confidence: 1.0 },
                        collaboration: { assignee: '', reviewers: [], comments: [], attachments: [] },
                        flags: { isComplete: false, isArchived: false, hasUnsavedChanges: false }
                    };
                }
                
                var titleEl = document.getElementById('node_title_' + currentEditingNodeId);
                var contentEl = document.getElementById('node_content_' + currentEditingNodeId);
                var authorEl = document.getElementById('node_author_' + currentEditingNodeId);
                
                if (titleEl && contentEl && authorEl) {
                    var hasChanges = false;
                    
                    // æ£€æŸ¥å¹¶æ›´æ–°æ ‡é¢˜
                    if (titleEl.value !== nodeDatabase[currentEditingNodeId].title) {
                        nodeDatabase[currentEditingNodeId].title = titleEl.value;
                        getCurrentJsMind().update_node(currentEditingNodeId, titleEl.value);
                        hasChanges = true;
                        
                        // åŒæ­¥æ›´æ–°æ‰€æœ‰å·¥ä½œåŒºä¸­çš„ç›¸åŒèŠ‚ç‚¹æ ‡é¢˜
                        Object.keys(mindmaps).forEach(function(tabName) {
                            var mindmap = mindmaps[tabName];
                            var targetNode = mindmap.get_node(currentEditingNodeId);
                            if (targetNode && targetNode.topic !== titleEl.value) {
                                mindmap.update_node(currentEditingNodeId, titleEl.value);
                            }
                        });
                    }
                    
                    // æ£€æŸ¥å¹¶æ›´æ–°è¯¦ç»†å†…å®¹ï¼ˆåŒæ—¶ä¿å­˜åˆ°ä¸¤å¤„ï¼‰
                    if (contentEl.value !== nodeDatabase[currentEditingNodeId].content) {
                        nodeDatabase[currentEditingNodeId].content = contentEl.value;
                        node.data.content = contentEl.value;
                        hasChanges = true;
                    }
                    
                    // æ£€æŸ¥å¹¶æ›´æ–°ä½œè€…ï¼ˆåŒæ—¶ä¿å­˜åˆ°ä¸¤å¤„ï¼‰
                    if (authorEl.value !== nodeDatabase[currentEditingNodeId].author) {
                        nodeDatabase[currentEditingNodeId].author = authorEl.value;
                        node.data.author = authorEl.value;
                        hasChanges = true;
                    }
                    
                    if (hasChanges) {
                        // æ›´æ–°æ—¶é—´æˆ³
                        nodeDatabase[currentEditingNodeId].time.modified = new Date().toLocaleString();
                        node.data.time.modified = new Date().toISOString();
                        node.data.flags.hasUnsavedChanges = false;
                        
                        console.log('ğŸ”„ å…¼å®¹ç‰ˆè‡ªåŠ¨ä¿å­˜:', currentEditingNodeId, 'å†…å®¹é•¿åº¦:', contentEl.value.length);
                        
                        // è§¦å‘æŒä¹…åŒ–å­˜å‚¨
                        setTimeout(autoSaveData, 100);
                    }
                }
            } catch (error) {
                console.error('å…¼å®¹ç‰ˆè‡ªåŠ¨ä¿å­˜å¤±è´¥:', error);
            }
        }

        // ä¸ºæ‰€æœ‰è„‘å›¾å®ä¾‹æ·»åŠ äº‹ä»¶ç›‘å¬
        function addEventListenersToAllMindmaps() {
            Object.keys(mindmaps).forEach(function(tabName) {
                var mindmap = mindmaps[tabName];
                
                mindmap.add_event_listener(function(type, data) {
                    // ç¡®ä¿å½“å‰è„‘å›¾æ ‡ç­¾è¢«æ¿€æ´»
                    if (currentMindmap !== tabName) {
                        switchMindmapTab(tabName);
                    }
                    
                    if (type === 'select_node') {
                        // åœ¨åˆ‡æ¢åˆ°æ–°èŠ‚ç‚¹å‰ï¼Œå…ˆè‡ªåŠ¨ä¿å­˜å½“å‰ç¼–è¾‘èŠ‚ç‚¹çš„è¯¦ç»†å†…å®¹
                        autoSaveCurrentNodeDetails();
                        
                        updateSelectedNodeDisplay();
                        showNodeDetails(data.node.id);
                        console.log('é€‰ä¸­' + tabName + 'èŠ‚ç‚¹:', data.node.topic);
                        // è‡ªåŠ¨ä¿å­˜é€‰ä¸­çŠ¶æ€
                        setTimeout(autoSaveData, 100);
                    } else if (type === 'edit_node') {
                        showNodeDetails(data.node.id);
                        console.log('ç¼–è¾‘' + tabName + 'èŠ‚ç‚¹:', data.node.topic);
                        // è‡ªåŠ¨ä¿å­˜ç¼–è¾‘
                        setTimeout(autoSaveData, 500);
                    } else if (type === 'move_node') {
                        showMessage('ğŸ”€ èŠ‚ç‚¹å·²ç§»åŠ¨: ' + data.node.topic);
                        console.log('ç§»åŠ¨' + tabName + 'èŠ‚ç‚¹:', data.node.topic, 'åˆ°æ–°ä½ç½®');
                        updateSelectedNodeDisplay();
                        updateNodeRelations(data.node.id);
                        if (data.parent_node) {
                            updateNodeRelations(data.parent_node.id);
                        }
                        // è‡ªåŠ¨ä¿å­˜ç§»åŠ¨æ“ä½œ
                        setTimeout(autoSaveData, 200);
                    } else if (type === 'add_node') {
                        updateNodeRelations(data.node.id);
                        if (data.parent_node) {
                            updateNodeRelations(data.parent_node.id);
                        }
                        showNodeDetails(data.node.id);
                        // è‡ªåŠ¨ä¿å­˜æ–°å¢èŠ‚ç‚¹
                        setTimeout(autoSaveData, 200);
                    } else if (type === 'remove_node') {
                        if (data.parent_node) {
                            updateNodeRelations(data.parent_node.id);
                        }
                        // è‡ªåŠ¨ä¿å­˜åˆ é™¤æ“ä½œ
                        setTimeout(autoSaveData, 200);
                    }
                });
            });
        }
        
        // ä¸ºæ‰€æœ‰è„‘å›¾æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
        addEventListenersToAllMindmaps();
        
        // ğŸ¯ ä¿®å¤ï¼šæ³¨é‡Šæ‰æœªå®šä¹‰çš„initVirtualCenterSystemå‡½æ•°è°ƒç”¨
        // initVirtualCenterSystem();

        // æŒä¹…åŒ–å­˜å‚¨ç›¸å…³å¸¸é‡
        var STORAGE_KEYS = {
            MINDMAP_DATA: 'nodemind_mindmap_data',
            NODE_DATABASE: 'nodemind_node_database', 
            CURRENT_THEME: 'nodemind_current_theme',
            DRAG_ENABLED: 'nodemind_drag_enabled',
            SELECTED_NODE: 'nodemind_selected_node',
            VIEW_DATA: 'nodemind_view_data'
        };
        
        // ğŸ¯ ä¿®å¤ç‰ˆï¼šå…¼å®¹æ€§è‡ªåŠ¨ä¿å­˜å‡½æ•°
        function autoSaveData() {
            try {
                // ä¿å­˜æ‰€æœ‰è„‘å›¾çš„æ•°æ®
                var allMindmapData = {};
                Object.keys(mindmaps).forEach(function(tabName) {
                    if (mindmaps[tabName]) {
                        allMindmapData[tabName] = mindmaps[tabName].get_data();
                    }
                });
                
                if (Object.keys(allMindmapData).length > 0) {
                    // ä¿å­˜æ‰€æœ‰æ€ç»´å¯¼å›¾æ•°æ®
                    localStorage.setItem(STORAGE_KEYS.MINDMAP_DATA, JSON.stringify(allMindmapData));
                    
                    // ğŸ¯ ä¿æŒå…¼å®¹æ€§ï¼šç»§ç»­ä¿å­˜nodeDatabase
                    localStorage.setItem(STORAGE_KEYS.NODE_DATABASE, JSON.stringify(nodeDatabase));
                    
                    // ä¿å­˜å½“å‰ä¸»é¢˜
                    localStorage.setItem(STORAGE_KEYS.CURRENT_THEME, currentThemeIndex.toString());
                    
                    // ä¿å­˜æ‹–æ‹½çŠ¶æ€
                    localStorage.setItem(STORAGE_KEYS.DRAG_ENABLED, isDragEnabled.toString());
                    
                    // ä¿å­˜å½“å‰æ´»è·ƒçš„è„‘å›¾é€‰é¡¹å¡
                    localStorage.setItem('nodemind_current_mindmap', currentMindmap);
                    
                    // ä¿å­˜é€‰ä¸­èŠ‚ç‚¹
                    var selectedNode = getCurrentJsMind().get_selected_node();
                    if (selectedNode) {
                        localStorage.setItem(STORAGE_KEYS.SELECTED_NODE, selectedNode.id);
                    }
                    
                    console.log('âœ… æ•°æ®å·²è‡ªåŠ¨ä¿å­˜ï¼ˆå…¼å®¹æ¨¡å¼ - åŒ…å«æ‰€æœ‰è„‘å›¾ï¼‰');
                }
            } catch (error) {
                console.error('è‡ªåŠ¨ä¿å­˜å¤±è´¥:', error);
            }
        }
        
        // ğŸ”„ PyQtå‘HTMLå›ä¼ æ•°æ®çš„æ¥æ”¶å‡½æ•°ï¼ˆåŒå‘æ•°æ®åŒæ­¥çš„æ ¸å¿ƒï¼‰
        window.pyqtSaveNodeContent = function(nodeData) {
            try {
                console.log('ğŸ”„ æ¥æ”¶åˆ°PyQtæ•°æ®:', nodeData);
                
                var nodeId = nodeData.nodeId;
                var node = getCurrentJsMind().get_node(nodeId);
                
                if (!node) {
                    console.error('âŒ èŠ‚ç‚¹ä¸å­˜åœ¨:', nodeId);
                    return false;
                }
                
                var hasChanges = false;
                
                // ğŸ”§ ä¼˜å…ˆç¡®ä¿ç»Ÿä¸€æ•°æ®ç»“æ„å­˜åœ¨ - ä¿®å¤"Cannot set property 'custom' of undefined"é”™è¯¯
                if (!node.data) {
                    node.data = {
                        content: '', summary: '', author: '',
                        tags: { categories: [], technical: [], status: [], priority: '', custom: [] },
                        time: { created: new Date().toISOString(), modified: new Date().toISOString() },
                        relations: { references: [], dependencies: [], links: [] },
                        metadata: { version: '1.0', source: 'manual', confidence: 1.0 },
                        collaboration: { assignee: '', reviewers: [], comments: [], attachments: [] },
                        flags: { isComplete: false, isArchived: false, hasUnsavedChanges: false }
                    };
                    console.log('âœ… ç»Ÿä¸€æ•°æ®ç»“æ„å·²åˆå§‹åŒ–:', nodeId);
                }
                
                // ğŸ”§ ç¡®ä¿æ ‡ç­¾å¯¹è±¡ç»“æ„å®Œæ•´ï¼ˆå®¹é”™å¤„ç†ï¼‰
                if (!node.data.tags || typeof node.data.tags !== 'object') {
                    node.data.tags = { categories: [], technical: [], status: [], priority: '', custom: [] };
                }
                if (!Array.isArray(node.data.tags.categories)) node.data.tags.categories = [];
                if (!Array.isArray(node.data.tags.technical)) node.data.tags.technical = [];
                if (!Array.isArray(node.data.tags.status)) node.data.tags.status = [];
                if (!Array.isArray(node.data.tags.custom)) node.data.tags.custom = [];
                if (!node.data.tags.priority) node.data.tags.priority = '';
                
                // æ›´æ–°èŠ‚ç‚¹æ ‡é¢˜
                if (nodeData.title && node.topic !== nodeData.title) {
                    getCurrentJsMind().update_node(nodeId, nodeData.title);
                    hasChanges = true;
                    console.log('âœ… èŠ‚ç‚¹æ ‡é¢˜å·²æ›´æ–°:', nodeData.title);
                }
                
                // æ›´æ–°èŠ‚ç‚¹å†…å®¹ï¼ˆç»Ÿä¸€æ•°æ®ç»“æ„ï¼‰
                if (nodeData.content !== undefined && node.data.content !== nodeData.content) {
                    node.data.content = nodeData.content;
                    hasChanges = true;
                    console.log('âœ… èŠ‚ç‚¹å†…å®¹å·²æ›´æ–°:', nodeData.content.length + 'å­—ç¬¦');
                }
                
                // æ›´æ–°ä½œè€…ä¿¡æ¯ï¼ˆç»Ÿä¸€æ•°æ®ç»“æ„ï¼‰
                if (nodeData.author !== undefined && node.data.author !== nodeData.author) {
                    node.data.author = nodeData.author;
                    hasChanges = true;
                    console.log('âœ… èŠ‚ç‚¹ä½œè€…å·²æ›´æ–°:', nodeData.author);
                }
                
                // ğŸ·ï¸ å¢å¼ºæ ‡ç­¾ä¿¡æ¯å¤„ç†
                if (nodeData.tags && Array.isArray(nodeData.tags)) {
                    // æ›´æ–°ç»Ÿä¸€æ•°æ®ç»“æ„ä¸­çš„è‡ªå®šä¹‰æ ‡ç­¾
                    node.data.tags.custom = nodeData.tags;
                    
                    // åŒæ—¶å°†æ ‡ç­¾åˆ†ç±»åˆ°ä¸åŒç±»å‹ï¼ˆæ™ºèƒ½åˆ†ç±»ï¼‰
                    nodeData.tags.forEach(function(tag) {
                        var lowerTag = tag.toLowerCase();
                        // æŠ€æœ¯ç±»æ ‡ç­¾
                        if (['bug', 'æŠ€æœ¯', 'å¼€å‘', 'ä»£ç ', 'æµ‹è¯•', 'javascript', 'python', 'html', 'css'].some(keyword => lowerTag.includes(keyword))) {
                            if (!node.data.tags.technical.includes(tag)) {
                                node.data.tags.technical.push(tag);
                            }
                        }
                        // çŠ¶æ€ç±»æ ‡ç­¾
                        else if (['å®Œæˆ', 'è¿›è¡Œä¸­', 'å¾…åŠ', 'å·²å®Œæˆ', 'æœªå¼€å§‹', 'æš‚åœ', 'å–æ¶ˆ'].some(keyword => lowerTag.includes(keyword))) {
                            if (!node.data.tags.status.includes(tag)) {
                                node.data.tags.status.push(tag);
                            }
                        }
                        // åˆ†ç±»æ ‡ç­¾
                        else {
                            if (!node.data.tags.categories.includes(tag)) {
                                node.data.tags.categories.push(tag);
                            }
                        }
                    });
                    
                    hasChanges = true;
                    console.log('âœ… èŠ‚ç‚¹æ ‡ç­¾å·²æ›´æ–°ï¼ˆæ™ºèƒ½åˆ†ç±»ï¼‰:', {
                        custom: node.data.tags.custom,
                        technical: node.data.tags.technical,
                        status: node.data.tags.status,
                        categories: node.data.tags.categories
                    });
                }
                
                // ğŸ“… å¢å¼ºæ—¶é—´ä¿¡æ¯å¤„ç†
                var timeUpdated = false;
                
                // å¤„ç†åˆ›å»ºæ—¶é—´
                if (nodeData.createdTime && (!node.data.time.created || node.data.time.created === '')) {
                    node.data.time.created = new Date(nodeData.createdTime).toISOString();
                    timeUpdated = true;
                }
                
                // å¤„ç†ä¿®æ”¹æ—¶é—´ï¼ˆæ€»æ˜¯æ›´æ–°ï¼‰
                node.data.time.modified = new Date().toISOString();
                timeUpdated = true;
                
                // æ·»åŠ ä¿å­˜æ—¶é—´æˆ³
                if (nodeData.saveTimestamp) {
                    node.data.time.lastSaved = new Date(nodeData.saveTimestamp).toISOString();
                    timeUpdated = true;
                }
                
                if (timeUpdated) {
                    hasChanges = true;
                    console.log('âœ… èŠ‚ç‚¹æ—¶é—´ä¿¡æ¯å·²æ›´æ–°:', {
                        created: node.data.time.created,
                        modified: node.data.time.modified,
                        lastSaved: node.data.time.lastSaved || 'æœªè®¾ç½®'
                    });
                }
                
                // ğŸ¯ ä¼˜å…ˆçº§ä¿¡æ¯å¤„ç†ï¼ˆä»æ ‡ç­¾ä¸­æå–ï¼‰
                if (nodeData.tags && Array.isArray(nodeData.tags)) {
                    var priorityTags = nodeData.tags.filter(tag => 
                        ['é«˜ä¼˜å…ˆçº§', 'ä¸­ä¼˜å…ˆçº§', 'ä½ä¼˜å…ˆçº§', 'ç´§æ€¥', 'é‡è¦', 'ä¸€èˆ¬', 'é«˜', 'ä¸­', 'ä½'].includes(tag)
                    );
                    if (priorityTags.length > 0) {
                        node.data.tags.priority = priorityTags[0];
                        console.log('âœ… èŠ‚ç‚¹ä¼˜å…ˆçº§å·²æ›´æ–°:', node.data.tags.priority);
                    }
                }
                
                // ğŸ“Š å…ƒæ•°æ®ä¿¡æ¯å¤„ç†
                if (nodeData.formSource) {
                    node.data.metadata.source = nodeData.formSource;
                    hasChanges = true;
                }
                
                if (nodeData.dataComplete !== undefined) {
                    node.data.flags.hasUnsavedChanges = !nodeData.dataComplete;
                    hasChanges = true;
                }
                
                // ç»Ÿè®¡ä¿¡æ¯å¤„ç†
                if (nodeData.tagsCount !== undefined) {
                    node.data.metadata.tagsCount = nodeData.tagsCount;
                    hasChanges = true;
                }
                
                if (nodeData.hasCustomTags !== undefined) {
                    node.data.flags.hasCustomTags = nodeData.hasCustomTags;
                    hasChanges = true;
                    console.log('âœ… èŠ‚ç‚¹å…ƒæ•°æ®å·²æ›´æ–°:', {
                        source: node.data.metadata.source,
                        tagsCount: node.data.metadata.tagsCount,
                        hasCustomTags: node.data.flags.hasCustomTags
                    });
                }
                
                // ç¡®ä¿nodeDatabaseå…¼å®¹æ€§
                if (!nodeDatabase[nodeId]) {
                    nodeDatabase[nodeId] = {
                        id: nodeId,
                        title: node.topic,
                        content: '',
                        author: '',
                        tags: { categories: [], technical: [], status: [] },
                        time: { created: new Date().toLocaleString(), modified: new Date().toLocaleString() },
                        relations: {
                            parent: node.parent ? node.parent.id : null,
                            children: node.children ? node.children.map(child => child.id) : []
                        }
                    };
                }
                
                // ğŸ”„ åŒæ­¥æ›´æ–°nodeDatabaseï¼ˆä¿æŒå‘åå…¼å®¹ï¼‰
                if (nodeData.title) nodeDatabase[nodeId].title = nodeData.title;
                if (nodeData.content !== undefined) nodeDatabase[nodeId].content = nodeData.content;
                if (nodeData.author !== undefined) nodeDatabase[nodeId].author = nodeData.author;
                
                // ğŸ·ï¸ åŒæ­¥æ ‡ç­¾æ•°æ®åˆ°nodeDatabase
                if (nodeData.tags && Array.isArray(nodeData.tags)) {
                    // å°†PyQtæ ‡ç­¾æ•°ç»„åˆ†é…åˆ°ä¸åŒç±»åˆ«
                    nodeDatabase[nodeId].tags.categories = node.data.tags.categories;
                    nodeDatabase[nodeId].tags.technical = node.data.tags.technical;
                    nodeDatabase[nodeId].tags.status = node.data.tags.status;
                    console.log('âœ… nodeDatabaseæ ‡ç­¾æ•°æ®å·²åŒæ­¥');
                }
                
                // ğŸ“… åŒæ­¥æ—¶é—´ä¿¡æ¯åˆ°nodeDatabase
                nodeDatabase[nodeId].time.modified = new Date().toLocaleString();
                
                // åŒæ­¥åˆ›å»ºæ—¶é—´
                if (nodeData.createdTime && (!nodeDatabase[nodeId].time.created || nodeDatabase[nodeId].time.created === '')) {
                    nodeDatabase[nodeId].time.created = nodeData.createdTime;
                }
                
                // æ·»åŠ ä¿å­˜æ—¶é—´æˆ³
                if (nodeData.saveTimestamp) {
                    nodeDatabase[nodeId].lastSaved = nodeData.saveTimestamp;
                }
                
                // æ›´æ–°ç»Ÿä¸€æ•°æ®ç»“æ„æ—¶é—´æˆ³
                node.data.time.modified = new Date().toISOString();
                
                if (hasChanges) {
                    // è§¦å‘è‡ªåŠ¨ä¿å­˜
                    autoSaveData();
                    
                    // åˆ·æ–°å½“å‰æ˜¾ç¤ºçš„èŠ‚ç‚¹è¯¦æƒ…ï¼ˆå¦‚æœæ˜¯å½“å‰ç¼–è¾‘çš„èŠ‚ç‚¹ï¼‰
                    if (currentEditingNodeId === nodeId) {
                        // æ›´æ–°è¡¨å•æ˜¾ç¤ºï¼ˆä¸ä¼šè§¦å‘å¾ªç¯ä¿å­˜ï¼‰
                        var titleEl = document.getElementById('node_title_' + nodeId);
                        var contentEl = document.getElementById('node_content_' + nodeId);
                        var authorEl = document.getElementById('node_author_' + nodeId);
                        
                        if (titleEl && nodeData.title) titleEl.value = nodeData.title;
                        if (contentEl && nodeData.content !== undefined) contentEl.value = nodeData.content;
                        if (authorEl && nodeData.author !== undefined) authorEl.value = nodeData.author;
                    }
                    
                    console.log('âœ… PyQtæ•°æ®ä¿å­˜å®Œæˆï¼ŒèŠ‚ç‚¹:', nodeId);
                    showMessage('ğŸ’¾ PyQtæ•°æ®å·²ä¿å­˜åˆ°èŠ‚ç‚¹');
                    return true;
                } else {
                    console.log('â„¹ï¸ æ— å˜åŒ–ï¼Œè·³è¿‡ä¿å­˜');
                    return false;
                }
                
            } catch (error) {
                console.error('âŒ PyQtæ•°æ®ä¿å­˜å¤±è´¥:', error);
                return false;
            }
        };
        
        // é€’å½’è®¡ç®—èŠ‚ç‚¹æ•°é‡
        function countNodes(nodeData) {
            if (!nodeData) return 0;
            var count = 1;
            if (nodeData.children) {
                nodeData.children.forEach(function(child) {
                    count += countNodes(child);
                });
            }
            return count;
        }
        
        // åŠ è½½ä¿å­˜çš„æ•°æ®
        function loadSavedData() {
            try {
                // åŠ è½½æ€ç»´å¯¼å›¾æ•°æ®
                var savedMindmapData = localStorage.getItem(STORAGE_KEYS.MINDMAP_DATA);
                var savedNodeDatabase = localStorage.getItem(STORAGE_KEYS.NODE_DATABASE);
                var savedTheme = localStorage.getItem(STORAGE_KEYS.CURRENT_THEME);
                var savedDragState = localStorage.getItem(STORAGE_KEYS.DRAG_ENABLED);
                var savedSelectedNode = localStorage.getItem(STORAGE_KEYS.SELECTED_NODE);
                var savedCurrentMindmap = localStorage.getItem('nodemind_current_mindmap');
                
                var hasRecoveredData = false;
                
                // æ¢å¤å¤šå·¥ä½œåŒºæ€ç»´å¯¼å›¾æ•°æ®
                if (savedMindmapData) {
                    try {
                        var allMindmapData = JSON.parse(savedMindmapData);
                        
                        // æ¢å¤æ¯ä¸ªå·¥ä½œåŒºçš„æ•°æ®
                        if (allMindmapData && typeof allMindmapData === 'object') {
                            Object.keys(allMindmapData).forEach(function(tabName) {
                                var mindmapData = allMindmapData[tabName];
                                if (mindmapData && mindmapData.data && mindmaps[tabName]) {
                                    mindmaps[tabName].show(mindmapData);
                                    hasRecoveredData = true;
                                    console.log('âœ… ' + tabName + ' å·¥ä½œåŒºæ•°æ®å·²æ¢å¤');
                                }
                            });
                            
                            // æ¢å¤å½“å‰æ´»è·ƒå·¥ä½œåŒº
                            if (savedCurrentMindmap && mindmaps[savedCurrentMindmap]) {
                                currentMindmap = savedCurrentMindmap;
                                switchMindmapTab(currentMindmap);
                                console.log('âœ… å½“å‰å·¥ä½œåŒºå·²æ¢å¤ä¸º:', currentMindmap);
                            }
                        }
                    } catch (e) {
                        console.error('æ€ç»´å¯¼å›¾æ•°æ®æ¢å¤å¤±è´¥:', e);
                    }
                }
                
                // æ¢å¤èŠ‚ç‚¹è¯¦ç»†ä¿¡æ¯æ•°æ®åº“ï¼ˆæ¢å¤å…¼å®¹æ€§ï¼‰
                if (savedNodeDatabase) {
                    try {
                        nodeDatabase = JSON.parse(savedNodeDatabase);
                        console.log('âœ… èŠ‚ç‚¹æ•°æ®åº“å·²æ¢å¤ï¼ŒåŒ…å«', Object.keys(nodeDatabase).length, 'ä¸ªèŠ‚ç‚¹è¯¦æƒ…');
                    } catch (e) {
                        console.error('èŠ‚ç‚¹æ•°æ®åº“æ¢å¤å¤±è´¥:', e);
                        nodeDatabase = {};
                    }
                }
                
                // æ¢å¤ä¸»é¢˜è®¾ç½®
                if (savedTheme) {
                    try {
                        var themeIndex = parseInt(savedTheme);
                        if (themeIndex >= 0 && themeIndex < themes.length) {
                            currentThemeIndex = themeIndex;
                            jm.set_theme(themes[currentThemeIndex].name);
                            console.log('âœ… ä¸»é¢˜è®¾ç½®å·²æ¢å¤:', themes[currentThemeIndex].label);
                        }
                    } catch (e) {
                        console.error('ä¸»é¢˜è®¾ç½®æ¢å¤å¤±è´¥:', e);
                    }
                }
                
                // æ¢å¤æ‹–æ‹½çŠ¶æ€
                if (savedDragState) {
                    try {
                        isDragEnabled = (savedDragState === 'true');
                        if (isDragEnabled) {
                            jm.enable_draggable_node();
                        } else {
                            jm.disable_draggable_node();
                        }
                        updateDragStatusDisplay();
                        console.log('âœ… æ‹–æ‹½çŠ¶æ€å·²æ¢å¤:', isDragEnabled ? 'å¯ç”¨' : 'ç¦ç”¨');
                    } catch (e) {
                        console.error('æ‹–æ‹½çŠ¶æ€æ¢å¤å¤±è´¥:', e);
                    }
                }
                
                // æ¢å¤é€‰ä¸­èŠ‚ç‚¹
                if (savedSelectedNode && hasRecoveredData) {
                    setTimeout(function() {
                        try {
                            var node = jm.get_node(savedSelectedNode);
                            if (node) {
                                jm.select_node(savedSelectedNode);
                                showNodeDetails(savedSelectedNode);
                                console.log('âœ… é€‰ä¸­èŠ‚ç‚¹å·²æ¢å¤:', node.topic);
                            }
                        } catch (e) {
                            console.error('é€‰ä¸­èŠ‚ç‚¹æ¢å¤å¤±è´¥:', e);
                        }
                    }, 300);
                }
                
                if (hasRecoveredData) {
                    showMessage('ğŸ”„ å·²ä»æœ¬åœ°å­˜å‚¨æ¢å¤ä¸Šæ¬¡çš„æ€ç»´å¯¼å›¾çŠ¶æ€');
                } else {
                    // å¦‚æœæ²¡æœ‰ä¿å­˜çš„æ•°æ®ï¼Œåˆå§‹åŒ–é»˜è®¤æ•°æ®
                    initNodeDatabase();
                }
                
                return hasRecoveredData;
                
            } catch (error) {
                console.error('æ•°æ®æ¢å¤å¤±è´¥:', error);
                showMessage('âŒ æ•°æ®æ¢å¤å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤æ•°æ®');
                initNodeDatabase();
                return false;
            }
        }
        
        // æ¸…é™¤ä¿å­˜çš„æ•°æ®
        function clearSavedData() {
            if (confirm('âš ï¸ ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰ä¿å­˜çš„æ•°æ®å—ï¼Ÿè¿™å°†åˆ é™¤æœ¬åœ°å­˜å‚¨çš„æ€ç»´å¯¼å›¾ã€ä¸»é¢˜è®¾ç½®ç­‰ä¿¡æ¯ã€‚')) {
                try {
                    Object.values(STORAGE_KEYS).forEach(function(key) {
                        localStorage.removeItem(key);
                    });
                    
                    showMessage('ğŸ—‘ï¸ æœ¬åœ°å­˜å‚¨æ•°æ®å·²æ¸…é™¤');
                    console.log('âœ… æœ¬åœ°å­˜å‚¨æ•°æ®å·²æ¸…é™¤');
                    
                    // é‡æ–°åŠ è½½é»˜è®¤æ•°æ®
                    setTimeout(function() {
                        location.reload();
                    }, 1000);
                    
                } catch (error) {
                    console.error('æ¸…é™¤æ•°æ®å¤±è´¥:', error);
                    showMessage('âŒ æ¸…é™¤æ•°æ®å¤±è´¥: ' + error.message);
                }
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆ
        window.addEventListener('load', function() {
            // é¦–å…ˆç¡®ä¿å¤šå·¥ä½œåŒºå·²æ­£ç¡®åˆå§‹åŒ–
            if (!mindmaps.workspace || !mindmaps.knowledge || !mindmaps.project) {
                console.log('é‡æ–°åˆå§‹åŒ–å¤šå·¥ä½œåŒº...');
                initMindmaps();
            }
            
            // å°è¯•åŠ è½½ä¿å­˜çš„æ•°æ®
            var hasRecoveredData = loadSavedData();
            
            // å¦‚æœæ²¡æœ‰æ¢å¤æ•°æ®ï¼Œè¿›è¡Œæ­£å¸¸åˆå§‹åŒ–
            if (!hasRecoveredData) {
                // åˆå§‹åŒ–å½“å‰æ´»è·ƒå·¥ä½œåŒºçš„èŠ‚ç‚¹æ•°æ®åº“
                initNodeDatabase();
                
                // æ˜¾ç¤ºé€‰ä¸­èŠ‚ç‚¹
                updateSelectedNodeDisplay();
                
                // å¦‚æœæœ‰é€‰ä¸­èŠ‚ç‚¹ï¼Œæ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯
                var selected = getCurrentJsMind().get_selected_node();
                if (selected) {
                    showNodeDetails(selected.id);
                }
            }
            
            // è®¾ç½®è‡ªåŠ¨ä¿å­˜
            setupAutoSave();
            
            showMessage('ğŸ‰ jsMind æœ¬åœ°æ‹–æ‹½æ¼”ç¤ºå·²å¯åŠ¨ï¼');
            console.log('jsMind æœ¬åœ°æ‹–æ‹½ç‰ˆæœ¬æ¼”ç¤ºå·²å¯åŠ¨');
            console.log('ç‰ˆæœ¬: 0.8.7 (æœ¬åœ°ç‰ˆæœ¬)');
            console.log('æ‹–æ‹½åŠŸèƒ½: å·²å¯ç”¨');
            console.log('å½“å‰ä¸»é¢˜:', themes[currentThemeIndex].label);
        });

        // æ•°æ®å¯¼å‡ºåŠŸèƒ½
        function exportToFile() {
            try {
                var mind_data = jm.get_data();
                if (!mind_data) {
                    showMessage('âŒ æ— æ•°æ®å¯å¯¼å‡º');
                    return;
                }
                
                // æ„å»ºå¯¼å‡ºæ•°æ®ï¼ŒåŒ…å«èŠ‚ç‚¹è¯¦ç»†ä¿¡æ¯
                var exportData = {
                    mindmap: mind_data,
                    nodeDetails: nodeDatabase,
                    exportInfo: {
                        timestamp: new Date().toISOString(),
                        version: "1.0.0",
                        exported_by: "NodeMind"
                    }
                };
                
                var mind_str = JSON.stringify(exportData, null, 2);
                var filename = (mind_data.meta && mind_data.meta.name) ? mind_data.meta.name : 'mindmap';
                filename = filename.replace(/[^a-zA-Z0-9\u4e00-\u9fa5]/g, '_') + '_' + new Date().getTime();
                
                // ä½¿ç”¨ jsMind å·¥å…·ä¿å­˜æ–‡ä»¶
                if (typeof jsMind !== 'undefined' && jsMind.util && jsMind.util.file) {
                    jsMind.util.file.save(mind_str, 'application/json', filename + '.json');
                    showMessage('âœ… JSONæ–‡ä»¶å¯¼å‡ºæˆåŠŸ: ' + filename + '.json');
                } else {
                    // å¤‡ç”¨æ–¹æ¡ˆï¼šæ‰‹åŠ¨åˆ›å»ºä¸‹è½½
                    downloadFile(mind_str, filename + '.json', 'application/json');
                    showMessage('âœ… JSONæ–‡ä»¶å¯¼å‡ºæˆåŠŸ: ' + filename + '.json');
                }
                
                console.log('å¯¼å‡ºæ•°æ®:', exportData);
            } catch (error) {
                console.error('å¯¼å‡ºå¤±è´¥:', error);
                showMessage('âŒ å¯¼å‡ºå¤±è´¥: ' + error.message);
            }
        }
        
        function exportToCustomFile() {
            try {
                var mind_data = jm.get_data();
                if (!mind_data) {
                    showMessage('âŒ æ— æ•°æ®å¯å¯¼å‡º');
                    return;
                }
                
                // æ„å»ºå¯¼å‡ºæ•°æ®
                var exportData = {
                    mindmap: mind_data,
                    nodeDetails: nodeDatabase,
                    exportInfo: {
                        timestamp: new Date().toISOString(),
                        version: "1.0.0",
                        exported_by: "NodeMind",
                        export_type: "custom_with_path_selection"
                    }
                };
                
                var mind_str = JSON.stringify(exportData, null, 2);
                var defaultName = (mind_data.meta && mind_data.meta.name) ? mind_data.meta.name : 'mindmap';
                
                // ä¼˜å…ˆä½¿ç”¨PyQtæ–‡ä»¶ä¿å­˜å¯¹è¯æ¡†
                if (typeof window.pyqt_bridge !== 'undefined' && window.pyqt_bridge.saveFileWithDialog) {
                    console.log('ğŸ¯ ä½¿ç”¨PyQtæ–‡ä»¶ä¿å­˜å¯¹è¯æ¡†...');
                    var savedPath = window.pyqt_bridge.saveFileWithDialog(mind_str, defaultName);
                    
                    if (savedPath && savedPath.length > 0) {
                        showMessage('âœ… æ€ç»´å¯¼å›¾å·²ä¿å­˜åˆ°: ' + savedPath);
                        console.log('âœ… æ–‡ä»¶ä¿å­˜æˆåŠŸ:', savedPath);
                    } else {
                        showMessage('ğŸš« æ–‡ä»¶ä¿å­˜å·²å–æ¶ˆ');
                        console.log('ğŸš« ç”¨æˆ·å–æ¶ˆäº†æ–‡ä»¶ä¿å­˜');
                    }
                } else {
                    // å¤‡ç”¨æ–¹æ¡ˆï¼šåŸæœ‰çš„ç®€å•æ–‡ä»¶åè¾“å…¥æ–¹å¼
                    console.log('âš ï¸ PyQtæ–‡ä»¶å¯¹è¯æ¡†ä¸å¯ç”¨ï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ');
                    var customName = prompt('è¯·è¾“å…¥å¯¼å‡ºæ–‡ä»¶åï¼ˆä¸å«æ‰©å±•åï¼‰:', defaultName);
                    
                    if (customName === null) {
                        showMessage('ğŸš« å¯¼å‡ºå·²å–æ¶ˆ');
                        return;
                    }
                    
                    if (!customName || customName.trim() === '') {
                        customName = 'mindmap_' + new Date().getTime();
                    }
                    
                    // æ¸…ç†æ–‡ä»¶å
                    customName = customName.trim().replace(/[^a-zA-Z0-9\u4e00-\u9fa5]/g, '_');
                    
                    // ä½¿ç”¨æµè§ˆå™¨ä¸‹è½½
                    if (typeof jsMind !== 'undefined' && jsMind.util && jsMind.util.file) {
                        jsMind.util.file.save(mind_str, 'application/json', customName + '.json');
                        showMessage('âœ… è‡ªå®šä¹‰æ–‡ä»¶å¯¼å‡ºæˆåŠŸ: ' + customName + '.json');
                    } else {
                        downloadFile(mind_str, customName + '.json', 'application/json');
                        showMessage('âœ… è‡ªå®šä¹‰æ–‡ä»¶å¯¼å‡ºæˆåŠŸ: ' + customName + '.json');
                    }
                }
                
                console.log('è‡ªå®šä¹‰å¯¼å‡ºæ•°æ®:', exportData);
            } catch (error) {
                console.error('è‡ªå®šä¹‰å¯¼å‡ºå¤±è´¥:', error);
                showMessage('âŒ è‡ªå®šä¹‰å¯¼å‡ºå¤±è´¥: ' + error.message);
            }
        }
        
        // å¤‡ç”¨ä¸‹è½½å‡½æ•°
        function downloadFile(content, filename, contentType) {
            var blob = new Blob([content], { type: contentType });
            var url = URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.style.display = 'none';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // å¿«é€Ÿå¯¼å‡ºï¼ˆä»…æ€ç»´å¯¼å›¾æ•°æ®ï¼‰
        function quickExport() {
            try {
                var mind_data = jm.get_data();
                if (!mind_data) {
                    showMessage('âŒ æ— æ•°æ®å¯å¯¼å‡º');
                    return;
                }
                
                var mind_str = JSON.stringify(mind_data, null, 2);
                var filename = 'mindmap_quick_' + new Date().getTime();
                
                downloadFile(mind_str, filename + '.json', 'application/json');
                showMessage('âš¡ å¿«é€Ÿå¯¼å‡ºæˆåŠŸ: ' + filename + '.json');
                
            } catch (error) {
                console.error('å¿«é€Ÿå¯¼å‡ºå¤±è´¥:', error);
                showMessage('âŒ å¿«é€Ÿå¯¼å‡ºå¤±è´¥: ' + error.message);
            }
        }

        // æ–‡ä»¶å¯¼å…¥åŠŸèƒ½
        function triggerImport() {
            var fileInput = document.getElementById('import_file_input');
            fileInput.click();
        }
        
        function handleFileImport(fileInput) {
            var files = fileInput.files;
            if (files.length > 0) {
                var file = files[0];
                importMindmapFile(file);
            }
        }
        
        function importMindmapFile(file) {
            try {
                var fileName = file.name.toLowerCase();
                
                // æ£€æŸ¥æ–‡ä»¶ç±»å‹
                if (!fileName.endsWith('.json') && !fileName.endsWith('.jm') && !fileName.endsWith('.mm')) {
                    showMessage('âŒ ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼ï¼Œä»…æ”¯æŒ .jsonã€.jmã€.mm æ–‡ä»¶');
                    return;
                }
                
                showMessage('ğŸ“‚ æ­£åœ¨å¯¼å…¥æ–‡ä»¶: ' + file.name);
                
                // ä½¿ç”¨ jsMind å·¥å…·è¯»å–æ–‡ä»¶
                if (typeof jsMind !== 'undefined' && jsMind.util && jsMind.util.file) {
                    jsMind.util.file.read(file, function(fileData, fileName) {
                        try {
                            processMindmapData(fileData, fileName, file.name);
                        } catch (error) {
                            console.error('æ–‡ä»¶å¤„ç†å¤±è´¥:', error);
                            showMessage('âŒ æ–‡ä»¶å¤„ç†å¤±è´¥: ' + error.message);
                        }
                    });
                } else {
                    // å¤‡ç”¨æ–¹æ¡ˆï¼šä½¿ç”¨ FileReader
                    var reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            processMindmapData(e.target.result, file.name, file.name);
                        } catch (error) {
                            console.error('æ–‡ä»¶è¯»å–å¤±è´¥:', error);
                            showMessage('âŒ æ–‡ä»¶è¯»å–å¤±è´¥: ' + error.message);
                        }
                    };
                    reader.readAsText(file);
                }
                
            } catch (error) {
                console.error('å¯¼å…¥å¤±è´¥:', error);
                showMessage('âŒ å¯¼å…¥å¤±è´¥: ' + error.message);
            }
        }
        
        function processMindmapData(fileData, fileName, originalFileName) {
            try {
                var mind = null;
                var fileExtension = originalFileName.toLowerCase().split('.').pop();
                
                if (fileExtension === 'mm') {
                    // FreeMind æ ¼å¼
                    var mindName = fileName;
                    if (/.*\.mm$/.test(mindName)) {
                        mindName = fileName.substring(0, fileName.length - 3);
                    }
                    
                    mind = {
                        meta: {
                            name: mindName,
                            author: 'NodeMind Imported',
                            version: '1.0.0',
                        },
                        format: 'freemind',
                        data: fileData,
                    };
                } else {
                    // JSON æˆ– JM æ ¼å¼
                    if (typeof fileData === 'string') {
                        mind = JSON.parse(fileData);
                    } else {
                        mind = fileData;
                    }
                    
                    // æ£€æŸ¥æ˜¯å¦æ˜¯æˆ‘ä»¬å¯¼å‡ºçš„å®Œæ•´æ ¼å¼
                    if (mind && mind.mindmap && mind.nodeDetails) {
                        // æ¢å¤èŠ‚ç‚¹è¯¦ç»†ä¿¡æ¯
                        nodeDatabase = mind.nodeDetails || {};
                        mind = mind.mindmap;
                        showMessage('ğŸ“‹ æ£€æµ‹åˆ°å®Œæ•´æ•°æ®æ ¼å¼ï¼Œæ­£åœ¨æ¢å¤èŠ‚ç‚¹è¯¦ç»†ä¿¡æ¯...');
                    }
                    
                    // éªŒè¯æ•°æ®æ ¼å¼
                    if (!mind || !mind.data) {
                        throw new Error('æ— æ•ˆçš„æ€ç»´å¯¼å›¾æ•°æ®æ ¼å¼');
                    }
                }
                
                // æ˜¾ç¤ºæ€ç»´å¯¼å›¾
                if (mind) {
                    jm.show(mind);
                    
                    // é‡æ–°åˆå§‹åŒ–èŠ‚ç‚¹æ•°æ®åº“ï¼ˆå¦‚æœæ²¡æœ‰ä»æ–‡ä»¶ä¸­æ¢å¤ï¼‰
                    if (!mind.nodeDetails) {
                        setTimeout(function() {
                            initNodeDatabase();
                        }, 100);
                    }
                    
                    showMessage('âœ… æ–‡ä»¶å¯¼å…¥æˆåŠŸ: ' + originalFileName);
                    console.log('å¯¼å…¥çš„æ€ç»´å¯¼å›¾æ•°æ®:', mind);
                    
                    // æ›´æ–°ä¸»é¢˜æ˜¾ç¤º
                    updateSelectedNodeDisplay();
                    
                    // å¦‚æœæœ‰æ ¹èŠ‚ç‚¹ï¼Œé€‰æ‹©å®ƒ
                    setTimeout(function() {
                        var rootNode = jm.get_node(jm.get_root().id);
                        if (rootNode) {
                            jm.select_node(rootNode.id);
                        }
                    }, 200);
                    
                } else {
                    throw new Error('æ— æ³•è§£ææ€ç»´å¯¼å›¾æ•°æ®');
                }
                
            } catch (error) {
                console.error('æ•°æ®å¤„ç†å¤±è´¥:', error);
                showMessage('âŒ æ•°æ®å¤„ç†å¤±è´¥: ' + error.message);
            }
            
            // æ¸…ç©ºæ–‡ä»¶è¾“å…¥
            document.getElementById('import_file_input').value = '';
        }
        
        // é‡ç½®æ€ç»´å¯¼å›¾
        function resetMindmap() {
            if (confirm('âš ï¸ ç¡®å®šè¦é‡ç½®æ€ç»´å¯¼å›¾å—ï¼Ÿå½“å‰æ‰€æœ‰æ•°æ®å°†ä¸¢å¤±ï¼')) {
                jm.show(mindData);
                nodeDatabase = {};
                initNodeDatabase();
                showMessage('ğŸ”„ æ€ç»´å¯¼å›¾å·²é‡ç½®');
            }
        }
        
        // æ˜¾ç¤ºä½¿ç”¨æŒ‡å—
        function showUserGuide() {
            var guideWindow = window.open('', '_blank', 'width=1000,height=700,scrollbars=yes,resizable=yes');
            var guideContent = `
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <!-- ç¼“å­˜ç ´åæ ‡è®° - 2025-06-12T09:36:21.220473 -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="version" content="1749692181">

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NodeMind ä½¿ç”¨æŒ‡å—</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            border-radius: 12px;
            padding: 40px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        h1 { 
            color: #2c3e50; 
            text-align: center; 
            font-size: 32px; 
            margin-bottom: 30px;
            border-bottom: 3px solid #3498db;
            padding-bottom: 15px;
        }
        h2 { 
            color: #34495e; 
            font-size: 24px; 
            margin-top: 30px; 
            margin-bottom: 15px;
            padding-left: 10px;
            border-left: 4px solid #3498db;
        }
        h3 { 
            color: #2c3e50; 
            font-size: 18px; 
            margin-top: 20px; 
            margin-bottom: 10px;
        }
        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .feature-card {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            border-left: 4px solid #28a745;
        }
        .feature-card h4 {
            color: #2c3e50;
            margin: 0 0 15px 0;
            font-size: 16px;
        }
        ul { 
            margin: 10px 0; 
            padding-left: 20px; 
        }
        li { 
            margin: 8px 0; 
            font-size: 14px;
        }
        .highlight {
            background: #fff3cd;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid #ffc107;
            margin: 15px 0;
        }
        .shortcut-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        .shortcut-table th, .shortcut-table td {
            border: 1px solid #dee2e6;
            padding: 12px;
            text-align: left;
        }
        .shortcut-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
        }
        .shortcut-table tr:nth-child(even) {
            background: #f8f9fa;
        }
        .btn-guide {
            background: #007bff;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            margin: 5px;
            cursor: pointer;
        }
        .emoji { font-size: 18px; }
        .version-info {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 6px;
            margin: 20px 0;
            border-left: 4px solid #2196f3;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“š NodeMind ä½¿ç”¨æŒ‡å—</h1>
        
        <div class="version-info">
            <strong>ğŸ¯ NodeMind v1.0.0</strong> - åŸºäº jsMind çš„æ™ºèƒ½æ€ç»´å¯¼å›¾å·¥å…·
            <br>
            <small>æ”¯æŒæ‹–æ‹½ã€å¯¼å…¥å¯¼å‡ºã€æŒä¹…åŒ–å­˜å‚¨çš„å…¨åŠŸèƒ½æ€ç»´å¯¼å›¾åº”ç”¨</small>
        </div>

        <h2>ğŸš€ å¿«é€Ÿå¼€å§‹</h2>
        <div class="highlight">
            <strong>ğŸ’¡ æç¤ºï¼š</strong> NodeMind æ”¯æŒå®Œå…¨çš„é”®ç›˜æ“ä½œï¼Œæ‰€æœ‰åŠŸèƒ½éƒ½å¯ä»¥é€šè¿‡å¿«æ·é”®å¿«é€Ÿè®¿é—®ï¼
        </div>

        <h2>âŒ¨ï¸ å¿«æ·é”®æŒ‡å—</h2>
        <table class="shortcut-table">
            <thead>
                <tr>
                    <th>åŠŸèƒ½åˆ†ç±»</th>
                    <th>å¿«æ·é”®</th>
                    <th>è¯´æ˜</th>
                </tr>
            </thead>
            <tbody>
                <tr><td rowspan="6"><strong>èŠ‚ç‚¹æ“ä½œ</strong></td><td>Ctrl+Enter</td><td>æ·»åŠ å­èŠ‚ç‚¹</td></tr>
                <tr><td>Enter</td><td>æ·»åŠ å…„å¼ŸèŠ‚ç‚¹</td></tr>
                <tr><td>F2</td><td>ç¼–è¾‘èŠ‚ç‚¹å†…å®¹</td></tr>
                <tr><td>Delete</td><td>åˆ é™¤èŠ‚ç‚¹</td></tr>
                <tr><td>Space</td><td>å±•å¼€/æ”¶èµ·èŠ‚ç‚¹</td></tr>
                <tr><td>æ–¹å‘é”®</td><td>é€‰æ‹©ç›¸é‚»èŠ‚ç‚¹</td></tr>
                
                <tr><td rowspan="4"><strong>æ–‡ä»¶æ“ä½œ</strong></td><td>Ctrl+S</td><td>å¯¼å‡ºå®Œæ•´JSONæ–‡ä»¶</td></tr>
                <tr><td>Ctrl+E</td><td>è‡ªå®šä¹‰æ–‡ä»¶åå¯¼å‡º</td></tr>
                <tr><td>Ctrl+Q</td><td>å¿«é€Ÿå¯¼å‡º</td></tr>
                <tr><td>Ctrl+O</td><td>å¯¼å…¥æ–‡ä»¶</td></tr>
                
                <tr><td rowspan="1"><strong>å¸®åŠ©</strong></td><td>Ctrl+H</td><td>æ˜¾ç¤ºå¿«æ·é”®å¸®åŠ©</td></tr>
            </tbody>
        </table>

        <h2>ğŸ¨ æ ¸å¿ƒåŠŸèƒ½</h2>
        <div class="feature-grid">
            <div class="feature-card">
                <h4>ğŸ§  æ€ç»´å¯¼å›¾ç¼–è¾‘</h4>
                <ul>
                    <li>æ‹–æ‹½èŠ‚ç‚¹é‡æ–°ç»„ç»‡ç»“æ„</li>
                    <li>æ”¯æŒè·¨åˆ†æ”¯æ‹–æ‹½ç§»åŠ¨</li>
                    <li>å®æ—¶è‡ªåŠ¨å¸ƒå±€è°ƒæ•´</li>
                    <li>å¤šç§èŠ‚ç‚¹ç¼–è¾‘æ–¹å¼</li>
                </ul>
            </div>
            
            <div class="feature-card">
                <h4>ğŸ’¾ æ•°æ®ç®¡ç†</h4>
                <ul>
                    <li>è‡ªåŠ¨æŒä¹…åŒ–å­˜å‚¨</li>
                    <li>æ”¯æŒJSON/JM/MMæ ¼å¼</li>
                    <li>å®Œæ•´çš„å¯¼å…¥å¯¼å‡ºåŠŸèƒ½</li>
                    <li>é¡µé¢å…³é—­æ•°æ®ä¿æŠ¤</li>
                </ul>
            </div>
            
            <div class="feature-card">
                <h4>ğŸ­ ç•Œé¢ä¸»é¢˜</h4>
                <ul>
                    <li>15ç§å†…ç½®ä¸»é¢˜</li>
                    <li>ä¸»é¢˜è®¾ç½®è‡ªåŠ¨ä¿å­˜</li>
                    <li>å“åº”å¼è®¾è®¡</li>
                    <li>ç§»åŠ¨ç«¯å®Œç¾æ”¯æŒ</li>
                </ul>
            </div>
            
            <div class="feature-card">
                <h4>ğŸ“‹ èŠ‚ç‚¹è¯¦ç»†ä¿¡æ¯</h4>
                <ul>
                    <li>ä¸°å¯Œçš„èŠ‚ç‚¹å±æ€§ç¼–è¾‘</li>
                    <li>åˆ†ç±»æ ‡ç­¾ç®¡ç†</li>
                    <li>æ—¶é—´æˆ³è®°å½•</li>
                    <li>èŠ‚ç‚¹å…³ç³»æ˜¾ç¤º</li>
                </ul>
            </div>
        </div>

        <h2>ğŸ–±ï¸ é¼ æ ‡æ“ä½œæŒ‡å—</h2>
        <ul>
            <li><strong>å•å‡»èŠ‚ç‚¹</strong> - é€‰ä¸­èŠ‚ç‚¹</li>
            <li><strong>åŒå‡»èŠ‚ç‚¹</strong> - ç¼–è¾‘èŠ‚ç‚¹å†…å®¹</li>
            <li><strong>æ‹–æ‹½ç”»å¸ƒ</strong> - ç§»åŠ¨è§†å›¾</li>
            <li><strong>æ»šè½®</strong> - ç¼©æ”¾æ€ç»´å¯¼å›¾</li>
            <li><strong>æ‹–æ‹½èŠ‚ç‚¹</strong> - é‡æ–°ç»„ç»‡ç»“æ„</li>
        </ul>

        <h2>ğŸ”„ æ•°æ®æŒä¹…åŒ–</h2>
        <p>NodeMind å…·å¤‡å®Œæ•´çš„è‡ªåŠ¨ä¿å­˜åŠŸèƒ½ï¼š</p>
        <ul>
            <li><strong>å®æ—¶ä¿å­˜</strong> - æ‰€æœ‰æ“ä½œè‡ªåŠ¨ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨</li>
            <li><strong>çŠ¶æ€æ¢å¤</strong> - é¡µé¢é‡æ–°åŠ è½½æ—¶è‡ªåŠ¨æ¢å¤å·¥ä½œçŠ¶æ€</li>
            <li><strong>å¤šå±‚ä¿æŠ¤</strong> - é¡µé¢å…³é—­å‰å¼ºåˆ¶ä¿å­˜</li>
            <li><strong>æ•°æ®ç®¡ç†</strong> - æ”¯æŒæ‰‹åŠ¨æ¸…é™¤å­˜å‚¨æ•°æ®</li>
        </ul>

        <h2>ğŸ“ æ–‡ä»¶æ ¼å¼æ”¯æŒ</h2>
        <div class="feature-grid">
            <div class="feature-card">
                <h4>ğŸ“„ å¯¼å…¥æ ¼å¼</h4>
                <ul>
                    <li><strong>.json</strong> - æ ‡å‡†JSONæ ¼å¼</li>
                    <li><strong>.jm</strong> - jsMindåŸç”Ÿæ ¼å¼</li>
                    <li><strong>.mm</strong> - FreeMindæ ¼å¼</li>
                </ul>
            </div>
            
            <div class="feature-card">
                <h4>ğŸ’¾ å¯¼å‡ºé€‰é¡¹</h4>
                <ul>
                    <li><strong>å®Œæ•´å¯¼å‡º</strong> - åŒ…å«æ‰€æœ‰èŠ‚ç‚¹è¯¦ç»†ä¿¡æ¯</li>
                    <li><strong>è‡ªå®šä¹‰å¯¼å‡º</strong> - ç”¨æˆ·æŒ‡å®šæ–‡ä»¶å</li>
                    <li><strong>å¿«é€Ÿå¯¼å‡º</strong> - ä»…æ ¸å¿ƒæ€ç»´å¯¼å›¾æ•°æ®</li>
                </ul>
            </div>
        </div>

        <h2>ğŸ› ï¸ é«˜çº§æŠ€å·§</h2>
        <div class="highlight">
            <h3>ğŸ’¡ æ•ˆç‡æå‡æŠ€å·§</h3>
            <ul>
                <li><strong>æ‰¹é‡æ“ä½œ</strong> - ä½¿ç”¨Ctrl+å¿«æ·é”®å¿«é€Ÿæ“ä½œ</li>
                <li><strong>æ‹–æ‹½é‡ç»„</strong> - ç›´æ¥æ‹–æ‹½èŠ‚ç‚¹æ”¹å˜ç»“æ„</li>
                <li><strong>ä¸»é¢˜åˆ‡æ¢</strong> - ä¸åŒåœºæ™¯ä½¿ç”¨ä¸åŒä¸»é¢˜</li>
                <li><strong>æ ‡ç­¾ç®¡ç†</strong> - ä½¿ç”¨æ ‡ç­¾åˆ†ç±»ç®¡ç†èŠ‚ç‚¹</li>
            </ul>
        </div>

        <h2>ğŸš¨ å¸¸è§é—®é¢˜</h2>
        <h3>Q: é¡µé¢åˆ·æ–°åæ•°æ®ä¸¢å¤±æ€ä¹ˆåŠï¼Ÿ</h3>
        <p>A: NodeMind å…·å¤‡è‡ªåŠ¨ä¿å­˜åŠŸèƒ½ï¼Œæ•°æ®ä¼šè‡ªåŠ¨æ¢å¤ã€‚å¦‚æœä»æœ‰é—®é¢˜ï¼Œå¯èƒ½æ˜¯æµè§ˆå™¨ç¦ç”¨äº†æœ¬åœ°å­˜å‚¨ã€‚</p>
        
        <h3>Q: æ”¯æŒå“ªäº›æµè§ˆå™¨ï¼Ÿ</h3>
        <p>A: æ”¯æŒæ‰€æœ‰ç°ä»£æµè§ˆå™¨ï¼ˆChromeã€Firefoxã€Safariã€Edgeç­‰ï¼‰ï¼Œå»ºè®®ä½¿ç”¨æœ€æ–°ç‰ˆæœ¬ã€‚</p>
        
        <h3>Q: å¦‚ä½•å¤‡ä»½æ•°æ®ï¼Ÿ</h3>
        <p>A: ä½¿ç”¨ Ctrl+S å¯¼å‡ºå®Œæ•´æ•°æ®ï¼ŒåŒ…å«æ‰€æœ‰èŠ‚ç‚¹è¯¦ç»†ä¿¡æ¯ï¼Œå¯ä½œä¸ºå®Œæ•´å¤‡ä»½ã€‚</p>

        <div style="text-align: center; margin-top: 40px; padding-top: 20px; border-top: 2px solid #eee;">
            <p><strong>ğŸ‰ å¼€å§‹ä½¿ç”¨ NodeMindï¼Œè®©æ€ç»´å¯è§†åŒ–ï¼</strong></p>
            <button class="btn-guide" onclick="window.close()">å…³é—­æŒ‡å—</button>
        </div>
    </div>
</body>
</html>`;
            
            guideWindow.document.write(guideContent);
            guideWindow.document.close();
            guideWindow.focus();
            
            showMessage('ğŸ“š ä½¿ç”¨æŒ‡å—å·²æ‰“å¼€');
        }

        // æ–°å†…å®¹åŠŸèƒ½ - ä¿å­˜å½“å‰è„‘å›¾å¹¶åˆ›å»ºç©ºç™½è„‘å›¾
        function createNewContent() {
            try {
                // 1. å…ˆä¿å­˜å½“å‰è„‘å›¾
                var currentMind = getCurrentJsMind();
                if (currentMind) {
                    var mind_data = currentMind.get_data();
                    if (mind_data) {
                        // ç”Ÿæˆæ—¶é—´æˆ³æ–‡ä»¶å
                        var timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
                        var backupName = 'mindmap_backup_' + timestamp;
                        
                        // æ„å»ºä¿å­˜æ•°æ®
                        var exportData = {
                            mindmap: mind_data,
                            nodeDetails: nodeDatabase,
                            exportInfo: {
                                timestamp: new Date().toISOString(),
                                version: "1.0.0",
                                exported_by: "NodeMind",
                                backup_type: "auto_before_new_content"
                            }
                        };
                        
                        var mind_str = JSON.stringify(exportData, null, 2);
                        
                        // è‡ªåŠ¨ä¿å­˜å¤‡ä»½æ–‡ä»¶
                        if (typeof jsMind !== 'undefined' && jsMind.util && jsMind.util.file) {
                            jsMind.util.file.save(mind_str, 'application/json', backupName + '.json');
                        } else {
                            // å¤‡ç”¨æ–¹æ¡ˆ
                            downloadFile(mind_str, backupName + '.json', 'application/json');
                        }
                        
                        showMessage('âœ… å·²ä¿å­˜å½“å‰è„‘å›¾: ' + backupName + '.json');
                    }
                }
                
                // 2. åˆ›å»ºæ–°çš„ç©ºç™½è„‘å›¾æ•°æ®
                var newMindData = {
                    meta: {
                        name: "æ–°å†…å®¹è„‘å›¾",
                        author: "NodeMind",
                        version: "1.0.0"
                    },
                    format: "node_tree",
                    data: {
                        id: "new_root_" + Date.now(),
                        topic: "ğŸ§  ä¸­å¿ƒèŠ‚ç‚¹",
                        children: []
                    }
                };
                
                // 3. æ›´æ–°å½“å‰æ´»è·ƒè„‘å›¾
                var currentMindmap = getCurrentJsMind();
                if (currentMindmap) {
                    currentMindmap.show(newMindData);
                    
                    // 4. æ¸…ç©ºèŠ‚ç‚¹æ•°æ®åº“
                    nodeDatabase = {};
                    
                    // 5. åˆå§‹åŒ–æ–°çš„æ ¹èŠ‚ç‚¹æ•°æ®
                    nodeDatabase[newMindData.data.id] = {
                        id: newMindData.data.id,
                        title: newMindData.data.topic,
                        content: '',
                        relations: {
                            parent: null,
                            children: []
                        },
                        tags: {
                            categories: [],
                            technical: [],
                            status: []
                        },
                        time: {
                            created: new Date().toLocaleString(),
                            updated: new Date().toLocaleString()
                        },
                        details: {
                            description: '',
                            implementation: '',
                            testing: '',
                            notes: ''
                        }
                    };
                    
                    // 6. æ¸…ç©ºè¯¦æƒ…é¢æ¿ï¼ˆæ£€æŸ¥å…ƒç´ å­˜åœ¨æ€§ï¼‰
                    var detailElement = document.getElementById('detail-info-content');
                    if (detailElement) {
                        detailElement.innerHTML = `
                            <div class="empty-state">
                                <div class="icon">ğŸ“</div>
                                <div>ç‚¹å‡»æ€ç»´å¯¼å›¾ä¸­çš„èŠ‚ç‚¹ç¼–è¾‘è¯¦ç»†æè¿°</div>
                            </div>
                        `;
                    }
                    
                    var basicElement = document.getElementById('basic-info-content');
                    if (basicElement) {
                        basicElement.innerHTML = `
                            <div class="empty-state">
                                <div class="icon">ğŸ“‹</div>
                                <div>ç‚¹å‡»æ€ç»´å¯¼å›¾ä¸­çš„èŠ‚ç‚¹æŸ¥çœ‹åŸºæœ¬ä¿¡æ¯</div>
                            </div>
                        `;
                    }
                    
                    var historyElement = document.getElementById('history-info-content');
                    if (historyElement) {
                        historyElement.innerHTML = `
                            <div class="empty-state">
                                <div class="icon">ğŸ“š</div>
                                <div>ç‚¹å‡»æ€ç»´å¯¼å›¾ä¸­çš„èŠ‚ç‚¹æŸ¥çœ‹å†å²è®°å½•</div>
                            </div>
                        `;
                    }
                    
                    // 7. æ›´æ–°çŠ¶æ€æ˜¾ç¤º
                    document.getElementById('selectedNode').textContent = 'æ— ';
                    
                    // 8. è‡ªåŠ¨ä¿å­˜æ–°çŠ¶æ€
                    setTimeout(function() {
                        autoSaveData();
                    }, 500);
                    
                    showMessage('âœ¨ æ–°å†…å®¹è„‘å›¾å·²åˆ›å»ºï¼ä¸­å¿ƒèŠ‚ç‚¹å·²å‡†å¤‡å°±ç»ª');
                    console.log('æ–°å†…å®¹è„‘å›¾åˆ›å»ºå®Œæˆ');
                }
                
            } catch (error) {
                console.error('åˆ›å»ºæ–°å†…å®¹å¤±è´¥:', error);
                showMessage('âŒ åˆ›å»ºæ–°å†…å®¹å¤±è´¥: ' + error.message);
            }
        }

        // æ·»åŠ é”®ç›˜å¿«æ·é”®å’Œå¸®åŠ©
        document.addEventListener('keydown', function(e) {
            // å¯¼å‡ºåŠŸèƒ½å¿«æ·é”®
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                exportToFile();
                return;
            }
            
            if (e.ctrlKey && e.key === 'e') {
                e.preventDefault();
                exportToCustomFile();
                return;
            }
            
            if (e.ctrlKey && e.key === 'q') {
                e.preventDefault();
                quickExport();
                return;
            }
            
            if (e.ctrlKey && e.key === 'o') {
                e.preventDefault();
                triggerImport();
                return;
            }
            
            // å¸®åŠ©å¿«æ·é”®
            if (e.ctrlKey && e.key === 'h') {
                e.preventDefault();
                                 alert('jsMind æ‹–æ‹½æ¼”ç¤º - å¿«æ·é”®å¸®åŠ©:\n\nåŸºæœ¬æ“ä½œ:\nâ€¢ Ctrl+Enter - æ·»åŠ å­èŠ‚ç‚¹\nâ€¢ Enter - æ·»åŠ å…„å¼ŸèŠ‚ç‚¹\nâ€¢ F2 - ç¼–è¾‘èŠ‚ç‚¹å†…å®¹\nâ€¢ Delete - åˆ é™¤èŠ‚ç‚¹\nâ€¢ Space - å±•å¼€/æ”¶èµ·èŠ‚ç‚¹\nâ€¢ æ–¹å‘é”® - é€‰æ‹©ç›¸é‚»èŠ‚ç‚¹\n\næ–‡ä»¶æ“ä½œ:\nâ€¢ Ctrl+S - å¯¼å‡ºå®Œæ•´JSONæ–‡ä»¶\nâ€¢ Ctrl+E - è‡ªå®šä¹‰æ–‡ä»¶åå¯¼å‡º\nâ€¢ Ctrl+Q - å¿«é€Ÿå¯¼å‡ºï¼ˆä»…æ€ç»´å¯¼å›¾æ•°æ®ï¼‰\nâ€¢ Ctrl+O - å¯¼å…¥æ–‡ä»¶ï¼ˆæ”¯æŒJSON/JM/MMæ ¼å¼ï¼‰\n\næ‹–æ‹½æ“ä½œ:\nâ€¢ é¼ æ ‡å·¦é”®æ‹–æ‹½èŠ‚ç‚¹ç§»åŠ¨\nâ€¢ æ‹–æ‹½åˆ°ç›®æ ‡èŠ‚ç‚¹ä¸Šé‡Šæ”¾\nâ€¢ æ”¯æŒè·¨åˆ†æ”¯æ‹–æ‹½\nâ€¢ å®æ—¶è§†è§‰åé¦ˆ\n\nCtrl+H - æ˜¾ç¤ºæ­¤å¸®åŠ©');
            }
        });

        // ================ æ ¹èŠ‚ç‚¹éšè—ç³»ç»Ÿï¼ˆä¸“å®¶å»ºè®®æ–¹æ¡ˆ2å®æ–½ï¼‰ ================
        
        console.log('ğŸ¯ é‡‡ç”¨jsMindå®˜æ–¹custom_node_renderæœºåˆ¶å®ç°æ ¹èŠ‚ç‚¹éšè—');
        
        // ğŸ¯ å®˜æ–¹æ–¹æ¡ˆï¼šé€šè¿‡custom_node_renderè‡ªåŠ¨éšè—æ ¹èŠ‚ç‚¹ï¼Œæ— éœ€å¤æ‚é…ç½®
        
        console.log('âœ… æ ¹èŠ‚ç‚¹éšè—å·²é€šè¿‡å®˜æ–¹custom_node_renderæœºåˆ¶å®ç°');
        
        // ğŸ¯ å®˜æ–¹æ–¹æ¡ˆå·²å®Œå…¨å®ç°æ ¹èŠ‚ç‚¹éšè—ï¼Œæ— éœ€é¢å¤–å¤„ç†

        // ğŸ¯ æ–°å¢ï¼šäºŒçº§æ ‡ç­¾ç®¡ç†ç³»ç»Ÿ - æ ‡ç­¾ç»„-æ ‡ç­¾ç»“æ„
        function renderDetailInfoWithGroupedTags(nodeId) {
            var node = getCurrentJsMind().get_node(nodeId);
            if (!node || !node.data) return;
            
            var nodeData = node.data;
            var path = getNodePath(node);
            
            // å®šä¹‰æ ‡ç­¾ç»„é…ç½®
            var tagGroups = {
                'å¸¸è§„': {
                    icon: 'ğŸ“‹',
                    categories: ['é¡¹ç›®', 'å¹»è§‰', 'å®Œæˆ', 'çŠ¯ç¯'],
                    tags: nodeData.tags?.categories || []
                },
                'AIå¼€å‘': {
                    icon: 'ğŸ¤–', 
                    categories: ['è®¡åˆ’'],
                    tags: nodeData.tags?.technical || []
                }
            };
            
            var content = `
                <div style="padding: 20px;">
                    <h4 style="margin: 0 0 15px 0; color: #495057; font-size: 16px; font-weight: 600;">
                        ğŸ“‹ èŠ‚ç‚¹è¯¦ç»†ä¿¡æ¯
                    </h4>
                    
                    <div class="path-breadcrumb" style="margin-bottom: 15px; font-size: 12px; color: #6c757d;">
                        èŠ‚ç‚¹è·¯å¾„: ${path.map((item, index) => 
                            index < path.length - 1 ? 
                            `<span style="color: #007bff;">${item.replace(/<[^>]*>/g, '')}</span> â†’ ` : 
                            `<span style="color: #007bff; font-weight: 600;">${item.replace(/<[^>]*>/g, '')}</span>`
                        ).join('')}
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <strong style="color: #495057;">èŠ‚ç‚¹æ ‡é¢˜:</strong><br>
                        <span style="color: #333; font-size: 14px;">${node.topic}</span>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <strong style="color: #495057;">è¯¦ç»†å†…å®¹:</strong><br>
                        <div style="background: #f8f9fa; padding: 12px; border-radius: 4px; border: 1px solid #dee2e6; font-size: 13px; color: #333; min-height: 60px;">
                            ${nodeData.content || 'æš‚æ— è¯¦ç»†å†…å®¹'}
                        </div>
                    </div>
                    
                    <!-- ğŸ¯ äºŒçº§æ ‡ç­¾ç®¡ç†åŒºåŸŸ -->
                    <div style="margin-bottom: 15px;">
                        <h5 style="color: #495057; font-weight: 600; margin-bottom: 12px;">ğŸ·ï¸ æ ‡ç­¾ç®¡ç†</h5>
                        
                        ${Object.keys(tagGroups).map(groupName => {
                            var group = tagGroups[groupName];
                            return `
                                <div class="tag-group-container" style="margin-bottom: 16px; border: 1px solid #e0e0e0; border-radius: 8px; background: #fafafa;">
                                    <!-- æ ‡ç­¾ç»„æ ‡é¢˜ -->
                                    <div class="tag-group-header" style="background: #f0f0f0; padding: 8px 12px; border-radius: 8px 8px 0 0; border-bottom: 1px solid #e0e0e0;">
                                        <span style="font-weight: 600; color: #333; font-size: 13px;">
                                            ${group.icon} ${groupName}
                                        </span>
                                    </div>
                                    
                                    <!-- æ ‡ç­¾ç»„å†…å®¹ -->
                                    <div class="tag-group-content" style="padding: 12px;">
                                        ${group.categories.length > 0 ? `
                                            <div class="tag-category-row" style="margin-bottom: 8px;">
                                                <span style="font-size: 11px; color: #666; margin-right: 8px;">ç±»åˆ«:</span>
                                                ${group.categories.map(category => 
                                                    `<span class="tag-category-item" style="background: #e3f2fd; color: #1976d2; padding: 2px 6px; border-radius: 10px; font-size: 10px; margin-right: 4px;">${category}</span>`
                                                ).join('')}
                                            </div>
                                        ` : ''}
                                        
                                        <div class="tag-items-row">
                                            <span style="font-size: 11px; color: #666; margin-right: 8px;">æ ‡ç­¾:</span>
                                            <div class="tag-list" style="display: inline-flex; flex-wrap: wrap; gap: 4px;">
                                                ${group.tags.length > 0 ? 
                                                    group.tags.map(tag => 
                                                        `<span class="tag-item" style="background: #e9ecef; color: #495057; padding: 3px 8px; border-radius: 12px; font-size: 11px; display: inline-flex; align-items: center; gap: 4px;">
                                                            ${tag}
                                                            <button type="button" onclick="removeGroupTag('${nodeId}', '${groupName}', '${tag}')" class="tag-remove" style="background: none; border: none; color: #6c757d; cursor: pointer; font-size: 12px; padding: 0; margin-left: 2px;">Ã—</button>
                                                        </span>`
                                                    ).join('') : 
                                                    '<span style="color: #999; font-size: 11px; font-style: italic;">æš‚æ— æ ‡ç­¾</span>'
                                                }
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <strong style="color: #495057;">åŸºæœ¬ä¿¡æ¯:</strong><br>
                        <div style="font-size: 13px; color: #666; line-height: 1.6;">
                            â€¢ èŠ‚ç‚¹ID: ${nodeId}<br>
                            â€¢ åˆ›å»ºæ—¶é—´: ${nodeData.time?.created || 'æœªè®¾ç½®'}<br>
                            â€¢ ä¿®æ”¹æ—¶é—´: ${nodeData.time?.modified || 'æœªè®¾ç½®'}<br>
                            â€¢ ä½œè€…: ${nodeData.author || 'æœªè®¾ç½®'}
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #dee2e6; font-size: 12px; color: #6c757d;">
                        ğŸ’¡ æç¤ºï¼šä½¿ç”¨è„‘å›¾ç®¡ç†åŒºçš„"ğŸ”„ æ ‡ç­¾åŒæ­¥"æŒ‰é’®å¯åŒæ­¥æ ‡ç­¾ç®¡ç†è„‘å›¾çš„å†…å®¹
                    </div>
                </div>
            `;
            
            var detailElement = document.getElementById('detail-info-content');
            if (detailElement) {
                detailElement.innerHTML = content;
            }
        }

        // ğŸ¯ ç§»é™¤æ ‡ç­¾ç»„ä¸­çš„æ ‡ç­¾
        function removeGroupTag(nodeId, groupName, tag) {
            var node = getCurrentJsMind().get_node(nodeId);
            if (!node || !node.data) return;
            
            // æ ¹æ®æ ‡ç­¾ç»„æ˜ å°„åˆ°å…·ä½“çš„æ ‡ç­¾ç±»å‹
            var tagTypeMapping = {
                'å¸¸è§„': 'categories',
                'AIå¼€å‘': 'technical'
            };
            
            var tagType = tagTypeMapping[groupName];
            if (!tagType) return;
            
            // ç§»é™¤æ ‡ç­¾
            if (node.data.tags && node.data.tags[tagType]) {
                var tagIndex = node.data.tags[tagType].indexOf(tag);
                if (tagIndex > -1) {
                    node.data.tags[tagType].splice(tagIndex, 1);
                    
                    // æ›´æ–°ä¿®æ”¹æ—¶é—´
                    if (!node.data.time) node.data.time = {};
                    node.data.time.modified = new Date().toISOString();
                    
                    // æ ‡è®°æœªä¿å­˜æ›´æ”¹
                    if (!node.data.flags) node.data.flags = {};
                    node.data.flags.hasUnsavedChanges = true;
                    
                    // é‡æ–°æ¸²æŸ“è¯¦æƒ…é¡µ
                    renderDetailInfoWithGroupedTags(nodeId);
                    
                    // è‡ªåŠ¨ä¿å­˜
                    autoSaveData();
                    
                    console.log(`âœ… å·²ä»${groupName}ç§»é™¤æ ‡ç­¾: ${tag}`);
                    showMessage(`å·²ç§»é™¤æ ‡ç­¾: ${tag}`);
                }
            }
        }

        // ğŸ¯ æ ‡ç­¾åŒæ­¥åŠŸèƒ½ - ä»æ ‡ç­¾ç®¡ç†è„‘å›¾åŒæ­¥åˆ°å½“å‰èŠ‚ç‚¹
        function syncTagsFromMindmapToNode(nodeId) {
            console.log('ğŸ”„ å¼€å§‹æ ‡ç­¾åŒæ­¥...');
            
            // 1. ç¡®ä¿æ ‡ç­¾æ•°æ®åº“æ˜¯æœ€æ–°çš„
            syncMindmapToTagDatabase();
            
            // 2. è·å–å½“å‰èŠ‚ç‚¹
            var node = getCurrentJsMind().get_node(nodeId);
            if (!node) {
                showMessage('âŒ æœªæ‰¾åˆ°ç›®æ ‡èŠ‚ç‚¹');
                return;
            }
            
            // 3. ç¡®ä¿èŠ‚ç‚¹æœ‰dataç»“æ„
            if (!node.data) {
                node.data = createDefaultNodeData();
            }
            
            // 4. æ¸…ç©ºå½“å‰èŠ‚ç‚¹çš„æ‰€æœ‰æ ‡ç­¾
            if (!node.data.tags) {
                node.data.tags = {
                    categories: [],
                    technical: [],
                    status: [],
                    priority: '',
                    custom: []
                };
            }
            
            // 5. ä»æ ‡ç­¾æ•°æ®åº“åŒæ­¥æ‰€æœ‰æ ‡ç­¾åˆ°å½“å‰èŠ‚ç‚¹
            var syncCount = 0;
            
            if (tagDatabase.categories) {
                node.data.tags.categories = [...tagDatabase.categories];
                syncCount += tagDatabase.categories.length;
            }
            
            if (tagDatabase.technical) {
                node.data.tags.technical = [...tagDatabase.technical];
                syncCount += tagDatabase.technical.length;
            }
            
            if (tagDatabase.status) {
                node.data.tags.status = [...tagDatabase.status];
                syncCount += tagDatabase.status.length;
            }
            
            if (tagDatabase.custom) {
                node.data.tags.custom = [...tagDatabase.custom];
                syncCount += tagDatabase.custom.length;
            }
            
            // 6. æ›´æ–°æ—¶é—´æˆ³
            if (!node.data.time) node.data.time = {};
            node.data.time.modified = new Date().toISOString();
            
            // 7. æ ‡è®°æœªä¿å­˜æ›´æ”¹
            if (!node.data.flags) node.data.flags = {};
            node.data.flags.hasUnsavedChanges = true;
            
            // 8. é‡æ–°æ¸²æŸ“è¯¦æƒ…é¡µ
            renderDetailInfoWithGroupedTags(nodeId);
            
            // 9. è‡ªåŠ¨ä¿å­˜
            autoSaveData();
            
            console.log(`âœ… æ ‡ç­¾åŒæ­¥å®Œæˆï¼Œå…±åŒæ­¥ ${syncCount} ä¸ªæ ‡ç­¾`);
            showMessage(`âœ… æ ‡ç­¾åŒæ­¥å®Œæˆï¼Œå…±åŒæ­¥ ${syncCount} ä¸ªæ ‡ç­¾`);
            
            return syncCount;
        }
    </script>
</body>
</html>