<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <!-- 缓存控制 -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>jsMind 本地版演示（支持拖拽功能）</title>
    <!-- 引入本地安装的 jsMind -->
    <link type="text/css" rel="stylesheet" href="./node_modules/jsmind/style/jsmind.css" />
    <script type="text/javascript" src="./node_modules/jsmind/es6/jsmind.js"></script>
    <!-- 引入本地拖拽功能插件 -->
    <script type="text/javascript" src="./node_modules/jsmind/es6/jsmind.draggable-node.js"></script>
    <!-- 引入截图导出功能依赖 -->
    <script src="https://unpkg.com/dom-to-image@2.6.0/dist/dom-to-image.min.js"></script>
    <script type="text/javascript" src="./node_modules/jsmind/es6/jsmind.screenshot.js"></script>
    <!-- QWebChannel for PyQt communication -->
    <script src="qrc:///qtwebchannel/qwebchannel.js"></script>
    
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.15);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 5px;
            text-align: center;
            min-height: 20px;
        }
        
        .header h1 {
            margin: 0 0 10px 0;
            font-size: 28px;
            font-weight: 600;
        }
        
        .header .subtitle {
            font-size: 16px;
            opacity: 0.9;
            margin: 0 0 15px 0;
        }
        
        .feature-highlight {
            background: rgba(255,255,255,0.1);
            padding: 12px 18px;
            border-radius: 8px;
            margin-top: 15px;
            font-size: 14px;
            font-weight: 500;
        }
        
        .toolbar {
            background: #f8f9fa;
            padding: 20px;
            text-align: center;
            border-bottom: 2px solid #dee2e6;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
        }
        
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 18px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .btn:hover {
            background: #0056b3;
            transform: translateY(-1px);
        }
        
        .btn-success { background: #28a745; }
        .btn-success:hover { background: #1e7e34; }
        
        .btn-danger { background: #dc3545; }
        .btn-danger:hover { background: #c82333; }
        
        .btn-warning { background: #ffc107; color: #212529; }
        .btn-warning:hover { background: #e0a800; }
        
        .btn-secondary { background: #6c757d; }
        .btn-secondary:hover { background: #545b62; }
        
        .btn-info { background: #17a2b8; }
        .btn-info:hover { background: #138496; }
        
        #jsmind_container {
            height: calc(100vh - 200px);
            background: #f8f9fa;
            border-radius: 8px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.1);
        }
        
        .main-layout {
            display: flex;
            height: calc(100vh - 200px);
            gap: 20px;
            margin: 20px;
        }
        
        .mindmap-container {
            flex: 1;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #dee2e6;
            box-shadow: 0 2px 12px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .mindmap-container.fullwidth {
            width: 100%;
        }
        
        .placeholder-content {
            text-align: center;
            color: #6c757d;
            padding: 40px 20px;
            border: 2px dashed #dee2e6;
            border-radius: 6px;
            background: #f8f9fa;
            margin-bottom: 20px;
        }
        
        .placeholder-content .icon {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.5;
        }
        
        .placeholder-content .title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .placeholder-content .subtitle {
            font-size: 14px;
            opacity: 0.7;
        }
        
        .main-content {
            margin: 20px 0;
        }
        
        .node-info-panel {
            background: #f8f9fa;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            height: fit-content;
            max-height: 650px;
            overflow-y: auto;
        }
        
        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            border-bottom: 1px solid #dee2e6;
            background: #e9ecef;
            border-radius: 8px 8px 0 0;
        }
        
        .panel-header h3 {
            margin: 0;
            font-size: 16px;
            color: #495057;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 20px;
            color: #6c757d;
            cursor: pointer;
        }
        
        .close-btn:hover {
            color: #343a40;
        }
        
        .panel-content {
            padding: 10px 0;
        }
        
        /* 节点详情面板在操作指南区域内的样式 */
        .help-item.node-details .panel-content {
            max-height: 400px;
            overflow-y: auto;
            padding: 10px 0;
        }
        
        .help-item.node-details .node-detail-form {
            margin-top: 10px;
        }
        
        .placeholder {
            color: #586069;
            font-style: italic;
            text-align: center;
            padding: 15px 0;
        }
        
        .node-info-item {
            margin-bottom: 12px;
        }
        
        .node-info-item label {
            display: block;
            font-weight: 600;
            font-size: 13px;
            color: #495057;
            margin-bottom: 4px;
        }
        
        .node-info-item .value {
            font-size: 14px;
            word-break: break-word;
        }
        
        .node-info-item .tag-list {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }
        
        .node-info-item .tag {
            background: #e9ecef;
            color: #495057;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 12px;
        }
        
        .node-path {
            font-size: 12px;
            color: #6c757d;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px dashed #dee2e6;
        }
        
        .node-path span {
            color: #007bff;
        }
        
        /* 表单样式 */
        .node-detail-form {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .form-input, .form-textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            font-size: 14px;
            color: #495057;
            transition: border-color 0.2s ease;
        }
        
        .form-input:focus, .form-textarea:focus {
            border-color: #80bdff;
            outline: 0;
            box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
        }
        
        .form-textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        .form-actions {
            display: flex;
            justify-content: flex-start;
            gap: 10px;
            margin-top: 15px;
        }
        
        .form-btn {
            padding: 8px 16px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            background: #f8f9fa;
            color: #495057;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .form-btn:hover {
            background: #e9ecef;
        }
        
        .form-btn-primary {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }
        
        .form-btn-primary:hover {
            background: #0069d9;
            border-color: #0062cc;
        }
        
        /* 标签样式 */
        .tags-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .tags-list {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }
        
        .tag {
            background: #e9ecef;
            color: #495057;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 12px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        .tag a {
            color: #6c757d;
            text-decoration: none;
            font-weight: bold;
        }
        
        .tag a:hover {
            color: #dc3545;
        }
        
        .tag-input {
            padding: 5px 10px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            font-size: 12px;
            width: 100%;
        }
        
        .relation-info, .time-info {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            font-size: 13px;
            line-height: 1.5;
        }
        
        .drag-hint {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 15px;
            margin: 20px;
            border-radius: 8px;
            text-align: center;
            font-weight: 500;
        }
        
        .drag-hint strong {
            color: #d63384;
        }
        
        .status {
            background: linear-gradient(135deg, #343a40 0%, #495057 100%);
            color: white;
            padding: 12px 20px;
            font-size: 13px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #28a745;
        }
        
        .help {
            padding: 25px;
            background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
        }
        
        .help h3 {
            margin: 0 0 20px 0;
            color: #1565c0;
            font-size: 18px;
            font-weight: 600;
        }
        
        .help-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }
        
        .help-item {
            background: rgba(255,255,255,0.9);
            padding: 18px;
            border-radius: 8px;
            border-left: 4px solid;
        }
        
        .help-item.mouse { border-left-color: #007bff; }
        .help-item.keyboard { border-left-color: #28a745; }
        .help-item.drag { border-left-color: #fd7e14; }
        .help-item.features { border-left-color: #6f42c1; }
        
        .help-item h4 {
            margin: 0 0 12px 0;
            color: #2c3e50;
            font-size: 15px;
            font-weight: 600;
        }
        
        .help-item ul {
            margin: 0;
            padding-left: 20px;
            font-size: 13px;
            line-height: 1.6;
        }
        
        .help-item li {
            margin: 6px 0;
        }
        
        @media (max-width: 768px) {
            .toolbar {
                padding: 15px;
                gap: 8px;
            }
            
            .btn {
                padding: 8px 14px;
                font-size: 13px;
            }
            
            .main-layout {
                flex-direction: column;
                height: auto;
                gap: 15px;
                margin: 15px;
            }
            

            
            .mindmap-container {
                order: 1;
                height: 400px;
            }
            
            #jsmind_container {
                height: 400px;
            }
        }
        
        /* 脑图选项卡样式 */
        .mindmap-tab-container {
            height: 100%;
            display: flex;
            flex-direction: column;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .mindmap-tab-header {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            flex-shrink: 0;
        }
        
        .mindmap-tab-button {
            flex: 1;
            padding: 12px 15px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #6c757d;
            transition: all 0.3s ease;
            position: relative;
            border-right: 1px solid #dee2e6;
        }
        
        .mindmap-tab-button:last-child {
            border-right: none;
        }
        
        .mindmap-tab-button:hover {
            background: #e9ecef;
            color: #495057;
        }
        
        .mindmap-tab-button.active {
            background: white;
            color: #007bff;
            font-weight: 600;
        }
        
        .mindmap-tab-button.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: #007bff;
        }
        
        .mindmap-tab-content {
            display: none;
            flex: 1;
            position: relative;
            overflow: hidden;
        }
        
        .mindmap-tab-content.active {
            display: block;
        }
        
        .jsmind-tab-canvas {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
        }
        
        /* 右键菜单样式 */
        .context-menu {
            position: fixed;
            background: white;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            padding: 5px 0;
            z-index: 10000;
            display: none;
        }
        
        .context-menu-item {
            padding: 8px 16px;
            cursor: pointer;
            font-size: 14px;
            color: #333;
            white-space: nowrap;
        }
        
        .context-menu-item:hover {
            background: #f0f0f0;
        }
        
        .context-menu-divider {
            height: 1px;
            background: #eee;
            margin: 5px 0;
        }
        
        /* 详情页简化样式 */
        
        .tab-pane h4 {
            margin: 0 0 15px 0;
            color: #495057;
            font-size: 16px;
            font-weight: 600;
        }
        
        .info-row {
            display: flex;
            margin-bottom: 12px;
            align-items: flex-start;
        }
        
        .info-label {
            min-width: 80px;
            font-weight: 600;
            color: #6c757d;
            font-size: 13px;
            margin-right: 10px;
            flex-shrink: 0;
        }
        
        .info-value {
            flex: 1;
            font-size: 14px;
            color: #495057;
            word-break: break-word;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-label {
            display: block;
            font-weight: 600;
            color: #495057;
            font-size: 13px;
            margin-bottom: 6px;
        }
        
        .form-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }
        
        .form-textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
            min-height: 320px;
            resize: vertical;
            box-sizing: border-box;
        }
        
        .detail-header {
            position: relative;
            margin-bottom: 15px;
        }
        
        .author-input-small {
            position: absolute;
            top: 0;
            right: 0;
            width: 150px;
            padding: 4px 8px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 12px;
            background: #f8f9fa;
        }
        
        .tag-input-group {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
        }
        
        .tag-input {
            flex: 1;
            padding: 6px 10px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 13px;
        }
        
        .tag-select {
            flex: 1;
            padding: 6px 10px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 13px;
            background: white;
            margin-right: 8px;
        }
        
        .tag-add-btn {
            padding: 6px 12px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
        }
        
        .tag-list {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 8px;
        }
        
        .tag-item {
            background: #e9ecef;
            color: #495057;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .tag-remove {
            background: none;
            border: none;
            color: #6c757d;
            cursor: pointer;
            font-size: 14px;
            padding: 0;
            margin-left: 4px;
        }
        
        .form-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #dee2e6;
        }
        
        .btn-primary {
            padding: 8px 16px;
            background: #007bff;
            color: white;
            border: 1px solid #007bff;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .btn-secondary {
            padding: 8px 16px;
            background: #6c757d;
            color: white;
            border: 1px solid #6c757d;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .history-item {
            padding: 12px;
            border-left: 3px solid #007bff;
            background: #f8f9fa;
            margin-bottom: 10px;
            border-radius: 0 4px 4px 0;
        }
        
        .history-time {
            font-size: 12px;
            color: #6c757d;
            margin-bottom: 4px;
        }
        
        .history-action {
            font-weight: 600;
            color: #495057;
            margin-bottom: 2px;
        }
        
        .history-detail {
            font-size: 13px;
            color: #6c757d;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #6c757d;
        }
        
        .empty-state .icon {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.5;
        }
        
        .path-breadcrumb {
            background: #f8f9fa;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            color: #6c757d;
            margin-bottom: 15px;
        }
        
        .path-breadcrumb .path-separator {
            margin: 0 8px;
            color: #adb5bd;
        }
        
        .path-breadcrumb .path-node {
            color: #007bff;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <!-- 保留区域备用 -->
        </div>
        
        <div class="toolbar">
            <!-- 隐藏的文件输入元素 -->
            <input type="file" id="import_file_input" accept=".json,.jm,.mm" style="display: none;" onchange="handleFileImport(this)">
            
            <button class="btn btn-primary" onclick="showUserGuide()" style="background: #007bff; border: 2px solid #0056b3; font-size: 16px; font-weight: 600; padding: 12px 24px; box-shadow: 0 4px 12px rgba(0,123,255,0.3); transition: all 0.3s ease;">
                📚 使用指南
            </button>
            <button class="btn btn-info" onclick="exportToCustomFile()">
                📁 自定义存储
            </button>
            <button class="btn btn-primary" onclick="createNewContent()">
                ✨ 新内容
            </button>
            <button class="btn btn-success" onclick="triggerImport()">
                📂 导入文件
            </button>
            <button class="btn btn-danger" onclick="clearSavedData()">
                🗑️ 清除存储
            </button>
            <button class="btn btn-success" onclick="syncCurrentNodeTags()" title="同步标签管理脑图的标签到当前选中节点">
                🔄 标签同步
            </button>
            <button class="btn btn-warning" onclick="debugTagSync()" title="调试标签同步功能">
                🔧 调试标签
            </button>

        </div>
        

        
        <div class="main-layout">
            <div class="mindmap-container fullwidth">
                <div class="mindmap-tab-container">
                    <div class="mindmap-tab-header">
                        <button class="mindmap-tab-button" onclick="switchMindmapTab('workspace')">
                            🔬 临时工作区A
                        </button>
                        <button class="mindmap-tab-button" onclick="switchMindmapTab('knowledge')">
                            🏷️ 标签管理
                        </button>
                        <button class="mindmap-tab-button active" onclick="switchMindmapTab('project')">
                            🚀 项目管理
                        </button>
                    </div>
                    
                    <!-- 临时工作区A选项卡 -->
                    <div id="mindmap-tab-workspace" class="mindmap-tab-content">
                        <div id="jsmind_container_workspace" class="jsmind-tab-canvas"></div>
                    </div>
                    
                    <!-- 标签管理选项卡 -->
                    <div id="mindmap-tab-knowledge" class="mindmap-tab-content">
                        <div id="jsmind_container_knowledge" class="jsmind-tab-canvas"></div>
                    </div>
                    
                    <!-- 项目管理脑图选项卡（主显示区） -->
                    <div id="mindmap-tab-project" class="mindmap-tab-content active">
                        <div id="jsmind_container_project" class="jsmind-tab-canvas"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="status">
            <div class="status-item">
                <div class="status-indicator"></div>
                <span>jsMind 本地版本已加载</span>
            </div>
            <div class="status-item">
                当前主题: <span id="currentTheme">primary</span>
            </div>
            <div class="status-item">
                选中节点: <span id="selectedNode">无</span>
            </div>
            <div class="status-item">
                拖拽状态: <span id="dragEnabled">已启用</span>
            </div>
        </div>
        
        <div class="help">
            <h3>📖 完整操作指南</h3>
            <div class="help-grid">
                <div class="help-item mouse">
                    <h4>👛️ 鼠标操作</h4>
                    <ul>
                        <li>单击节点选中</li>
                        <li>双击节点编辑内容</li>
                        <li>拖拽画布移动视图</li>
                        <li>滚轮缩放思维导图</li>
                        <li><strong>拖拽节点重新组织结构</strong></li>
                    </ul>
                </div>
                <div class="help-item keyboard">
                    <h4>⌨️ 快捷键</h4>
                    <ul>
                        <li>Ctrl+Enter - 添加子节点</li>
                        <li>Enter - 添加兄弟节点</li>
                        <li>F2 - 编辑节点</li>
                        <li>Delete - 删除节点</li>
                        <li>Space - 展开/收起节点</li>
                        <li>方向键 - 选择相邻节点</li>
                        <li><strong>Ctrl+S - 导出完整JSON文件</strong></li>
                        <li><strong>Ctrl+E - 自定义文件名导出</strong></li>
                        <li><strong>Ctrl+Q - 快速导出</strong></li>
                        <li><strong>Ctrl+O - 导入文件</strong></li>
                    </ul>
                </div>
                <div class="help-item drag">
                    <h4>🔀 拖拽功能详解</h4>
                    <ul>
                        <li>按住鼠标左键开始拖拽</li>
                        <li>拖拽到目标节点上方</li>
                        <li>释放鼠标完成移动</li>
                        <li>支持跨分支拖拽移动</li>
                        <li>可开启/关闭拖拽功能</li>
                        <li>自动重新排列布局</li>
                    </ul>
                </div>
                <div class="help-item features">
                    <h4>🎨 高级功能</h4>
                    <ul>
                        <li>15种内置主题</li>
                        <li>自定义节点样式</li>
                        <li><strong>本地文件导出 (Ctrl+S/E/Q)</strong></li>
                        <li><strong>本地文件导入 (Ctrl+O)</strong></li>
                        <li><strong>自动持久化存储</strong></li>
                        <li>自定义文件名支持</li>
                        <li>节点详细信息导出</li>
                        <li>多格式文件导入 (JSON/JM/MM)</li>
                        <li>页面关闭数据保护</li>
                        <li>移动端支持</li>
                        <li>快捷键操作</li>
                        <li>实时状态反馈</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- 右键菜单 -->
    <div id="contextMenu" class="context-menu">
        <div class="context-menu-item" onclick="focusNodeToWorkspaces()">
            🔬 单独显示到临时工作区
        </div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-item" onclick="hideContextMenu()">
            ❌ 取消
        </div>
    </div>

    <script type="text/javascript">
        // WebChannel通信初始化
        function initWebChannel() {
            console.log('🔧 开始初始化WebChannel通信...');
            console.log('当前环境检查:', {
                'QWebChannel可用': typeof QWebChannel !== 'undefined',
                'qt对象可用': typeof qt !== 'undefined',
                'webChannelTransport可用': typeof qt !== 'undefined' && typeof qt.webChannelTransport !== 'undefined'
            });
            
            // 检查QWebChannel是否可用
            if (typeof QWebChannel !== 'undefined' && typeof qt !== 'undefined' && qt.webChannelTransport) {
                console.log('✅ QWebChannel环境完整，开始连接...');
                try {
                    new QWebChannel(qt.webChannelTransport, function(channel) {
                        console.log('📡 WebChannel连接回调触发');
                        console.log('可用对象:', Object.keys(channel.objects));
                        
                        // 获取PyQt bridge对象
                        if (channel.objects.pyqt_bridge) {
                            window.pyqt_bridge = channel.objects.pyqt_bridge;
                            console.log('✅ QWebChannel bridge连接成功');
                            
                            // 测试通信
                            if (typeof window.pyqt_bridge.updateNodeDetails === 'function') {
                                console.log('✅ PyQt bridge对象可用，通信已建立');
                                
                                // 发送测试消息
                                window.pyqt_bridge.updateNodeDetails(JSON.stringify({
                                    test: true,
                                    message: 'WebChannel连接测试',
                                    timestamp: new Date().toISOString()
                                }));
                                console.log('📤 已发送测试消息');
                            } else {
                                console.log('❌ PyQt bridge对象的updateNodeDetails方法不可用');
                            }
                        } else {
                            console.log('❌ 未找到pyqt_bridge对象');
                        }
                    });
                } catch (error) {
                    console.error('❌ WebChannel初始化失败:', error);
                }
            } else {
                console.log('⚠️ QWebChannel环境不完整，使用备用通信方式');
            }
        }
        
        // 多种初始化时机
        document.addEventListener('DOMContentLoaded', function() {
            console.log('📄 DOM加载完成，延迟初始化WebChannel...');
            setTimeout(initWebChannel, 500);
        });
        
        window.addEventListener('load', function() {
            console.log('🌐 页面完全加载，再次尝试初始化WebChannel...');
            setTimeout(initWebChannel, 1000);
        });
        
        // 思维导图数据
        var mindData = {
            meta: {
                name: "jsMind本地拖拽演示",
                author: "NodeMind Demo",
                version: "1.0.0"
            },
            format: "node_tree",
            data: {
                id: "root",
                topic: "🧠 jsMind 本地拖拽演示",
                children: [
                    {
                        id: "features",
                        topic: "🚀 核心特性",
                        direction: "right",
                        children: [
                            { id: "feature1", topic: "纯JavaScript实现" },
                            { id: "feature2", topic: "HTML5 Canvas渲染" },
                            { id: "feature3", topic: "节点拖拽功能" },
                            { id: "feature4", topic: "本地库文件支持" }
                        ]
                    },
                    {
                        id: "drag_features",
                        topic: "🔀 拖拽特性",
                        direction: "right",
                        children: [
                            { id: "drag1", topic: "拖拽节点移动" },
                            { id: "drag2", topic: "跨分支重组" },
                            { id: "drag3", topic: "实时视觉反馈" },
                            { id: "drag4", topic: "自动布局调整" }
                        ]
                    },
                    {
                        id: "applications",
                        topic: "📋 应用场景",
                        direction: "right",
                        children: [
                            { id: "app1", topic: "知识管理" },
                            { id: "app2", topic: "项目规划" },
                            { id: "app3", topic: "学习笔记" },
                            { id: "app4", topic: "团队协作" }
                        ]
                    },
                    {
                        id: "advantages",
                        topic: "⭐ 技术优势",
                        direction: "right",
                        children: [
                            { id: "adv1", topic: "离线使用" },
                            { id: "adv2", topic: "高性能渲染" },
                            { id: "adv3", topic: "易于集成" },
                            { id: "adv4", topic: "开源免费" }
                        ]
                    }
                ]
            }
        };

        // 三个脑图实例
        var mindmaps = {
            workspace: null,
            knowledge: null,
            project: null
        };
        
        // 当前活跃的脑图（项目管理为主显示区）
        var currentMindmap = 'project';
        
        // 获取当前活跃的jsMind实例
        function getCurrentJsMind() {
            return mindmaps[currentMindmap];
        }
        
        // 当前右键选中的节点
        var contextMenuTargetNode = null;
        
        // 三个脑图的初始数据
        var mindmapData = {
            workspace: {
                meta: {
                    name: "临时工作区A",
                    author: "NodeMind",
                    version: "1.0.0"
                },
                format: "node_tree",
                data: {
                    id: "workspace_root",
                    topic: "🔬 临时工作区A",
                    children: []
                }
            },
            knowledge: {
                meta: {
                    name: "标签管理",
                    author: "NodeMind",
                    version: "1.0.0"
                },
                format: "node_tree",
                data: {
                    id: "tags_root",
                    topic: "🏷️ 标签管理中心",
                    children: [
                        {
                            id: "category_tags",
                            topic: "📂 分类标签",
                            direction: "right",
                            children: []
                        },
                        {
                            id: "technical_tags", 
                            topic: "⚙️ 技术标签",
                            direction: "right",
                            children: []
                        },
                        {
                            id: "status_tags",
                            topic: "📊 状态标签", 
                            direction: "left",
                            children: []
                        },
                        {
                            id: "custom_tags",
                            topic: "🎨 自定义标签",
                            direction: "left", 
                    children: []
                        }
                    ]
                }
            },
            project: {
                meta: {
                    name: "项目管理",
                    author: "NodeMind",
                    version: "1.0.0"
                },
                format: "node_tree",
                data: {
                    id: "project_root",
                    topic: "🚀 项目管理",
                    children: [
                        { id: "pj_1", topic: "需求分析", direction: "right" },
                        { id: "pj_2", topic: "设计阶段", direction: "right" },
                        { id: "pj_3", topic: "开发实施", direction: "left" },
                        { id: "pj_4", topic: "测试部署", direction: "left" }
                    ]
                }
            }
        };
        
        // 配置选项，启用拖拽功能
        var baseOptions = {
            editable: true,
            theme: 'primary',
            view: {
                engine: 'canvas',
                hmargin: 120,
                vmargin: 60,
                line_width: 2,
                line_color: '#566',
                // 🔥 【新增】自定义节点渲染 - 隐藏系统根节点
                custom_node_render: function(jm, element, node) {
                    // 如果是根节点，直接隐藏
                    if (node.isroot) {
                        element.style.display = 'none';
                        console.log('🎯 官方机制隐藏根节点:', node.topic);
                        return true; // 已处理该节点渲染
                    }
                    return false; // 使用默认渲染
                }
            },
            layout: {
                hspace: 30,
                vspace: 20,
                pspace: 13
            },
            shortcut: {
                enable: true,
                handles: {},
                mapping: {
                    addchild: 4096 + 13,  // Ctrl+Enter 添加子节点
                    addbrother: 13,  // Enter
                    editnode: 113,   // F2
                    delnode: 46,     // Delete
                    toggle: 32,      // Space
                    left: 37, up: 38, right: 39, down: 40
                }
            }
        };

        // 初始化节点数据库
        var nodeDatabase = {};
        
        // 标签管理数据库 - 独立存储标签信息
        var tagDatabase = {
            categories: [],      // 分类标签
            technical: [],       // 技术标签  
            status: [],          // 状态标签
            custom: []           // 自定义标签
        };
        
        // 递归遍历思维导图数据，初始化节点数据库
        function initNodeDatabase() {
            // 为所有工作区初始化节点数据库
            Object.keys(mindmaps).forEach(function(tabName) {
                var mindmap = mindmaps[tabName];
                if (mindmap) {
                    var data = mindmap.get_data();
                    if (data && data.data) {
                        var rootNode = mindmap.get_node(data.data.id);
                        if (rootNode) {
                            traverseNode(rootNode);
                        }
                    }
                }
            });
            console.log('所有工作区节点数据库初始化完成:', nodeDatabase);
        }
        
        // 遍历节点及其子节点
        function traverseNode(node) {
            if (!node) return;
            
            // 创建节点详细信息
            nodeDatabase[node.id] = {
                id: node.id,
                title: node.topic,
                content: '',
                relations: {
                    parent: node.parent ? node.parent.id : null,
                    children: node.children ? node.children.map(child => child.id) : []
                },
                tags: {
                    categories: [],
                    technical: [],
                    status: [],
                    custom: []
                },
                time: {
                    created: new Date().toLocaleString(),
                    modified: new Date().toLocaleString()
                },
                author: ''
            };
            
            // 递归遍历子节点
            if (node.children) {
                node.children.forEach(child => traverseNode(child));
            }
        }
        
        // 创建三个jsMind实例
        function initMindmaps() {
            // 创建工作空间脑图
            mindmaps.workspace = new jsMind({
                ...baseOptions,
                container: 'jsmind_container_workspace'
            });
            mindmaps.workspace.show(mindmapData.workspace);
            
            // 创建知识库脑图
            mindmaps.knowledge = new jsMind({
                ...baseOptions,
                container: 'jsmind_container_knowledge'
            });
            mindmaps.knowledge.show(mindmapData.knowledge);
            
            // 创建项目管理脑图
            mindmaps.project = new jsMind({
                ...baseOptions,
                container: 'jsmind_container_project'
            });
            mindmaps.project.show(mindmapData.project);
            
            // 启用拖拽功能 - 为所有实例
            Object.values(mindmaps).forEach((mindmap, index) => {
                try {
                    if (typeof mindmap.enable_draggable_node === 'function') {
                        mindmap.enable_draggable_node();
                        console.log(`✅ 脑图${index + 1}拖拽功能已启用`);
                    } else {
                        console.log(`⚠️ 脑图${index + 1}拖拽功能不支持（jsMind版本问题）`);
                    }
                } catch (dragError) {
                    console.log(`⚠️ 脑图${index + 1}拖拽功能启用失败:`, dragError.message);
                }
            });
        }
        
        // 初始化所有脑图
        initMindmaps();
        
        // 获取当前活跃的jsMind实例（兼容原有代码）
        var jm = getCurrentJsMind();
        
        // 初始化节点数据库
        initNodeDatabase();
        
        // 初始化标签管理系统
        setTimeout(() => {
            initTagManagement();
            // 🎯 确保标签管理脑图有默认数据
            ensureDefaultTagsInMindmap();
        }, 300);
        
        // 等待DOM完全渲染后绑定增强事件监听
        setTimeout(() => {
            bindEnhancedEvents();
        }, 500);

        // 增强事件监听系统
        function bindEnhancedEvents() {
            // 为所有脑图容器绑定事件监听
            ['workspace', 'knowledge', 'project'].forEach(function(tabName) {
                try {
                    const container = document.getElementById('jsmind_container_' + tabName);
                    if (container) {
                        console.log('🖱️ 绑定' + tabName + '脑图事件监听器...');
                        
                        // 左键点击事件
                        container.addEventListener('click', function(e) {
                            // 隐藏右键菜单
                            hideContextMenu();
                            
                            // 查找节点元素
                            let nodeEl = e.target.closest('.jmnode') || e.target.closest('[nodeid]');
                            
                            if (nodeEl) {
                                const nodeId = nodeEl.getAttribute('nodeid');
                                if (nodeId) {
                                    console.log('🎯 DOM捕获' + tabName + '节点点击:', nodeId);
                                    
                                    // 切换到对应的脑图
                                    if (currentMindmap !== tabName) {
                                        switchMindmapTab(tabName);
                                    }
                                    
                                    // 确保节点被选中
                                    mindmaps[tabName].select_node(nodeId);
                                    
                                    // 显示详情
                                    showNodeDetails(nodeId);
                                    updateSelectedNodeDisplay();
                                }
                            }
                        });
                        
                        // 右键菜单事件（只对项目管理选项卡启用）
                        if (tabName === 'project') {
                            container.addEventListener('contextmenu', function(e) {
                                e.preventDefault();
                                
                                // 查找节点元素
                                let nodeEl = e.target.closest('.jmnode') || e.target.closest('[nodeid]');
                                
                                if (nodeEl) {
                                    const nodeId = nodeEl.getAttribute('nodeid');
                                    if (nodeId) {
                                        // 设置右键目标节点
                                        contextMenuTargetNode = mindmaps[tabName].get_node(nodeId);
                                        
                                        // 显示右键菜单
                                        showContextMenu(e.clientX, e.clientY);
                                        
                                        console.log('🖱️ 右键点击节点:', contextMenuTargetNode.topic);
                                    }
                                }
                            });
                        }
                        
                        console.log('✅ ' + tabName + '事件监听器已绑定');
                    } else {
                        console.log('❌ 未找到' + tabName + '容器');
                    }
                } catch (error) {
                    console.log('❌ ' + tabName + '事件绑定失败:', error.message);
                }
            });
            
            // 点击其他区域隐藏右键菜单
            document.addEventListener('click', function(e) {
                if (!e.target.closest('#contextMenu')) {
                    hideContextMenu();
                }
            });
        }

        // 主题列表
        var themes = [
            { name: 'primary', label: '蓝色主题' },
            { name: 'success', label: '成功绿' },
            { name: 'warning', label: '警告橙' },
            { name: 'danger', label: '危险红' },
            { name: 'info', label: '信息青' },
            { name: 'greensea', label: '海绿色' },
            { name: 'nephritis', label: '翡翠绿' },
            { name: 'belizehole', label: '深蓝色' },
            { name: 'wisteria', label: '紫藤色' },
            { name: 'asphalt', label: '沥青灰' },
            { name: 'orange', label: '橙红色' },
            { name: 'pumpkin', label: '南瓜色' },
            { name: 'pomegranate', label: '石榴红' },
            { name: 'clouds', label: '云朵白' },
            { name: 'asbestos', label: '石棉灰' }
        ];

        var currentThemeIndex = 0;
        var isDragEnabled = true;

        // 添加节点
        function addNode() {
            var currentJm = getCurrentJsMind();
            var selected = currentJm.get_selected_node();
            if (!selected) {
                alert('请先选择一个节点');
                return;
            }
            
            var topic = prompt('请输入新节点的内容:', '新节点');
            if (topic && topic.trim()) {
                var nodeId = 'node_' + Date.now();
                currentJm.add_node(selected, nodeId, topic.trim());
                showMessage('已添加节点: ' + topic);
                updateSelectedNodeDisplay();
            }
        }

        // 编辑节点
        function editNode() {
            var currentJm = getCurrentJsMind();
            var selected = currentJm.get_selected_node();
            if (!selected) {
                alert('请先选择一个节点');
                return;
            }
            
            var newTopic = prompt('请输入新的节点内容:', selected.topic);
            if (newTopic && newTopic.trim()) {
                currentJm.update_node(selected.id, newTopic.trim());
                showMessage('已更新节点: ' + newTopic);
                updateSelectedNodeDisplay();
            }
        }

        // 删除节点
        function removeNode() {
            var currentJm = getCurrentJsMind();
            var selected = currentJm.get_selected_node();
            if (!selected) {
                alert('请先选择一个节点');
                return;
            }
            
            if (selected.id === currentJm.get_root().id) {
                alert('根节点不能删除');
                return;
            }
            
            if (confirm('确定要删除节点 "' + selected.topic + '" 及其所有子节点吗？')) {
                var topic = selected.topic;
                currentJm.remove_node(selected);
                showMessage('已删除节点: ' + topic);
                updateSelectedNodeDisplay();
            }
        }

        // 展开全部
        function expandAll() {
            var currentJm = getCurrentJsMind();
            currentJm.expand_all();
            showMessage('已展开所有节点');
        }

        // 收起全部
        function collapseAll() {
            var currentJm = getCurrentJsMind();
            var root = currentJm.get_root();
            if (root.children) {
                root.children.forEach(function(child) {
                    currentJm.collapse_node(child);
                });
            }
            showMessage('已收起所有子节点');
        }

        // 切换主题
        function changeTheme() {
            currentThemeIndex = (currentThemeIndex + 1) % themes.length;
            var theme = themes[currentThemeIndex];
            
            // 为所有脑图实例设置主题
            Object.values(mindmaps).forEach(function(mindmap) {
                mindmap.set_theme(theme.name);
            });
            
            document.getElementById('currentTheme').textContent = theme.label;
            showMessage('已切换到主题: ' + theme.label);
            // 自动保存主题设置
            setTimeout(autoSaveData, 100);
        }

        // 切换拖拽功能
        function toggleDrag() {
            if (isDragEnabled) {
                // 禁用所有脑图的拖拽功能
                Object.values(mindmaps).forEach(function(mindmap) {
                    mindmap.disable_draggable_node();
                });
                isDragEnabled = false;
                document.getElementById('dragStatus').textContent = '启用拖拽';
                document.getElementById('dragEnabled').textContent = '已禁用';
                showMessage('已禁用拖拽功能');
            } else {
                // 启用所有脑图的拖拽功能
                Object.values(mindmaps).forEach(function(mindmap) {
                    mindmap.enable_draggable_node();
                });
                isDragEnabled = true;
                document.getElementById('dragStatus').textContent = '禁用拖拽';
                document.getElementById('dragEnabled').textContent = '已启用';
                showMessage('已启用拖拽功能');
            }
            // 自动保存拖拽状态
            setTimeout(autoSaveData, 100);
        }
        
        // 更新拖拽状态显示
        function updateDragStatusDisplay() {
            if (isDragEnabled) {
                document.getElementById('dragStatus').textContent = '禁用拖拽';
                document.getElementById('dragEnabled').textContent = '已启用';
            } else {
                document.getElementById('dragStatus').textContent = '启用拖拽';
                document.getElementById('dragEnabled').textContent = '已禁用';
            }
        }

        // 导出数据
        function exportData() {
            var data = jm.get_data('node_tree');
            var jsonStr = JSON.stringify(data, null, 2);
            
            var newWindow = window.open('', '_blank', 'width=900,height=700');
                                                   var htmlContent = '<!DOCTYPE html><html><head><title>本地版思维导图数据导出</title>';
            htmlContent += '<style>body{font-family:Monaco,Consolas,monospace;margin:30px;background:#f8f9fa;}';
            htmlContent += '.container{background:white;padding:25px;border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,0.1);}';
            htmlContent += 'h2{color:#2c3e50;margin:0 0 20px 0;}';
            htmlContent += 'pre{background:#f8f9fa;padding:20px;border-radius:6px;overflow:auto;border:1px solid #dee2e6;}</style>';
            htmlContent += '</head><body><div class="container">';
            htmlContent += '<h2>🧠 jsMind 本地版数据导出</h2>';
            htmlContent += '<pre>' + jsonStr + '</pre>';
            htmlContent += '</div></body></html>';
            
            newWindow.document.write(htmlContent);
            newWindow.document.close();
        }

        // 更新选中节点显示
        function updateSelectedNodeDisplay() {
            var selected = jm.get_selected_node();
            var display = selected ? selected.topic : '无';
            if (display.length > 15) {
                display = display.substring(0, 15) + '...';
            }
            document.getElementById('selectedNode').textContent = display;
        }

        // 显示消息
        function showMessage(message) {
            console.log('jsMind: ' + message);
            
            // 创建临时消息提示
            var toast = document.createElement('div');
            toast.style.cssText = 'position:fixed;top:20px;right:20px;background:#28a745;color:white;padding:12px 20px;border-radius:6px;z-index:9999;font-size:14px;box-shadow:0 4px 12px rgba(0,0,0,0.15);opacity:0;transition:opacity 0.3s ease;';
            toast.textContent = message;
            document.body.appendChild(toast);
            
            // 显示动画
            setTimeout(function() {
                toast.style.opacity = '1';
            }, 10);
            
            // 隐藏动画
            setTimeout(function() {
                toast.style.opacity = '0';
                setTimeout(function() {
                    if (document.body.contains(toast)) {
                        document.body.removeChild(toast);
                    }
                }, 300);
            }, 2500);
        }
        
        // 显示节点详细信息 - 通信到PyQt版本
        function showNodeDetails(nodeId) {
            var node = getCurrentJsMind().get_node(nodeId);
            if (!node) return;
            
            // 更新当前编辑的节点ID
            currentEditingNodeId = nodeId;
            
            // 确保节点在数据库中存在（保持原有逻辑）
            if (!nodeDatabase[nodeId]) {
                nodeDatabase[nodeId] = {
                    id: nodeId,
                    title: node.topic,
                    content: '',
                    relations: {
                        parent: node.parent ? node.parent.id : null,
                        children: node.children ? node.children.map(child => child.id) : []
                    },
                    tags: {
                        categories: [],
                        technical: [],
                        status: [],
                        custom: []
                    },
                    time: {
                        created: new Date().toLocaleString(),
                        modified: new Date().toLocaleString()
                    },
                    author: ''
                };
            }
            
            // 🎯 同时确保统一数据结构存在
            if (!node.data) {
                node.data = {
                    content: nodeDatabase[nodeId].content || '',
                    summary: '',
                    author: nodeDatabase[nodeId].author || '',
                    tags: { 
                        categories: nodeDatabase[nodeId].tags.categories || [], 
                        technical: nodeDatabase[nodeId].tags.technical || [], 
                        status: nodeDatabase[nodeId].tags.status || [],
                        priority: '', 
                        custom: nodeDatabase[nodeId].tags.custom || []
                    },
                    time: { 
                        created: nodeDatabase[nodeId].time.created || new Date().toISOString(), 
                        modified: nodeDatabase[nodeId].time.modified || new Date().toISOString() 
                    },
                    relations: { 
                        parent: node.parent ? node.parent.id : null,
                        children: node.children ? node.children.map(child => child.id) : [],
                        references: [], 
                        dependencies: [], 
                        links: [] 
                    },
                    metadata: { version: '1.0', source: 'manual', confidence: 1.0 },
                    collaboration: { assignee: '', reviewers: [], comments: [], attachments: [] },
                    flags: { isComplete: false, isArchived: false, hasUnsavedChanges: false }
                };
            }
            
            // 🎯 渲染详情页面（使用新的二级标签管理）
            renderDetailInfoWithGroupedTags(nodeId);
            
            // 发送节点详情到PyQt界面
            sendNodeDetailsToQt(nodeId);
        }
        
        // 🎯 修复版：兼容统一数据结构和nodeDatabase的节点详情发送
        function sendNodeDetailsToQt(nodeId) {
            var node = getCurrentJsMind().get_node(nodeId);
            if (!node) return;
            
            var path = getNodePath(node);
            
            // 🎯 智能数据获取：优先使用node.data，回退到nodeDatabase
            var nodeData = node.data || nodeDatabase[nodeId] || {};
            
            // 确保基本字段存在，修复PyQt端数据处理问题
            var nodeDetails = {
                id: nodeId,
                title: node.topic || '未命名节点',  // 确保title字段存在
                content: nodeData.content || '暂无详细内容',
                summary: nodeData.summary || '',
                path: path.map(item => item.replace(/<[^>]*>/g, '')).join(' → '),
                parentNode: node.parent ? node.parent.topic : '无（根节点）',
                childrenCount: node.children ? node.children.length : 0,
                createdTime: nodeData.time ? nodeData.time.created : new Date().toISOString(),
                modifiedTime: nodeData.time ? nodeData.time.modified : new Date().toISOString(),
                author: nodeData.author || '未设置',
                // 🎯 确保标签数据结构完整
                tags: {
                    categories: (nodeData.tags && nodeData.tags.categories) || [],
                    technical: (nodeData.tags && nodeData.tags.technical) || [],
                    status: (nodeData.tags && nodeData.tags.status) || [],
                    priority: (nodeData.tags && nodeData.tags.priority) || '',
                    custom: (nodeData.tags && nodeData.tags.custom) || []
                },
                metadata: nodeData.metadata || {},
                flags: nodeData.flags || {},
                // 🎯 添加标签同步功能标识
                hasTagSyncFunction: true,
                tagSyncFunctionName: 'syncTagsFromMindmap',
                // 🎯 添加调试信息
                debugInfo: {
                    nodeExists: !!node,
                    nodeDataExists: !!nodeData,
                    currentMindmap: currentMindmap,
                    timestamp: new Date().toISOString()
                }
            };
            
            console.log('🔄 准备发送节点详情到PyQt:', nodeDetails.title);
            
            // 尝试通过不同方式发送到PyQt
            try {
                // 方法1: 通过QWebChannel bridge对象（推荐方式）
                if (typeof window.pyqt_bridge !== 'undefined') {
                    window.pyqt_bridge.updateNodeDetails(JSON.stringify(nodeDetails));
                    console.log('✅ 节点详情已通过QWebChannel bridge发送到PyQt');
                    return;
                }
                
                // 方法2: 通过Qt 全局对象（备用方式）
                if (typeof qt !== 'undefined' && qt.webChannelTransport) {
                    qt.webChannelTransport.send(JSON.stringify({
                        type: 'nodeDetails',
                        data: nodeDetails
                    }));
                    console.log('✅ 节点详情已通过qt对象发送到PyQt');
                    return;
                }
                
                // 方法3: 通过console输出（PyQt可以监听）
                console.log('PYQT_NODE_DETAILS:', JSON.stringify(nodeDetails));
                console.log('⚠️ 使用console方式发送节点详情（WebChannel不可用）');
                
                // 方法4: 通过window对象存储（供PyQt读取）
                window.lastSelectedNodeDetails = nodeDetails;
                window.lastSelectedNodeTime = new Date().toISOString();
                
                // 发送自定义事件（供PyQt监听）
                if (typeof window.dispatchEvent === 'function') {
                    var event = new CustomEvent('nodeDetailsChanged', { 
                        detail: nodeDetails 
                    });
                    window.dispatchEvent(event);
                    console.log('✅ 节点详情已通过CustomEvent发送');
                }
                
            } catch (error) {
                console.error('❌ 发送节点详情到PyQt失败:', error);
                console.log('📊 当前可用的通信对象:', {
                    'window.pyqt_bridge': typeof window.pyqt_bridge,
                    'qt': typeof qt,
                    'qt.webChannelTransport': typeof qt !== 'undefined' ? typeof qt.webChannelTransport : 'undefined'
                });
            }
        }
        
        // 渲染节点详情信息
        function renderNodeDetails(nodeId) {
            var node = getCurrentJsMind().get_node(nodeId);
            var nodeData = nodeDatabase[nodeId];
            var path = getNodePath(node);
            
            var content = `
                <div style="padding: 20px;">
                    <h4 style="margin: 0 0 15px 0; color: #495057; font-size: 16px; font-weight: 600;">
                        📋 节点详细信息
                    </h4>
                    
                    <div class="path-breadcrumb" style="margin-bottom: 15px; font-size: 12px; color: #6c757d;">
                        节点路径: ${path.map((item, index) => 
                            index < path.length - 1 ? 
                            `<span style="color: #007bff;">${item.replace(/<[^>]*>/g, '')}</span> → ` : 
                            `<span style="color: #007bff; font-weight: 600;">${item.replace(/<[^>]*>/g, '')}</span>`
                        ).join('')}
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <strong style="color: #495057;">节点标题:</strong><br>
                        <span style="color: #333; font-size: 14px;">${nodeData.title}</span>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <strong style="color: #495057;">基本信息:</strong><br>
                        <div style="font-size: 13px; color: #666; line-height: 1.6;">
                            • 节点ID: ${nodeData.id}<br>
                            • 父节点: ${nodeData.relations.parent ? 
                                (getCurrentJsMind().get_node(nodeData.relations.parent) ? 
                                getCurrentJsMind().get_node(nodeData.relations.parent).topic : nodeData.relations.parent)
                                : '无（根节点）'}<br>
                            • 子节点数量: ${nodeData.relations.children.length} 个<br>
                            • 创建时间: ${nodeData.time.created}<br>
                            • 修改时间: ${nodeData.time.modified}<br>
                            • 作者: ${nodeData.author || '未设置'}
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <strong style="color: #495057;">详细内容:</strong><br>
                        <div style="background: #f8f9fa; padding: 12px; border-radius: 4px; border: 1px solid #dee2e6; font-size: 13px; color: #333; min-height: 60px;">
                            ${nodeData.content || '暂无详细内容'}
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <strong style="color: #495057;">标签信息:</strong><br>
                        <div style="margin-top: 8px;">
                            ${nodeData.tags.categories.length > 0 ? 
                                `<div style="margin-bottom: 8px;">
                                    <span style="font-size: 12px; color: #6c757d;">🏷️ 分类:</span> 
                                    ${nodeData.tags.categories.map(tag => 
                                        `<span style="background: #e9ecef; color: #495057; padding: 2px 8px; border-radius: 12px; font-size: 11px; margin-right: 4px;">${tag}</span>`
                                    ).join('')}
                                </div>` : ''}
                            ${nodeData.tags.technical.length > 0 ? 
                                `<div style="margin-bottom: 8px;">
                                    <span style="font-size: 12px; color: #6c757d;">💻 技术:</span> 
                                    ${nodeData.tags.technical.map(tag => 
                                        `<span style="background: #e3f2fd; color: #1976d2; padding: 2px 8px; border-radius: 12px; font-size: 11px; margin-right: 4px;">${tag}</span>`
                                    ).join('')}
                                </div>` : ''}
                            ${nodeData.tags.status.length > 0 ? 
                                `<div style="margin-bottom: 8px;">
                                    <span style="font-size: 12px; color: #6c757d;">📊 状态:</span> 
                                    ${nodeData.tags.status.map(tag => 
                                        `<span style="background: #fff3e0; color: #f57c00; padding: 2px 8px; border-radius: 12px; font-size: 11px; margin-right: 4px;">${tag}</span>`
                                    ).join('')}
                                </div>` : ''}
                            ${nodeData.tags.categories.length === 0 && nodeData.tags.technical.length === 0 && nodeData.tags.status.length === 0 ? 
                                '<span style="color: #6c757d; font-size: 12px;">暂无标签</span>' : ''}
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #dee2e6; font-size: 12px; color: #6c757d;">
                        💡 提示：双击节点可以编辑标题，右键菜单可以进行更多操作
                    </div>
                </div>
            `;
            
            var detailElement = document.getElementById('detail-info-content');
            if (detailElement) {
                detailElement.innerHTML = content;
            }
        }
        
        // 刷新选项卡内容
        function refreshTabContent(tabName, nodeId) {
            var node = getCurrentJsMind().get_node(nodeId);
            if (!node || !nodeDatabase[nodeId]) return;
            
            switch(tabName) {
                case 'basic':
                    renderBasicInfo(nodeId);
                    break;
                case 'detail':
                    renderDetailInfo(nodeId);
                    break;
                case 'history':
                    renderHistoryInfo(nodeId);
                    break;
            }
        }
        
        // 渲染基本信息选项卡
        function renderBasicInfo(nodeId) {
            var node = getCurrentJsMind().get_node(nodeId);
            var nodeData = nodeDatabase[nodeId];
            var path = getNodePath(node);
            
            var content = `
                <div class="path-breadcrumb">
                    ${path.map((item, index) => 
                        index < path.length - 1 ? 
                        `<span class="path-node">${item.replace(/<[^>]*>/g, '')}</span><span class="path-separator">→</span>` : 
                        `<span class="path-node">${item.replace(/<[^>]*>/g, '')}</span>`
                    ).join('')}
                </div>
                
                <div class="info-row">
                    <div class="info-label">节点ID:</div>
                    <div class="info-value">${nodeData.id}</div>
                </div>
                
                <div class="info-row">
                    <div class="info-label">标题:</div>
                    <div class="info-value">${nodeData.title}</div>
                </div>
                
                <div class="info-row">
                    <div class="info-label">父节点:</div>
                    <div class="info-value">${nodeData.relations.parent ? 
                        getCurrentJsMind().get_node(nodeData.relations.parent) ? getCurrentJsMind().get_node(nodeData.relations.parent).topic : nodeData.relations.parent
                        : '无（根节点）'}</div>
                </div>
                
                <div class="info-row">
                    <div class="info-label">子节点:</div>
                    <div class="info-value">${nodeData.relations.children.length} 个</div>
                </div>
                
                <div class="info-row">
                    <div class="info-label">创建时间:</div>
                    <div class="info-value">${nodeData.time.created}</div>
                </div>
                
                <div class="info-row">
                    <div class="info-label">修改时间:</div>
                    <div class="info-value">${nodeData.time.modified}</div>
                </div>
                
                <div class="info-row">
                    <div class="info-label">作者:</div>
                    <div class="info-value">${nodeData.author || '未设置'}</div>
                </div>
                
                ${renderAllTags(nodeId)}
            `;
            
            var basicElement = document.getElementById('basic-info-content');
            if (basicElement) {
                basicElement.innerHTML = content;
            }
        }
        
        // 渲染详细信息选项卡
        function renderDetailInfo(nodeId) {
            var nodeData = nodeDatabase[nodeId];
            
            // 确保标签结构完整
            if (!nodeData.tags) {
                nodeData.tags = {
                    categories: [],
                    technical: [],
                    status: [],
                    custom: []
                };
            }
            
            // 确保每个标签类型都存在
            if (!nodeData.tags.categories) nodeData.tags.categories = [];
            if (!nodeData.tags.technical) nodeData.tags.technical = [];
            if (!nodeData.tags.status) nodeData.tags.status = [];
            if (!nodeData.tags.custom) nodeData.tags.custom = [];
            
            var content = `
                <form onsubmit="event.preventDefault(); saveNodeDetails('${nodeId}');" class="node-detail-form">
                    <div class="detail-header">
                        <input type="text" id="node_author_${nodeId}" value="${nodeData.author || ''}" class="author-input-small" placeholder="作者">
                    </div>
                    
                    <div class="form-group">
                        <label for="node_title_${nodeId}" class="form-label">节点标题:</label>
                        <input type="text" id="node_title_${nodeId}" value="${nodeData.title || ''}" class="form-input">
                    </div>
                    
                    <div class="form-group">
                        <label for="node_content_${nodeId}" class="form-label">详细内容:</label>
                        <textarea id="node_content_${nodeId}" class="form-textarea" placeholder="输入节点的详细描述、说明或备注...">${nodeData.content || ''}</textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">🏷️ 分类标签:</label>
                        <div id="categories_${nodeId}" class="tag-list">
                            ${nodeData.tags.categories.map(tag => `<span class="tag-item">${tag} <button type="button" onclick="removeNodeTag('${nodeId}', 'categories', '${tag}')" class="tag-remove">×</button></span>`).join('')}
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">💻 技术标签:</label>
                        <div id="technical_${nodeId}" class="tag-list">
                            ${nodeData.tags.technical.map(tag => `<span class="tag-item">${tag} <button type="button" onclick="removeNodeTag('${nodeId}', 'technical', '${tag}')" class="tag-remove">×</button></span>`).join('')}
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">📊 状态标签:</label>
                        <div id="status_${nodeId}" class="tag-list">
                            ${nodeData.tags.status.map(tag => `<span class="tag-item">${tag} <button type="button" onclick="removeNodeTag('${nodeId}', 'status', '${tag}')" class="tag-remove">×</button></span>`).join('')}
                        </div>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" onclick="syncTagsFromMindmapInternal('${nodeId}')" class="btn-primary">
                            🔄 标签同步
                        </button>
                    </div>
                </form>
            `;
            
            var detailElement2 = document.getElementById('detail-info-content');
            if (detailElement2) {
                detailElement2.innerHTML = content;
            }
        }
        
        // 渲染历史记录选项卡
        function renderHistoryInfo(nodeId) {
            var nodeData = nodeDatabase[nodeId];
            
            // 生成历史记录（模拟数据，实际项目中应该从真实历史数据获取）
            var historyItems = [
                {
                    time: nodeData.time.created,
                    action: '节点创建',
                    detail: `创建了节点："${nodeData.title}"`
                },
                {
                    time: nodeData.time.modified,
                    action: '最后修改',
                    detail: '更新了节点信息'
                }
            ];
            
            // 如果有标签，添加标签相关历史
            var allTags = [];
            if (nodeData.tags.categories) allTags = allTags.concat(nodeData.tags.categories);
            if (nodeData.tags.technical) allTags = allTags.concat(nodeData.tags.technical);
            if (nodeData.tags.status) allTags = allTags.concat(nodeData.tags.status);
            if (nodeData.tags.custom) allTags = allTags.concat(nodeData.tags.custom);
            
            if (allTags.length > 0) {
                historyItems.push({
                    time: nodeData.time.modified,
                    action: '标签管理',
                    detail: `设置了 ${allTags.length} 个标签：${allTags.slice(0, 3).join('、')}${allTags.length > 3 ? '...' : ''}`
                });
            }
            
            // 如果有内容，添加内容编辑历史
            if (nodeData.content.trim()) {
                historyItems.push({
                    time: nodeData.time.modified,
                    action: '内容编辑',
                    detail: `添加了详细描述（${nodeData.content.length} 字符）`
                });
            }
            
            // 按时间排序
            historyItems.sort((a, b) => new Date(b.time) - new Date(a.time));
            
            var content = `
                <h4>📚 节点历史记录</h4>
                ${historyItems.length > 0 ? 
                    historyItems.map(item => `
                        <div class="history-item">
                            <div class="history-time">${item.time}</div>
                            <div class="history-action">${item.action}</div>
                            <div class="history-detail">${item.detail}</div>
                        </div>
                    `).join('') :
                    `<div class="empty-state">
                        <div class="icon">📚</div>
                        <div>暂无历史记录</div>
                    </div>`
                }
            `;
            
            var historyElement = document.getElementById('history-info-content');
            if (historyElement) {
                historyElement.innerHTML = content;
            }
        }
        
        // 渲染所有标签（用于基本信息选项卡）
        function renderAllTags(nodeId) {
            var nodeData = nodeDatabase[nodeId];
            
            // 确保标签结构完整
            if (!nodeData.tags) {
                nodeData.tags = {
                    categories: [],
                    technical: [],
                    status: [],
                    custom: []
                };
            }
            
            var hasAnyTags = (nodeData.tags.categories && nodeData.tags.categories.length > 0) || 
                           (nodeData.tags.technical && nodeData.tags.technical.length > 0) || 
                           (nodeData.tags.status && nodeData.tags.status.length > 0) ||
                           (nodeData.tags.custom && nodeData.tags.custom.length > 0);
            
            if (!hasAnyTags) {
                return `
                    <div class="info-row">
                        <div class="info-label">标签:</div>
                        <div class="info-value">无标签</div>
                    </div>
                `;
            }
            
            var tagsHTML = '';
            
            if (nodeData.tags.categories && nodeData.tags.categories.length > 0) {
                tagsHTML += `
                    <div class="info-row">
                        <div class="info-label">分类标签:</div>
                        <div class="info-value">
                            <div class="tag-list">
                                ${nodeData.tags.categories.map(tag => `<span class="tag-item">${tag}</span>`).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }
            
            if (nodeData.tags.technical && nodeData.tags.technical.length > 0) {
                tagsHTML += `
                    <div class="info-row">
                        <div class="info-label">技术标签:</div>
                        <div class="info-value">
                            <div class="tag-list">
                                ${nodeData.tags.technical.map(tag => `<span class="tag-item">${tag}</span>`).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }
            
            if (nodeData.tags.status && nodeData.tags.status.length > 0) {
                tagsHTML += `
                    <div class="info-row">
                        <div class="info-label">状态标签:</div>
                        <div class="info-value">
                            <div class="tag-list">
                                ${nodeData.tags.status.map(tag => `<span class="tag-item">${tag}</span>`).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }
            
            if (nodeData.tags.custom && nodeData.tags.custom.length > 0) {
                tagsHTML += `
                    <div class="info-row">
                        <div class="info-label">自定义标签:</div>
                        <div class="info-value">
                            <div class="tag-list">
                                ${nodeData.tags.custom.map(tag => `<span class="tag-item">${tag}</span>`).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }
            
            return tagsHTML;
        }
        
        // 隐藏节点信息面板
        function hideNodeInfoPanel() {
            var panel = document.getElementById('node-info-panel');
            panel.style.display = 'none';
        }

        // 脑图选项卡切换函数
        function switchMindmapTab(tabName) {
            // 先自动保存当前编辑内容
            autoSaveCurrentNodeDetails();
            
            // 更新当前活跃的脑图
            currentMindmap = tabName;
            
            // 清除所有脑图选项卡的active状态
            var tabButtons = document.querySelectorAll('.mindmap-tab-button');
            var tabContents = document.querySelectorAll('.mindmap-tab-content');
            
            tabButtons.forEach(function(btn) {
                btn.classList.remove('active');
            });
            
            tabContents.forEach(function(content) {
                content.classList.remove('active');
            });
            
            // 激活选中的脑图选项卡
            document.querySelector('.mindmap-tab-button[onclick="switchMindmapTab(\'' + tabName + '\')"]').classList.add('active');
            document.getElementById('mindmap-tab-' + tabName).classList.add('active');
            
            // 🎯 修复脑图显示问题：等待DOM更新后重新调整脑图布局
            setTimeout(function() {
                try {
                    // 更新全局jm变量指向当前活跃的脑图
            jm = getCurrentJsMind();
            
                    // 🔧 强制重新调整脑图布局（修复compatibility mode问题）
                    if (jm && typeof jm.resize === 'function') {
                        jm.resize();
                        console.log('✅ 脑图布局已重新调整');
                    }
                    
                    // 如果新脑图有选中的节点，显示其详情
            var selectedNode = jm.get_selected_node();
            if (selectedNode) {
                showNodeDetails(selectedNode.id);
                updateSelectedNodeDisplay();
            } else {
                        // 清除详情显示
                clearNodeDetails();
            }
            
                    console.log('🔄 切换到脑图:', tabName);
                    
                } catch (error) {
                    console.error('❌ 切换脑图标签页时出错:', error);
                }
            }, 100); // 给DOM一点时间完成渲染
        }
        
        // 显示右键菜单
        function showContextMenu(x, y) {
            var menu = document.getElementById('contextMenu');
            menu.style.left = x + 'px';
            menu.style.top = y + 'px';
            menu.style.display = 'block';
            
            // 确保菜单不超出屏幕边界
            var rect = menu.getBoundingClientRect();
            if (rect.right > window.innerWidth) {
                menu.style.left = (x - rect.width) + 'px';
            }
            if (rect.bottom > window.innerHeight) {
                menu.style.top = (y - rect.height) + 'px';
            }
        }
        
        // 隐藏右键菜单
        function hideContextMenu() {
            var menu = document.getElementById('contextMenu');
            menu.style.display = 'none';
            contextMenuTargetNode = null;
        }
        
        // 将焦点节点复制到临时工作区
        function focusNodeToWorkspaces() {
            if (!contextMenuTargetNode) {
                hideContextMenu();
                return;
            }
            
            try {
                // 复制节点及其子树
                var nodeTree = copyNodeTree(contextMenuTargetNode);
                
                // 复制到临时工作区A
                var workspaceData = {
                    meta: {
                        name: "临时工作区A - " + contextMenuTargetNode.topic,
                        author: "NodeMind",
                        version: "1.0.0"
                    },
                    format: "node_tree",
                    data: nodeTree
                };
                mindmaps.workspace.show(workspaceData);
                
                // 复制到标签管理区
                var knowledgeData = {
                    meta: {
                        name: "标签管理 - " + contextMenuTargetNode.topic,
                        author: "NodeMind",
                        version: "1.0.0"
                    },
                    format: "node_tree",
                    data: nodeTree
                };
                mindmaps.knowledge.show(knowledgeData);
                
                showMessage('🔬 已将焦点节点"' + contextMenuTargetNode.topic + '"复制到临时工作区');
                console.log('✅ 焦点节点已复制到临时工作区:', contextMenuTargetNode.topic);
                
                hideContextMenu();
                
            } catch (error) {
                console.error('❌ 复制节点到临时工作区失败:', error);
                showMessage('❌ 复制失败: ' + error.message);
                hideContextMenu();
            }
        }
        
        // 递归复制节点树（保持原始ID和所有详细信息）
        function copyNodeTree(node) {
            var newNode = {
                id: node.id,  // 保持原始节点ID，确保详细信息能正确关联
                topic: node.topic
            };
            
            // 确保节点的详细信息在nodeDatabase中存在
            if (!nodeDatabase[node.id]) {
                // 如果nodeDatabase中没有这个节点的信息，创建默认信息
                nodeDatabase[node.id] = {
                    id: node.id,
                    title: node.topic,
                    content: '',
                    author: '',
                    time: {
                        created: new Date().toLocaleString(),
                        modified: new Date().toLocaleString()
                    },
                    tags: {
                        categories: [],
                        technical: [],
                        status: []
                    }
                };
            }
            
            // 如果有子节点，递归复制
            if (node.children && node.children.length > 0) {
                newNode.children = [];
                node.children.forEach(function(child, index) {
                    var childNode = copyNodeTree(child);
                    // 设置方向：左右交替分布
                    childNode.direction = index % 2 === 0 ? 'right' : 'left';
                    newNode.children.push(childNode);
                });
            }
            
            return newNode;
        }
        
        // 清除节点详情显示
        function clearNodeDetails() {
            var emptyStates = [
                { id: 'basic-info-content', icon: '📋', text: '点击思维导图中的节点查看基本信息' },
                { id: 'detail-info-content', icon: '📝', text: '点击思维导图中的节点编辑详细描述' },
                { id: 'history-info-content', icon: '📚', text: '点击思维导图中的节点查看历史记录' }
            ];
            
            emptyStates.forEach(state => {
                var element = document.getElementById(state.id);
                if (element) {
                    element.innerHTML = `
                        <div class="empty-state">
                            <div class="icon">${state.icon}</div>
                            <div>${state.text}</div>
                        </div>
                    `;
                }
            });
            
            // 清除当前编辑节点ID
            currentEditingNodeId = null;
            
            // 更新状态显示
            document.getElementById('selectedNode').textContent = '无';
        }
        
        // 详情页选项卡切换功能已移除，现在直接显示节点详情
        
        // 保存节点详细信息并同步到所有工作区
        function saveNodeDetails(nodeId) {
            var node = getCurrentJsMind().get_node(nodeId);
            if (!node || !nodeDatabase[nodeId]) return;
            
            // 获取表单数据
            var title = document.getElementById('node_title_' + nodeId).value;
            var content = document.getElementById('node_content_' + nodeId).value;
            var author = document.getElementById('node_author_' + nodeId).value;
            
            // 更新节点数据库
            nodeDatabase[nodeId].title = title;
            nodeDatabase[nodeId].content = content;
            nodeDatabase[nodeId].author = author;
            nodeDatabase[nodeId].time.modified = new Date().toLocaleString();
            
            // 同步更新所有工作区中的相同节点标题
            Object.keys(mindmaps).forEach(function(tabName) {
                var mindmap = mindmaps[tabName];
                var targetNode = mindmap.get_node(nodeId);
                if (targetNode && targetNode.topic !== title) {
                    mindmap.update_node(nodeId, title);
                }
            });
            
            showMessage('💾 节点详细信息已保存');
            
            // 刷新其他选项卡内容（如基本信息选项卡中的作者显示）
            var currentTab = document.querySelector('.tab-content.active');
            if (currentTab && currentTab.id === 'tab-detail') {
                // 如果在详细描述选项卡，可以选择性刷新基本信息选项卡的内容
                setTimeout(() => {
                    renderBasicInfo(nodeId);
                }, 100);
            }
            
            // 自动保存到本地存储
            setTimeout(autoSaveData, 200);
        }
        
        // 重置节点详细信息
        function resetNodeDetails(nodeId) {
            var activeTab = document.querySelector('.tab-content.active');
            if (activeTab) {
                var tabName = activeTab.id.replace('tab-', '');
                refreshTabContent(tabName, nodeId);
            }
            showMessage('节点详细信息已重置');
        }
        
        // 更新节点标题
        function updateNodeTitle(nodeId, newTitle) {
            var node = jm.get_node(nodeId);
            if (node && newTitle && newTitle.trim()) {
                jm.update_node(nodeId, newTitle.trim());
                nodeDatabase[nodeId].title = newTitle.trim();
                nodeDatabase[nodeId].time.modified = new Date().toLocaleString();
            }
        }
        
        // 从输入框添加标签（已废弃 - 界面简化）
        function addTagFromInput(nodeId, tagType) {
            // 功能已移除，使用标签同步按钮代替
            showMessage('请使用"标签同步"按钮从标签管理脑图同步标签');
        }
        

        
        // 获取标签类型中文名称
        
        // ================ 标签管理系统 ================
        
        // 初始化标签管理系统
        function initTagManagement() {
            console.log('🏷️ 初始化标签管理系统...');
            
            // 从localStorage加载标签数据
            loadTagDatabase();
            
            // 同步标签到脑图显示
            syncTagsToMindmap();
            
            // 监听标签管理脑图的变化
            bindTagMindmapEvents();
            
            console.log('✅ 标签管理系统初始化完成');
        }
        
        // 加载标签数据库
        function loadTagDatabase() {
            try {
                var savedTags = localStorage.getItem('TAG_DATABASE');
                if (savedTags) {
                    tagDatabase = JSON.parse(savedTags);
                    console.log('📥 已加载标签数据:', tagDatabase);
                } else {
                    // 初始化默认标签
                    tagDatabase = {
                        categories: ['前端', '后端', '数据库', '测试', '部署'],
                        technical: ['JavaScript', 'Python', 'HTML', 'CSS', 'SQL'],
                        status: ['待开始', '进行中', '已完成', '已暂停', '需审核'],
                        custom: ['重要', '紧急', '优化', '修复', '新功能']
                    };
                    saveTagDatabase();
                }
            } catch (error) {
                console.error('❌ 加载标签数据失败:', error);
                // 使用默认标签
                tagDatabase = {
                    categories: ['前端', '后端', '数据库'],
                    technical: ['JavaScript', 'Python', 'HTML'],
                    status: ['待开始', '进行中', '已完成'],
                    custom: ['重要', '紧急', '优化']
                };
            }
        }
        
        // 保存标签数据库
        function saveTagDatabase() {
            try {
                localStorage.setItem('TAG_DATABASE', JSON.stringify(tagDatabase));
                console.log('💾 标签数据已保存');
            } catch (error) {
                console.error('❌ 保存标签数据失败:', error);
            }
        }
        
        // 同步标签到脑图显示
        function syncTagsToMindmap() {
            if (!mindmaps.knowledge) return;
            
            try {
                // 更新各个标签分类的子节点
                updateTagCategory('category_tags', tagDatabase.categories);
                updateTagCategory('technical_tags', tagDatabase.technical);
                updateTagCategory('status_tags', tagDatabase.status);
                updateTagCategory('custom_tags', tagDatabase.custom);
                
                console.log('🔄 标签已同步到脑图显示');
            } catch (error) {
                console.error('❌ 同步标签到脑图失败:', error);
            }
        }
        
        // 更新标签分类的子节点
        function updateTagCategory(categoryId, tags) {
            var categoryNode = mindmaps.knowledge.get_node(categoryId);
            if (!categoryNode) return;
            
            // 删除现有子节点
            if (categoryNode.children) {
                [...categoryNode.children].forEach(child => {
                    mindmaps.knowledge.remove_node(child.id);
                });
            }
            
            // 添加新的标签节点
            tags.forEach((tag, index) => {
                var tagId = categoryId + '_tag_' + index;
                mindmaps.knowledge.add_node(categoryNode, tagId, tag);
            });
        }
        
        // 监听标签管理脑图的变化
        function bindTagMindmapEvents() {
            if (!mindmaps.knowledge) return;
            
            // 监听节点添加事件
            mindmaps.knowledge.add_event_listener(function(type, data) {
                if (type === 'edit_node' || type === 'add_node' || type === 'remove_node') {
                    // 延迟同步，避免事件冲突
                    setTimeout(() => {
                        syncMindmapToTagDatabase();
                    }, 100);
                }
            });
            
            console.log('🎯 标签脑图事件监听已绑定');
        }
        
        // 🎯 确保标签管理脑图有默认标签数据
        function ensureDefaultTagsInMindmap() {
            if (!mindmaps.knowledge) {
                console.log('❌ 标签管理脑图未初始化');
                return;
            }
            
            try {
                console.log('🏷️ 检查并添加默认标签到脑图...');
                
                // 检查各个分类节点是否有子节点，如果没有则添加默认标签
                const defaultTags = {
                    'category_tags': ['前端', '后端', '数据库', '测试', '部署'],
                    'technical_tags': ['JavaScript', 'Python', 'HTML', 'CSS', 'SQL'],
                    'status_tags': ['待开始', '进行中', '已完成', '已暂停', '需审核'],
                    'custom_tags': ['重要', '紧急', '优化', '修复', '新功能']
                };
                
                Object.keys(defaultTags).forEach(categoryId => {
                    const categoryNode = mindmaps.knowledge.get_node(categoryId);
                    if (categoryNode) {
                        // 如果分类节点没有子节点，添加默认标签
                        if (!categoryNode.children || categoryNode.children.length === 0) {
                            console.log(`📂 为 ${categoryId} 添加默认标签...`);
                            defaultTags[categoryId].forEach((tag, index) => {
                                const tagId = categoryId + '_default_' + index;
                                mindmaps.knowledge.add_node(categoryNode, tagId, tag);
                            });
                        } else {
                            console.log(`✅ ${categoryId} 已有 ${categoryNode.children.length} 个标签`);
                        }
                    } else {
                        console.log(`❌ 未找到分类节点: ${categoryId}`);
                    }
                });
                
                // 同步到标签数据库
                setTimeout(() => {
                    syncMindmapToTagDatabase();
                    console.log('✅ 默认标签已添加并同步到数据库');
                }, 200);
                
            } catch (error) {
                console.error('❌ 添加默认标签失败:', error);
            }
        }
        
        // 从脑图同步到标签数据库
        function syncMindmapToTagDatabase() {
            if (!mindmaps.knowledge) return;
            
            try {
                // 获取各个分类的子节点
                var newTagDatabase = {
                    categories: getTagsFromCategory('category_tags'),
                    technical: getTagsFromCategory('technical_tags'),
                    status: getTagsFromCategory('status_tags'),
                    custom: getTagsFromCategory('custom_tags')
                };
                
                // 更新标签数据库
                tagDatabase = newTagDatabase;
                
                // 保存到localStorage
                saveTagDatabase();
                
                console.log('🔄 脑图变化已同步到标签数据库:', tagDatabase);
                
            } catch (error) {
                console.error('❌ 同步脑图到标签数据库失败:', error);
            }
        }
        
        // 获取指定分类的所有标签
        function getTagsFromCategory(categoryId) {
            var categoryNode = mindmaps.knowledge.get_node(categoryId);
            if (!categoryNode || !categoryNode.children) return [];
            
            return categoryNode.children.map(child => child.topic).filter(topic => topic && topic.trim());
        }
        
                 // 获取所有可用标签（供详情页使用）
         function getAllAvailableTags() {
             return {
                 categories: [...tagDatabase.categories],
                 technical: [...tagDatabase.technical],
                 status: [...tagDatabase.status],
                 custom: [...tagDatabase.custom]
             };
         }
         
         // 获取可用标签选项HTML
         function getAvailableTagOptions(tagType) {
             if (!tagDatabase[tagType]) return '';
             
             return tagDatabase[tagType].map(tag => 
                 `<option value="${tag}">${tag}</option>`
             ).join('');
         }
         
         // 从下拉选择添加标签（已废弃 - 界面简化）
         function addTagFromSelect(nodeId, tagType) {
             // 功能已移除，使用标签同步按钮代替
             showMessage('请使用"标签同步"按钮从标签管理脑图同步标签');
         }
         
         // 添加节点标签（重命名原addTag函数）
         function addNodeTag(nodeId, tagType, tagValue) {
            if (!tagValue || !tagValue.trim()) return;
            
            tagValue = tagValue.trim();
            
             // 检查是否已存在相同标签
            if (nodeDatabase[nodeId].tags[tagType].includes(tagValue)) {
                 showMessage('标签已存在：' + tagValue);
                return;
            }
            
             // 添加标签
            nodeDatabase[nodeId].tags[tagType].push(tagValue);
            
             // 更新修改时间
            nodeDatabase[nodeId].time.modified = new Date().toLocaleString();
            
             showMessage('已添加' + getTagTypeLabel(tagType) + '：' + tagValue);
            
             // 刷新详情显示
             renderDetailInfo(nodeId);
             
             // 自动保存
            setTimeout(autoSaveData, 200);
        }
        
         // 删除节点标签（重命名原removeTag函数）
         function removeNodeTag(nodeId, tagType, tagValue) {
             var index = nodeDatabase[nodeId].tags[tagType].indexOf(tagValue);
             if (index > -1) {
                 nodeDatabase[nodeId].tags[tagType].splice(index, 1);
                 nodeDatabase[nodeId].time.modified = new Date().toLocaleString();
                 
                 showMessage('已删除' + getTagTypeLabel(tagType) + '：' + tagValue);
                 
                 // 刷新详情显示
                 renderDetailInfo(nodeId);
                 
                 // 自动保存
                 setTimeout(autoSaveData, 200);
             }
         }
         
                 // 🎯 全局标签同步函数 - 供PyQt调用
        window.syncTagsFromMindmap = function(nodeId) {
            return syncTagsFromMindmapInternal(nodeId);
        };
        
        // 🎯 测试函数 - 同步当前选中节点的标签
        window.testTagSync = function() {
            var selectedNode = getCurrentJsMind().get_selected_node();
            if (selectedNode) {
                console.log('🧪 测试标签同步，选中节点:', selectedNode.topic);
                return syncTagsFromMindmapInternal(selectedNode.id);
            } else {
                console.log('❌ 请先选中一个节点');
                showMessage('❌ 请先选中一个节点');
                return false;
            }
        };
        
        // 🔄 标签同步功能 - 从脑图管理按键组调用
        window.syncCurrentNodeTags = function() {
            var jm = getCurrentJsMind();
            var selectedNode = jm.get_selected_node();
            
            if (!selectedNode) {
                showMessage('❌ 请先选择一个节点');
                return;
            }
            
            // 调用标签同步函数
            syncTagsFromMindmapToNode(selectedNode.id);
        };

        // 🔧 调试标签同步功能
        window.debugTagSync = function() {
            console.log('🔧 开始调试标签同步功能...');
            
            try {
                // 1. 检查关键函数是否存在
                const requiredFunctions = [
                    'syncTagsFromMindmap',
                    'testTagSync', 
                    'syncTagsFromMindmapInternal',
                    'ensureDefaultTagsInMindmap',
                    'syncMindmapToTagDatabase',
                    'loadTagDatabase',
                    'saveTagDatabase'
                ];

                console.log('📋 检查函数存在性:');
                let allFunctionsExist = true;
                requiredFunctions.forEach(funcName => {
                    const exists = typeof window[funcName] === 'function';
                    console.log(`${exists ? '✅' : '❌'} ${funcName}: ${exists ? '存在' : '不存在'}`);
                    if (!exists) allFunctionsExist = false;
                });

                // 2. 检查全局变量
                console.log('\n📊 检查全局变量:');
                const globalVars = ['tagDatabase', 'nodeDatabase', 'mindmaps', 'currentMindmap'];
                globalVars.forEach(varName => {
                    const exists = typeof window[varName] !== 'undefined';
                    console.log(`${exists ? '✅' : '❌'} ${varName}: ${exists ? '存在' : '不存在'}`);
                    if (exists && varName === 'tagDatabase') {
                        console.log('   📝 tagDatabase内容:', window[varName]);
                    }
                });

                // 3. 检查标签管理脑图
                console.log('\n🏷️ 检查标签管理脑图:');
                if (window.mindmaps && window.mindmaps.knowledge) {
                    console.log('✅ 标签管理脑图存在');
                    
                    const categoryNodes = ['category_tags', 'technical_tags', 'status_tags', 'custom_tags'];
                    categoryNodes.forEach(nodeId => {
                        const node = window.mindmaps.knowledge.get_node(nodeId);
                        if (node) {
                            const childCount = node.children ? node.children.length : 0;
                            console.log(`   📂 ${nodeId}: ${childCount} 个子标签`);
                            if (node.children && node.children.length > 0) {
                                const tags = node.children.map(child => child.topic).slice(0, 3);
                                console.log(`      标签示例: ${tags.join(', ')}${childCount > 3 ? '...' : ''}`);
                            }
                        } else {
                            console.log(`   ❌ ${nodeId}: 节点不存在`);
                        }
                    });
                } else {
                    console.log('❌ 标签管理脑图不存在');
                }

                // 4. 🎯 修复：确保在标签管理脑图中进行测试
                console.log('\n🧪 测试标签同步功能:');
                
                // 首先确保我们在标签管理脑图中
                if (currentMindmap !== 'knowledge') {
                    console.log('🔄 切换到标签管理脑图进行测试...');
                    switchMindmapTab('knowledge');
                    
                    // 等待切换完成后继续测试
                    setTimeout(() => {
                        performTagSyncTest(allFunctionsExist);
                    }, 600);
                } else {
                    performTagSyncTest(allFunctionsExist);
                }
                
            } catch (error) {
                console.error('❌ 调试过程出错:', error);
                showMessage('❌ 调试过程出错: ' + error.message);
            }
        };
        
        // 🎯 执行标签同步测试的辅助函数
        function performTagSyncTest(allFunctionsExist) {
            try {
                if (typeof window.testTagSync === 'function') {
                    // 在标签管理脑图中选择一个分类节点进行测试
                    if (window.mindmaps && window.mindmaps.knowledge) {
                        const root = window.mindmaps.knowledge.get_root();
                        if (root && root.children && root.children.length > 0) {
                            // 选择第一个分类节点（如分类标签）
                            const testNode = root.children[0];
                            window.mindmaps.knowledge.select_node(testNode.id);
                            console.log(`✅ 已选中标签管理测试节点: ${testNode.topic}`);
                            
                            // 🎯 确保节点数据存在
                            if (!nodeDatabase[testNode.id]) {
                                nodeDatabase[testNode.id] = {
                                    id: testNode.id,
                                    title: testNode.topic,
                                    content: '标签分类节点',
                                    relations: {
                                        parent: testNode.parent ? testNode.parent.id : null,
                                        children: testNode.children ? testNode.children.map(child => child.id) : []
                                    },
                                    tags: {
                                        categories: [],
                                        technical: [],
                                        status: [],
                                        custom: []
                                    },
                                    time: {
                                        created: new Date().toLocaleString(),
                                        modified: new Date().toLocaleString()
                                    },
                                    author: '系统'
                                };
                                console.log('✅ 已创建测试节点数据');
                            }
                            
                            // 执行标签同步测试
                            const result = window.testTagSync();
                            console.log(`🔄 标签同步测试结果: ${result ? '成功' : '失败'}`);
                            
                            // 🎯 强制刷新详情面板显示
                            setTimeout(() => {
                                showNodeDetails(testNode.id);
                                sendNodeDetailsToQt(testNode.id);
                            }, 300);
                            
                            showMessage(`🔧 调试完成！${allFunctionsExist ? '所有函数正常' : '部分函数缺失'}，请查看控制台详情`);
                        } else {
                            console.log('❌ 标签管理脑图没有可用的测试节点');
                            showMessage('❌ 标签管理脑图没有可用的测试节点');
                        }
                    } else {
                        console.log('❌ 标签管理脑图不存在');
                        showMessage('❌ 标签管理脑图不存在');
                    }
                } else {
                    console.log('❌ testTagSync函数不存在');
                    showMessage('❌ testTagSync函数不存在');
                }
                
                console.log('\n🎯 调试完成！');
                
            } catch (error) {
                console.error('❌ 标签同步测试失败:', error);
                showMessage('❌ 标签同步测试失败: ' + error.message);
            }
        }
        
        // 从标签脑图同步标签到当前节点
        function syncTagsFromMindmapInternal(nodeId) {
            try {
                console.log('🔄 开始标签同步，节点ID:', nodeId);
                
                // 🎯 首先确保节点数据存在
                if (!nodeDatabase[nodeId]) {
                    console.log('🔧 节点数据不存在，正在创建...');
                    var node = getCurrentJsMind().get_node(nodeId);
                    if (!node) {
                        console.error('❌ 无法找到节点:', nodeId);
                        showMessage('❌ 无法找到节点');
                        return false;
                    }
                    
                    // 创建节点数据
                    nodeDatabase[nodeId] = {
                        id: nodeId,
                        title: node.topic,
                        content: '',
                        relations: {
                            parent: node.parent ? node.parent.id : null,
                            children: node.children ? node.children.map(child => child.id) : []
                        },
                        tags: {
                            categories: [],
                            technical: [],
                            status: [],
                            custom: []
                        },
                        time: {
                            created: new Date().toLocaleString(),
                            modified: new Date().toLocaleString()
                        },
                        author: ''
                    };
                    console.log('✅ 节点数据已创建');
                }
                
                // 确保标签数据库是最新的
                syncMindmapToTagDatabase();
                
                console.log('📊 当前标签数据库状态:', tagDatabase);
                console.log('🎯 当前节点数据:', nodeDatabase[nodeId]);
                
                // 清空当前节点的所有标签
                nodeDatabase[nodeId].tags = {
                    categories: [],
                    technical: [],
                    status: [],
                    custom: []
                };
                
                // 从标签数据库同步所有可用标签到当前节点
                var syncedCount = 0;
                
                // 同步分类标签
                if (tagDatabase.categories && tagDatabase.categories.length > 0) {
                    nodeDatabase[nodeId].tags.categories = [...tagDatabase.categories];
                    syncedCount += tagDatabase.categories.length;
                    console.log('📂 同步分类标签:', tagDatabase.categories.length, '个');
                }
                
                // 同步技术标签
                if (tagDatabase.technical && tagDatabase.technical.length > 0) {
                    nodeDatabase[nodeId].tags.technical = [...tagDatabase.technical];
                    syncedCount += tagDatabase.technical.length;
                    console.log('⚙️ 同步技术标签:', tagDatabase.technical.length, '个');
                }
                
                // 同步状态标签
                if (tagDatabase.status && tagDatabase.status.length > 0) {
                    nodeDatabase[nodeId].tags.status = [...tagDatabase.status];
                    syncedCount += tagDatabase.status.length;
                    console.log('📊 同步状态标签:', tagDatabase.status.length, '个');
                }
                
                // 同步自定义标签
                if (tagDatabase.custom && tagDatabase.custom.length > 0) {
                    nodeDatabase[nodeId].tags.custom = [...tagDatabase.custom];
                    syncedCount += tagDatabase.custom.length;
                    console.log('🎨 同步自定义标签:', tagDatabase.custom.length, '个');
                }
                
                // 更新修改时间
                nodeDatabase[nodeId].time.modified = new Date().toLocaleString();
                
                console.log('🔄 同步后节点标签:', nodeDatabase[nodeId].tags);
                
                // 刷新详情页显示
                renderDetailInfo(nodeId);
                
                // 自动保存
                setTimeout(autoSaveData, 200);
                
                showMessage(`✅ 标签同步完成！已同步 ${syncedCount} 个标签到当前节点`);
                
                console.log('✅ 标签同步完成:', {
                    nodeId: nodeId,
                    syncedTags: nodeDatabase[nodeId].tags,
                    totalCount: syncedCount
                });
                
            } catch (error) {
                console.error('❌ 标签同步失败:', error);
                showMessage('❌ 标签同步失败: ' + error.message);
            }
        }
        function getTagTypeLabel(tagType) {
            switch(tagType) {
                case 'categories': return '分类标签';
                case 'technical': return '技术标签';
                case 'status': return '状态标签';
                default: return '标签';
            }
        }
        
        // 移除标签
        function removeTag(nodeId, tagType, tagValue) {
            // 从数组中移除标签
            var index = nodeDatabase[nodeId].tags[tagType].indexOf(tagValue);
            if (index !== -1) {
                nodeDatabase[nodeId].tags[tagType].splice(index, 1);
            }
            
            // 更新修改时间
            nodeDatabase[nodeId].time.modified = new Date().toLocaleString();
            
            showMessage('已移除' + getTagTypeLabel(tagType) + '：' + tagValue);
            
            // 刷新当前选项卡内容
            var activeTab = document.querySelector('.tab-content.active');
            if (activeTab) {
                var tabName = activeTab.id.replace('tab-', '');
                refreshTabContent(tabName, nodeId);
            }
            
            // 自动保存
            setTimeout(autoSaveData, 200);
        }
        
        // 更新节点关系
        function updateNodeRelations(nodeId) {
            var node = jm.get_node(nodeId);
            if (!node || !nodeDatabase[nodeId]) return;
            
            // 更新父节点关系
            nodeDatabase[nodeId].relations.parent = node.parent ? node.parent.id : null;
            
            // 更新子节点关系
            nodeDatabase[nodeId].relations.children = node.children ? node.children.map(child => child.id) : [];
            
            // 如果当前节点是选中节点，更新显示
            var selected = jm.get_selected_node();
            if (selected && selected.id === nodeId) {
                showNodeDetails(nodeId);
            }
        }
        
        // 获取节点路径
        function getNodePath(node) {
            var path = [];
            var current = node;
            
            while (current) {
                path.unshift(`<span>${current.topic}</span>`);
                current = current.parent;
            }
            
            return path;
        }
        
        // 获取节点的自定义属性
        function getCustomProperties(node) {
            var props = [];
            var standardProps = ['id', 'topic', 'direction', 'expanded', 'parent', 'children', 'data', '_data', 'isroot'];
            
            for (var key in node) {
                if (node.hasOwnProperty(key) && !standardProps.includes(key)) {
                    var value = node[key];
                    if (typeof value !== 'function' && typeof value !== 'object') {
                        props.push({
                            key: key,
                            value: value
                        });
                    }
                }
            }
            
            return props;
        }

        // 设置自动保存
        function setupAutoSave() {
            // 定期自动保存（每30秒）
            setInterval(function() {
                autoSaveCurrentNodeDetails(); // 保存当前编辑内容
                autoSaveData();
            }, 30000);
            
            // 页面离开时保存
            window.addEventListener('beforeunload', function() {
                autoSaveCurrentNodeDetails(); // 保存当前编辑内容
                autoSaveData();
            });
            
            // 页面失去焦点时保存
            window.addEventListener('blur', function() {
                autoSaveCurrentNodeDetails(); // 保存当前编辑内容
                autoSaveData();
            });
        }

        // 当前正在编辑的节点ID（用于自动保存）
        var currentEditingNodeId = null;
        
        // 🎯 修复版：兼容统一数据结构和nodeDatabase的自动保存机制
        function autoSaveCurrentNodeDetails() {
            if (!currentEditingNodeId) return;
            
            try {
                var node = getCurrentJsMind().get_node(currentEditingNodeId);
                if (!node) return;
                
                // 确保nodeDatabase中有节点数据（保持向后兼容）
                if (!nodeDatabase[currentEditingNodeId]) {
                    nodeDatabase[currentEditingNodeId] = {
                        id: currentEditingNodeId,
                        title: node.topic,
                        content: '',
                        relations: {
                            parent: node.parent ? node.parent.id : null,
                            children: node.children ? node.children.map(child => child.id) : []
                        },
                        tags: { categories: [], technical: [], status: [] },
                        time: { created: new Date().toLocaleString(), modified: new Date().toLocaleString() },
                        author: ''
                    };
                }
                
                // 同时确保node.data存在（新的统一数据结构）
                if (!node.data) {
                    node.data = {
                        content: nodeDatabase[currentEditingNodeId].content || '',
                        summary: '',
                        author: nodeDatabase[currentEditingNodeId].author || '',
                        tags: { 
                            categories: nodeDatabase[currentEditingNodeId].tags.categories || [], 
                            technical: nodeDatabase[currentEditingNodeId].tags.technical || [], 
                            status: nodeDatabase[currentEditingNodeId].tags.status || [],
                            priority: '', 
                            custom: [] 
                        },
                        time: { 
                            created: nodeDatabase[currentEditingNodeId].time.created || new Date().toISOString(), 
                            modified: nodeDatabase[currentEditingNodeId].time.modified || new Date().toISOString() 
                        },
                        relations: nodeDatabase[currentEditingNodeId].relations || { references: [], dependencies: [], links: [] },
                        metadata: { version: '1.0', source: 'manual', confidence: 1.0 },
                        collaboration: { assignee: '', reviewers: [], comments: [], attachments: [] },
                        flags: { isComplete: false, isArchived: false, hasUnsavedChanges: false }
                    };
                }
                
                var titleEl = document.getElementById('node_title_' + currentEditingNodeId);
                var contentEl = document.getElementById('node_content_' + currentEditingNodeId);
                var authorEl = document.getElementById('node_author_' + currentEditingNodeId);
                
                if (titleEl && contentEl && authorEl) {
                    var hasChanges = false;
                    
                    // 检查并更新标题
                    if (titleEl.value !== nodeDatabase[currentEditingNodeId].title) {
                        nodeDatabase[currentEditingNodeId].title = titleEl.value;
                        getCurrentJsMind().update_node(currentEditingNodeId, titleEl.value);
                        hasChanges = true;
                        
                        // 同步更新所有工作区中的相同节点标题
                        Object.keys(mindmaps).forEach(function(tabName) {
                            var mindmap = mindmaps[tabName];
                            var targetNode = mindmap.get_node(currentEditingNodeId);
                            if (targetNode && targetNode.topic !== titleEl.value) {
                                mindmap.update_node(currentEditingNodeId, titleEl.value);
                            }
                        });
                    }
                    
                    // 检查并更新详细内容（同时保存到两处）
                    if (contentEl.value !== nodeDatabase[currentEditingNodeId].content) {
                        nodeDatabase[currentEditingNodeId].content = contentEl.value;
                        node.data.content = contentEl.value;
                        hasChanges = true;
                    }
                    
                    // 检查并更新作者（同时保存到两处）
                    if (authorEl.value !== nodeDatabase[currentEditingNodeId].author) {
                        nodeDatabase[currentEditingNodeId].author = authorEl.value;
                        node.data.author = authorEl.value;
                        hasChanges = true;
                    }
                    
                    if (hasChanges) {
                        // 更新时间戳
                        nodeDatabase[currentEditingNodeId].time.modified = new Date().toLocaleString();
                        node.data.time.modified = new Date().toISOString();
                        node.data.flags.hasUnsavedChanges = false;
                        
                        console.log('🔄 兼容版自动保存:', currentEditingNodeId, '内容长度:', contentEl.value.length);
                        
                        // 触发持久化存储
                        setTimeout(autoSaveData, 100);
                    }
                }
            } catch (error) {
                console.error('兼容版自动保存失败:', error);
            }
        }

        // 为所有脑图实例添加事件监听
        function addEventListenersToAllMindmaps() {
            Object.keys(mindmaps).forEach(function(tabName) {
                var mindmap = mindmaps[tabName];
                
                mindmap.add_event_listener(function(type, data) {
                    // 确保当前脑图标签被激活
                    if (currentMindmap !== tabName) {
                        switchMindmapTab(tabName);
                    }
                    
                    if (type === 'select_node') {
                        // 在切换到新节点前，先自动保存当前编辑节点的详细内容
                        autoSaveCurrentNodeDetails();
                        
                        updateSelectedNodeDisplay();
                        showNodeDetails(data.node.id);
                        console.log('选中' + tabName + '节点:', data.node.topic);
                        // 自动保存选中状态
                        setTimeout(autoSaveData, 100);
                    } else if (type === 'edit_node') {
                        showNodeDetails(data.node.id);
                        console.log('编辑' + tabName + '节点:', data.node.topic);
                        // 自动保存编辑
                        setTimeout(autoSaveData, 500);
                    } else if (type === 'move_node') {
                        showMessage('🔀 节点已移动: ' + data.node.topic);
                        console.log('移动' + tabName + '节点:', data.node.topic, '到新位置');
                        updateSelectedNodeDisplay();
                        updateNodeRelations(data.node.id);
                        if (data.parent_node) {
                            updateNodeRelations(data.parent_node.id);
                        }
                        // 自动保存移动操作
                        setTimeout(autoSaveData, 200);
                    } else if (type === 'add_node') {
                        updateNodeRelations(data.node.id);
                        if (data.parent_node) {
                            updateNodeRelations(data.parent_node.id);
                        }
                        showNodeDetails(data.node.id);
                        // 自动保存新增节点
                        setTimeout(autoSaveData, 200);
                    } else if (type === 'remove_node') {
                        if (data.parent_node) {
                            updateNodeRelations(data.parent_node.id);
                        }
                        // 自动保存删除操作
                        setTimeout(autoSaveData, 200);
                    }
                });
            });
        }
        
        // 为所有脑图添加事件监听器
        addEventListenersToAllMindmaps();
        
        // 🎯 修复：注释掉未定义的initVirtualCenterSystem函数调用
        // initVirtualCenterSystem();

        // 持久化存储相关常量
        var STORAGE_KEYS = {
            MINDMAP_DATA: 'nodemind_mindmap_data',
            NODE_DATABASE: 'nodemind_node_database', 
            CURRENT_THEME: 'nodemind_current_theme',
            DRAG_ENABLED: 'nodemind_drag_enabled',
            SELECTED_NODE: 'nodemind_selected_node',
            VIEW_DATA: 'nodemind_view_data'
        };
        
        // 🎯 修复版：兼容性自动保存函数
        function autoSaveData() {
            try {
                // 保存所有脑图的数据
                var allMindmapData = {};
                Object.keys(mindmaps).forEach(function(tabName) {
                    if (mindmaps[tabName]) {
                        allMindmapData[tabName] = mindmaps[tabName].get_data();
                    }
                });
                
                if (Object.keys(allMindmapData).length > 0) {
                    // 保存所有思维导图数据
                    localStorage.setItem(STORAGE_KEYS.MINDMAP_DATA, JSON.stringify(allMindmapData));
                    
                    // 🎯 保持兼容性：继续保存nodeDatabase
                    localStorage.setItem(STORAGE_KEYS.NODE_DATABASE, JSON.stringify(nodeDatabase));
                    
                    // 保存当前主题
                    localStorage.setItem(STORAGE_KEYS.CURRENT_THEME, currentThemeIndex.toString());
                    
                    // 保存拖拽状态
                    localStorage.setItem(STORAGE_KEYS.DRAG_ENABLED, isDragEnabled.toString());
                    
                    // 保存当前活跃的脑图选项卡
                    localStorage.setItem('nodemind_current_mindmap', currentMindmap);
                    
                    // 保存选中节点
                    var selectedNode = getCurrentJsMind().get_selected_node();
                    if (selectedNode) {
                        localStorage.setItem(STORAGE_KEYS.SELECTED_NODE, selectedNode.id);
                    }
                    
                    console.log('✅ 数据已自动保存（兼容模式 - 包含所有脑图）');
                }
            } catch (error) {
                console.error('自动保存失败:', error);
            }
        }
        
        // 🔄 PyQt向HTML回传数据的接收函数（双向数据同步的核心）
        window.pyqtSaveNodeContent = function(nodeData) {
            try {
                console.log('🔄 接收到PyQt数据:', nodeData);
                
                var nodeId = nodeData.nodeId;
                var node = getCurrentJsMind().get_node(nodeId);
                
                if (!node) {
                    console.error('❌ 节点不存在:', nodeId);
                    return false;
                }
                
                var hasChanges = false;
                
                // 🔧 优先确保统一数据结构存在 - 修复"Cannot set property 'custom' of undefined"错误
                if (!node.data) {
                    node.data = {
                        content: '', summary: '', author: '',
                        tags: { categories: [], technical: [], status: [], priority: '', custom: [] },
                        time: { created: new Date().toISOString(), modified: new Date().toISOString() },
                        relations: { references: [], dependencies: [], links: [] },
                        metadata: { version: '1.0', source: 'manual', confidence: 1.0 },
                        collaboration: { assignee: '', reviewers: [], comments: [], attachments: [] },
                        flags: { isComplete: false, isArchived: false, hasUnsavedChanges: false }
                    };
                    console.log('✅ 统一数据结构已初始化:', nodeId);
                }
                
                // 🔧 确保标签对象结构完整（容错处理）
                if (!node.data.tags || typeof node.data.tags !== 'object') {
                    node.data.tags = { categories: [], technical: [], status: [], priority: '', custom: [] };
                }
                if (!Array.isArray(node.data.tags.categories)) node.data.tags.categories = [];
                if (!Array.isArray(node.data.tags.technical)) node.data.tags.technical = [];
                if (!Array.isArray(node.data.tags.status)) node.data.tags.status = [];
                if (!Array.isArray(node.data.tags.custom)) node.data.tags.custom = [];
                if (!node.data.tags.priority) node.data.tags.priority = '';
                
                // 更新节点标题
                if (nodeData.title && node.topic !== nodeData.title) {
                    getCurrentJsMind().update_node(nodeId, nodeData.title);
                    hasChanges = true;
                    console.log('✅ 节点标题已更新:', nodeData.title);
                }
                
                // 更新节点内容（统一数据结构）
                if (nodeData.content !== undefined && node.data.content !== nodeData.content) {
                    node.data.content = nodeData.content;
                    hasChanges = true;
                    console.log('✅ 节点内容已更新:', nodeData.content.length + '字符');
                }
                
                // 更新作者信息（统一数据结构）
                if (nodeData.author !== undefined && node.data.author !== nodeData.author) {
                    node.data.author = nodeData.author;
                    hasChanges = true;
                    console.log('✅ 节点作者已更新:', nodeData.author);
                }
                
                // 🏷️ 增强标签信息处理
                if (nodeData.tags && Array.isArray(nodeData.tags)) {
                    // 更新统一数据结构中的自定义标签
                    node.data.tags.custom = nodeData.tags;
                    
                    // 同时将标签分类到不同类型（智能分类）
                    nodeData.tags.forEach(function(tag) {
                        var lowerTag = tag.toLowerCase();
                        // 技术类标签
                        if (['bug', '技术', '开发', '代码', '测试', 'javascript', 'python', 'html', 'css'].some(keyword => lowerTag.includes(keyword))) {
                            if (!node.data.tags.technical.includes(tag)) {
                                node.data.tags.technical.push(tag);
                            }
                        }
                        // 状态类标签
                        else if (['完成', '进行中', '待办', '已完成', '未开始', '暂停', '取消'].some(keyword => lowerTag.includes(keyword))) {
                            if (!node.data.tags.status.includes(tag)) {
                                node.data.tags.status.push(tag);
                            }
                        }
                        // 分类标签
                        else {
                            if (!node.data.tags.categories.includes(tag)) {
                                node.data.tags.categories.push(tag);
                            }
                        }
                    });
                    
                    hasChanges = true;
                    console.log('✅ 节点标签已更新（智能分类）:', {
                        custom: node.data.tags.custom,
                        technical: node.data.tags.technical,
                        status: node.data.tags.status,
                        categories: node.data.tags.categories
                    });
                }
                
                // 📅 增强时间信息处理
                var timeUpdated = false;
                
                // 处理创建时间
                if (nodeData.createdTime && (!node.data.time.created || node.data.time.created === '')) {
                    node.data.time.created = new Date(nodeData.createdTime).toISOString();
                    timeUpdated = true;
                }
                
                // 处理修改时间（总是更新）
                node.data.time.modified = new Date().toISOString();
                timeUpdated = true;
                
                // 添加保存时间戳
                if (nodeData.saveTimestamp) {
                    node.data.time.lastSaved = new Date(nodeData.saveTimestamp).toISOString();
                    timeUpdated = true;
                }
                
                if (timeUpdated) {
                    hasChanges = true;
                    console.log('✅ 节点时间信息已更新:', {
                        created: node.data.time.created,
                        modified: node.data.time.modified,
                        lastSaved: node.data.time.lastSaved || '未设置'
                    });
                }
                
                // 🎯 优先级信息处理（从标签中提取）
                if (nodeData.tags && Array.isArray(nodeData.tags)) {
                    var priorityTags = nodeData.tags.filter(tag => 
                        ['高优先级', '中优先级', '低优先级', '紧急', '重要', '一般', '高', '中', '低'].includes(tag)
                    );
                    if (priorityTags.length > 0) {
                        node.data.tags.priority = priorityTags[0];
                        console.log('✅ 节点优先级已更新:', node.data.tags.priority);
                    }
                }
                
                // 📊 元数据信息处理
                if (nodeData.formSource) {
                    node.data.metadata.source = nodeData.formSource;
                    hasChanges = true;
                }
                
                if (nodeData.dataComplete !== undefined) {
                    node.data.flags.hasUnsavedChanges = !nodeData.dataComplete;
                    hasChanges = true;
                }
                
                // 统计信息处理
                if (nodeData.tagsCount !== undefined) {
                    node.data.metadata.tagsCount = nodeData.tagsCount;
                    hasChanges = true;
                }
                
                if (nodeData.hasCustomTags !== undefined) {
                    node.data.flags.hasCustomTags = nodeData.hasCustomTags;
                    hasChanges = true;
                    console.log('✅ 节点元数据已更新:', {
                        source: node.data.metadata.source,
                        tagsCount: node.data.metadata.tagsCount,
                        hasCustomTags: node.data.flags.hasCustomTags
                    });
                }
                
                // 确保nodeDatabase兼容性
                if (!nodeDatabase[nodeId]) {
                    nodeDatabase[nodeId] = {
                        id: nodeId,
                        title: node.topic,
                        content: '',
                        author: '',
                        tags: { categories: [], technical: [], status: [] },
                        time: { created: new Date().toLocaleString(), modified: new Date().toLocaleString() },
                        relations: {
                            parent: node.parent ? node.parent.id : null,
                            children: node.children ? node.children.map(child => child.id) : []
                        }
                    };
                }
                
                // 🔄 同步更新nodeDatabase（保持向后兼容）
                if (nodeData.title) nodeDatabase[nodeId].title = nodeData.title;
                if (nodeData.content !== undefined) nodeDatabase[nodeId].content = nodeData.content;
                if (nodeData.author !== undefined) nodeDatabase[nodeId].author = nodeData.author;
                
                // 🏷️ 同步标签数据到nodeDatabase
                if (nodeData.tags && Array.isArray(nodeData.tags)) {
                    // 将PyQt标签数组分配到不同类别
                    nodeDatabase[nodeId].tags.categories = node.data.tags.categories;
                    nodeDatabase[nodeId].tags.technical = node.data.tags.technical;
                    nodeDatabase[nodeId].tags.status = node.data.tags.status;
                    console.log('✅ nodeDatabase标签数据已同步');
                }
                
                // 📅 同步时间信息到nodeDatabase
                nodeDatabase[nodeId].time.modified = new Date().toLocaleString();
                
                // 同步创建时间
                if (nodeData.createdTime && (!nodeDatabase[nodeId].time.created || nodeDatabase[nodeId].time.created === '')) {
                    nodeDatabase[nodeId].time.created = nodeData.createdTime;
                }
                
                // 添加保存时间戳
                if (nodeData.saveTimestamp) {
                    nodeDatabase[nodeId].lastSaved = nodeData.saveTimestamp;
                }
                
                // 更新统一数据结构时间戳
                node.data.time.modified = new Date().toISOString();
                
                if (hasChanges) {
                    // 触发自动保存
                    autoSaveData();
                    
                    // 刷新当前显示的节点详情（如果是当前编辑的节点）
                    if (currentEditingNodeId === nodeId) {
                        // 更新表单显示（不会触发循环保存）
                        var titleEl = document.getElementById('node_title_' + nodeId);
                        var contentEl = document.getElementById('node_content_' + nodeId);
                        var authorEl = document.getElementById('node_author_' + nodeId);
                        
                        if (titleEl && nodeData.title) titleEl.value = nodeData.title;
                        if (contentEl && nodeData.content !== undefined) contentEl.value = nodeData.content;
                        if (authorEl && nodeData.author !== undefined) authorEl.value = nodeData.author;
                    }
                    
                    console.log('✅ PyQt数据保存完成，节点:', nodeId);
                    showMessage('💾 PyQt数据已保存到节点');
                    return true;
                } else {
                    console.log('ℹ️ 无变化，跳过保存');
                    return false;
                }
                
            } catch (error) {
                console.error('❌ PyQt数据保存失败:', error);
                return false;
            }
        };
        
        // 递归计算节点数量
        function countNodes(nodeData) {
            if (!nodeData) return 0;
            var count = 1;
            if (nodeData.children) {
                nodeData.children.forEach(function(child) {
                    count += countNodes(child);
                });
            }
            return count;
        }
        
        // 加载保存的数据
        function loadSavedData() {
            try {
                // 加载思维导图数据
                var savedMindmapData = localStorage.getItem(STORAGE_KEYS.MINDMAP_DATA);
                var savedNodeDatabase = localStorage.getItem(STORAGE_KEYS.NODE_DATABASE);
                var savedTheme = localStorage.getItem(STORAGE_KEYS.CURRENT_THEME);
                var savedDragState = localStorage.getItem(STORAGE_KEYS.DRAG_ENABLED);
                var savedSelectedNode = localStorage.getItem(STORAGE_KEYS.SELECTED_NODE);
                var savedCurrentMindmap = localStorage.getItem('nodemind_current_mindmap');
                
                var hasRecoveredData = false;
                
                // 恢复多工作区思维导图数据
                if (savedMindmapData) {
                    try {
                        var allMindmapData = JSON.parse(savedMindmapData);
                        
                        // 恢复每个工作区的数据
                        if (allMindmapData && typeof allMindmapData === 'object') {
                            Object.keys(allMindmapData).forEach(function(tabName) {
                                var mindmapData = allMindmapData[tabName];
                                if (mindmapData && mindmapData.data && mindmaps[tabName]) {
                                    mindmaps[tabName].show(mindmapData);
                                    hasRecoveredData = true;
                                    console.log('✅ ' + tabName + ' 工作区数据已恢复');
                                }
                            });
                            
                            // 恢复当前活跃工作区
                            if (savedCurrentMindmap && mindmaps[savedCurrentMindmap]) {
                                currentMindmap = savedCurrentMindmap;
                                switchMindmapTab(currentMindmap);
                                console.log('✅ 当前工作区已恢复为:', currentMindmap);
                            }
                        }
                    } catch (e) {
                        console.error('思维导图数据恢复失败:', e);
                    }
                }
                
                // 恢复节点详细信息数据库（恢复兼容性）
                if (savedNodeDatabase) {
                    try {
                        nodeDatabase = JSON.parse(savedNodeDatabase);
                        console.log('✅ 节点数据库已恢复，包含', Object.keys(nodeDatabase).length, '个节点详情');
                    } catch (e) {
                        console.error('节点数据库恢复失败:', e);
                        nodeDatabase = {};
                    }
                }
                
                // 恢复主题设置
                if (savedTheme) {
                    try {
                        var themeIndex = parseInt(savedTheme);
                        if (themeIndex >= 0 && themeIndex < themes.length) {
                            currentThemeIndex = themeIndex;
                            jm.set_theme(themes[currentThemeIndex].name);
                            console.log('✅ 主题设置已恢复:', themes[currentThemeIndex].label);
                        }
                    } catch (e) {
                        console.error('主题设置恢复失败:', e);
                    }
                }
                
                // 恢复拖拽状态
                if (savedDragState) {
                    try {
                        isDragEnabled = (savedDragState === 'true');
                        if (isDragEnabled) {
                            jm.enable_draggable_node();
                        } else {
                            jm.disable_draggable_node();
                        }
                        updateDragStatusDisplay();
                        console.log('✅ 拖拽状态已恢复:', isDragEnabled ? '启用' : '禁用');
                    } catch (e) {
                        console.error('拖拽状态恢复失败:', e);
                    }
                }
                
                // 恢复选中节点
                if (savedSelectedNode && hasRecoveredData) {
                    setTimeout(function() {
                        try {
                            var node = jm.get_node(savedSelectedNode);
                            if (node) {
                                jm.select_node(savedSelectedNode);
                                showNodeDetails(savedSelectedNode);
                                console.log('✅ 选中节点已恢复:', node.topic);
                            }
                        } catch (e) {
                            console.error('选中节点恢复失败:', e);
                        }
                    }, 300);
                }
                
                if (hasRecoveredData) {
                    showMessage('🔄 已从本地存储恢复上次的思维导图状态');
                } else {
                    // 如果没有保存的数据，初始化默认数据
                    initNodeDatabase();
                }
                
                return hasRecoveredData;
                
            } catch (error) {
                console.error('数据恢复失败:', error);
                showMessage('❌ 数据恢复失败，使用默认数据');
                initNodeDatabase();
                return false;
            }
        }
        
        // 清除保存的数据
        function clearSavedData() {
            if (confirm('⚠️ 确定要清除所有保存的数据吗？这将删除本地存储的思维导图、主题设置等信息。')) {
                try {
                    Object.values(STORAGE_KEYS).forEach(function(key) {
                        localStorage.removeItem(key);
                    });
                    
                    showMessage('🗑️ 本地存储数据已清除');
                    console.log('✅ 本地存储数据已清除');
                    
                    // 重新加载默认数据
                    setTimeout(function() {
                        location.reload();
                    }, 1000);
                    
                } catch (error) {
                    console.error('清除数据失败:', error);
                    showMessage('❌ 清除数据失败: ' + error.message);
                }
            }
        }

        // 页面加载完成
        window.addEventListener('load', function() {
            // 首先确保多工作区已正确初始化
            if (!mindmaps.workspace || !mindmaps.knowledge || !mindmaps.project) {
                console.log('重新初始化多工作区...');
                initMindmaps();
            }
            
            // 尝试加载保存的数据
            var hasRecoveredData = loadSavedData();
            
            // 如果没有恢复数据，进行正常初始化
            if (!hasRecoveredData) {
                // 初始化当前活跃工作区的节点数据库
                initNodeDatabase();
                
                // 显示选中节点
                updateSelectedNodeDisplay();
                
                // 如果有选中节点，显示详细信息
                var selected = getCurrentJsMind().get_selected_node();
                if (selected) {
                    showNodeDetails(selected.id);
                }
            }
            
            // 设置自动保存
            setupAutoSave();
            
            showMessage('🎉 jsMind 本地拖拽演示已启动！');
            console.log('jsMind 本地拖拽版本演示已启动');
            console.log('版本: 0.8.7 (本地版本)');
            console.log('拖拽功能: 已启用');
            console.log('当前主题:', themes[currentThemeIndex].label);
        });

        // 数据导出功能
        function exportToFile() {
            try {
                var mind_data = jm.get_data();
                if (!mind_data) {
                    showMessage('❌ 无数据可导出');
                    return;
                }
                
                // 构建导出数据，包含节点详细信息
                var exportData = {
                    mindmap: mind_data,
                    nodeDetails: nodeDatabase,
                    exportInfo: {
                        timestamp: new Date().toISOString(),
                        version: "1.0.0",
                        exported_by: "NodeMind"
                    }
                };
                
                var mind_str = JSON.stringify(exportData, null, 2);
                var filename = (mind_data.meta && mind_data.meta.name) ? mind_data.meta.name : 'mindmap';
                filename = filename.replace(/[^a-zA-Z0-9\u4e00-\u9fa5]/g, '_') + '_' + new Date().getTime();
                
                // 使用 jsMind 工具保存文件
                if (typeof jsMind !== 'undefined' && jsMind.util && jsMind.util.file) {
                    jsMind.util.file.save(mind_str, 'application/json', filename + '.json');
                    showMessage('✅ JSON文件导出成功: ' + filename + '.json');
                } else {
                    // 备用方案：手动创建下载
                    downloadFile(mind_str, filename + '.json', 'application/json');
                    showMessage('✅ JSON文件导出成功: ' + filename + '.json');
                }
                
                console.log('导出数据:', exportData);
            } catch (error) {
                console.error('导出失败:', error);
                showMessage('❌ 导出失败: ' + error.message);
            }
        }
        
        function exportToCustomFile() {
            try {
                var mind_data = jm.get_data();
                if (!mind_data) {
                    showMessage('❌ 无数据可导出');
                    return;
                }
                
                // 构建导出数据
                var exportData = {
                    mindmap: mind_data,
                    nodeDetails: nodeDatabase,
                    exportInfo: {
                        timestamp: new Date().toISOString(),
                        version: "1.0.0",
                        exported_by: "NodeMind",
                        export_type: "custom_with_path_selection"
                    }
                };
                
                var mind_str = JSON.stringify(exportData, null, 2);
                var defaultName = (mind_data.meta && mind_data.meta.name) ? mind_data.meta.name : 'mindmap';
                
                // 优先使用PyQt文件保存对话框
                if (typeof window.pyqt_bridge !== 'undefined' && window.pyqt_bridge.saveFileWithDialog) {
                    console.log('🎯 使用PyQt文件保存对话框...');
                    var savedPath = window.pyqt_bridge.saveFileWithDialog(mind_str, defaultName);
                    
                    if (savedPath && savedPath.length > 0) {
                        showMessage('✅ 思维导图已保存到: ' + savedPath);
                        console.log('✅ 文件保存成功:', savedPath);
                    } else {
                        showMessage('🚫 文件保存已取消');
                        console.log('🚫 用户取消了文件保存');
                    }
                } else {
                    // 备用方案：原有的简单文件名输入方式
                    console.log('⚠️ PyQt文件对话框不可用，使用备用方案');
                    var customName = prompt('请输入导出文件名（不含扩展名）:', defaultName);
                    
                    if (customName === null) {
                        showMessage('🚫 导出已取消');
                        return;
                    }
                    
                    if (!customName || customName.trim() === '') {
                        customName = 'mindmap_' + new Date().getTime();
                    }
                    
                    // 清理文件名
                    customName = customName.trim().replace(/[^a-zA-Z0-9\u4e00-\u9fa5]/g, '_');
                    
                    // 使用浏览器下载
                    if (typeof jsMind !== 'undefined' && jsMind.util && jsMind.util.file) {
                        jsMind.util.file.save(mind_str, 'application/json', customName + '.json');
                        showMessage('✅ 自定义文件导出成功: ' + customName + '.json');
                    } else {
                        downloadFile(mind_str, customName + '.json', 'application/json');
                        showMessage('✅ 自定义文件导出成功: ' + customName + '.json');
                    }
                }
                
                console.log('自定义导出数据:', exportData);
            } catch (error) {
                console.error('自定义导出失败:', error);
                showMessage('❌ 自定义导出失败: ' + error.message);
            }
        }
        
        // 备用下载函数
        function downloadFile(content, filename, contentType) {
            var blob = new Blob([content], { type: contentType });
            var url = URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.style.display = 'none';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // 快速导出（仅思维导图数据）
        function quickExport() {
            try {
                var mind_data = jm.get_data();
                if (!mind_data) {
                    showMessage('❌ 无数据可导出');
                    return;
                }
                
                var mind_str = JSON.stringify(mind_data, null, 2);
                var filename = 'mindmap_quick_' + new Date().getTime();
                
                downloadFile(mind_str, filename + '.json', 'application/json');
                showMessage('⚡ 快速导出成功: ' + filename + '.json');
                
            } catch (error) {
                console.error('快速导出失败:', error);
                showMessage('❌ 快速导出失败: ' + error.message);
            }
        }

        // 文件导入功能
        function triggerImport() {
            var fileInput = document.getElementById('import_file_input');
            fileInput.click();
        }
        
        function handleFileImport(fileInput) {
            var files = fileInput.files;
            if (files.length > 0) {
                var file = files[0];
                importMindmapFile(file);
            }
        }
        
        function importMindmapFile(file) {
            try {
                var fileName = file.name.toLowerCase();
                
                // 检查文件类型
                if (!fileName.endsWith('.json') && !fileName.endsWith('.jm') && !fileName.endsWith('.mm')) {
                    showMessage('❌ 不支持的文件格式，仅支持 .json、.jm、.mm 文件');
                    return;
                }
                
                showMessage('📂 正在导入文件: ' + file.name);
                
                // 使用 jsMind 工具读取文件
                if (typeof jsMind !== 'undefined' && jsMind.util && jsMind.util.file) {
                    jsMind.util.file.read(file, function(fileData, fileName) {
                        try {
                            processMindmapData(fileData, fileName, file.name);
                        } catch (error) {
                            console.error('文件处理失败:', error);
                            showMessage('❌ 文件处理失败: ' + error.message);
                        }
                    });
                } else {
                    // 备用方案：使用 FileReader
                    var reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            processMindmapData(e.target.result, file.name, file.name);
                        } catch (error) {
                            console.error('文件读取失败:', error);
                            showMessage('❌ 文件读取失败: ' + error.message);
                        }
                    };
                    reader.readAsText(file);
                }
                
            } catch (error) {
                console.error('导入失败:', error);
                showMessage('❌ 导入失败: ' + error.message);
            }
        }
        
        function processMindmapData(fileData, fileName, originalFileName) {
            try {
                var mind = null;
                var fileExtension = originalFileName.toLowerCase().split('.').pop();
                
                if (fileExtension === 'mm') {
                    // FreeMind 格式
                    var mindName = fileName;
                    if (/.*\.mm$/.test(mindName)) {
                        mindName = fileName.substring(0, fileName.length - 3);
                    }
                    
                    mind = {
                        meta: {
                            name: mindName,
                            author: 'NodeMind Imported',
                            version: '1.0.0',
                        },
                        format: 'freemind',
                        data: fileData,
                    };
                } else {
                    // JSON 或 JM 格式
                    if (typeof fileData === 'string') {
                        mind = JSON.parse(fileData);
                    } else {
                        mind = fileData;
                    }
                    
                    // 检查是否是我们导出的完整格式
                    if (mind && mind.mindmap && mind.nodeDetails) {
                        // 恢复节点详细信息
                        nodeDatabase = mind.nodeDetails || {};
                        mind = mind.mindmap;
                        showMessage('📋 检测到完整数据格式，正在恢复节点详细信息...');
                    }
                    
                    // 验证数据格式
                    if (!mind || !mind.data) {
                        throw new Error('无效的思维导图数据格式');
                    }
                }
                
                // 显示思维导图
                if (mind) {
                    jm.show(mind);
                    
                    // 重新初始化节点数据库（如果没有从文件中恢复）
                    if (!mind.nodeDetails) {
                        setTimeout(function() {
                            initNodeDatabase();
                        }, 100);
                    }
                    
                    showMessage('✅ 文件导入成功: ' + originalFileName);
                    console.log('导入的思维导图数据:', mind);
                    
                    // 更新主题显示
                    updateSelectedNodeDisplay();
                    
                    // 如果有根节点，选择它
                    setTimeout(function() {
                        var rootNode = jm.get_node(jm.get_root().id);
                        if (rootNode) {
                            jm.select_node(rootNode.id);
                        }
                    }, 200);
                    
                } else {
                    throw new Error('无法解析思维导图数据');
                }
                
            } catch (error) {
                console.error('数据处理失败:', error);
                showMessage('❌ 数据处理失败: ' + error.message);
            }
            
            // 清空文件输入
            document.getElementById('import_file_input').value = '';
        }
        
        // 重置思维导图
        function resetMindmap() {
            if (confirm('⚠️ 确定要重置思维导图吗？当前所有数据将丢失！')) {
                jm.show(mindData);
                nodeDatabase = {};
                initNodeDatabase();
                showMessage('🔄 思维导图已重置');
            }
        }
        
        // 显示使用指南
        function showUserGuide() {
            var guideWindow = window.open('', '_blank', 'width=1000,height=700,scrollbars=yes,resizable=yes');
            var guideContent = `
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <!-- 缓存破坏标记 - 2025-06-12T09:36:21.220473 -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="version" content="1749692181">

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NodeMind 使用指南</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            border-radius: 12px;
            padding: 40px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        h1 { 
            color: #2c3e50; 
            text-align: center; 
            font-size: 32px; 
            margin-bottom: 30px;
            border-bottom: 3px solid #3498db;
            padding-bottom: 15px;
        }
        h2 { 
            color: #34495e; 
            font-size: 24px; 
            margin-top: 30px; 
            margin-bottom: 15px;
            padding-left: 10px;
            border-left: 4px solid #3498db;
        }
        h3 { 
            color: #2c3e50; 
            font-size: 18px; 
            margin-top: 20px; 
            margin-bottom: 10px;
        }
        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .feature-card {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            border-left: 4px solid #28a745;
        }
        .feature-card h4 {
            color: #2c3e50;
            margin: 0 0 15px 0;
            font-size: 16px;
        }
        ul { 
            margin: 10px 0; 
            padding-left: 20px; 
        }
        li { 
            margin: 8px 0; 
            font-size: 14px;
        }
        .highlight {
            background: #fff3cd;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid #ffc107;
            margin: 15px 0;
        }
        .shortcut-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        .shortcut-table th, .shortcut-table td {
            border: 1px solid #dee2e6;
            padding: 12px;
            text-align: left;
        }
        .shortcut-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
        }
        .shortcut-table tr:nth-child(even) {
            background: #f8f9fa;
        }
        .btn-guide {
            background: #007bff;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            margin: 5px;
            cursor: pointer;
        }
        .emoji { font-size: 18px; }
        .version-info {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 6px;
            margin: 20px 0;
            border-left: 4px solid #2196f3;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>📚 NodeMind 使用指南</h1>
        
        <div class="version-info">
            <strong>🎯 NodeMind v1.0.0</strong> - 基于 jsMind 的智能思维导图工具
            <br>
            <small>支持拖拽、导入导出、持久化存储的全功能思维导图应用</small>
        </div>

        <h2>🚀 快速开始</h2>
        <div class="highlight">
            <strong>💡 提示：</strong> NodeMind 支持完全的键盘操作，所有功能都可以通过快捷键快速访问！
        </div>

        <h2>⌨️ 快捷键指南</h2>
        <table class="shortcut-table">
            <thead>
                <tr>
                    <th>功能分类</th>
                    <th>快捷键</th>
                    <th>说明</th>
                </tr>
            </thead>
            <tbody>
                <tr><td rowspan="6"><strong>节点操作</strong></td><td>Ctrl+Enter</td><td>添加子节点</td></tr>
                <tr><td>Enter</td><td>添加兄弟节点</td></tr>
                <tr><td>F2</td><td>编辑节点内容</td></tr>
                <tr><td>Delete</td><td>删除节点</td></tr>
                <tr><td>Space</td><td>展开/收起节点</td></tr>
                <tr><td>方向键</td><td>选择相邻节点</td></tr>
                
                <tr><td rowspan="4"><strong>文件操作</strong></td><td>Ctrl+S</td><td>导出完整JSON文件</td></tr>
                <tr><td>Ctrl+E</td><td>自定义文件名导出</td></tr>
                <tr><td>Ctrl+Q</td><td>快速导出</td></tr>
                <tr><td>Ctrl+O</td><td>导入文件</td></tr>
                
                <tr><td rowspan="1"><strong>帮助</strong></td><td>Ctrl+H</td><td>显示快捷键帮助</td></tr>
            </tbody>
        </table>

        <h2>🎨 核心功能</h2>
        <div class="feature-grid">
            <div class="feature-card">
                <h4>🧠 思维导图编辑</h4>
                <ul>
                    <li>拖拽节点重新组织结构</li>
                    <li>支持跨分支拖拽移动</li>
                    <li>实时自动布局调整</li>
                    <li>多种节点编辑方式</li>
                </ul>
            </div>
            
            <div class="feature-card">
                <h4>💾 数据管理</h4>
                <ul>
                    <li>自动持久化存储</li>
                    <li>支持JSON/JM/MM格式</li>
                    <li>完整的导入导出功能</li>
                    <li>页面关闭数据保护</li>
                </ul>
            </div>
            
            <div class="feature-card">
                <h4>🎭 界面主题</h4>
                <ul>
                    <li>15种内置主题</li>
                    <li>主题设置自动保存</li>
                    <li>响应式设计</li>
                    <li>移动端完美支持</li>
                </ul>
            </div>
            
            <div class="feature-card">
                <h4>📋 节点详细信息</h4>
                <ul>
                    <li>丰富的节点属性编辑</li>
                    <li>分类标签管理</li>
                    <li>时间戳记录</li>
                    <li>节点关系显示</li>
                </ul>
            </div>
        </div>

        <h2>🖱️ 鼠标操作指南</h2>
        <ul>
            <li><strong>单击节点</strong> - 选中节点</li>
            <li><strong>双击节点</strong> - 编辑节点内容</li>
            <li><strong>拖拽画布</strong> - 移动视图</li>
            <li><strong>滚轮</strong> - 缩放思维导图</li>
            <li><strong>拖拽节点</strong> - 重新组织结构</li>
        </ul>

        <h2>🔄 数据持久化</h2>
        <p>NodeMind 具备完整的自动保存功能：</p>
        <ul>
            <li><strong>实时保存</strong> - 所有操作自动保存到本地存储</li>
            <li><strong>状态恢复</strong> - 页面重新加载时自动恢复工作状态</li>
            <li><strong>多层保护</strong> - 页面关闭前强制保存</li>
            <li><strong>数据管理</strong> - 支持手动清除存储数据</li>
        </ul>

        <h2>📁 文件格式支持</h2>
        <div class="feature-grid">
            <div class="feature-card">
                <h4>📄 导入格式</h4>
                <ul>
                    <li><strong>.json</strong> - 标准JSON格式</li>
                    <li><strong>.jm</strong> - jsMind原生格式</li>
                    <li><strong>.mm</strong> - FreeMind格式</li>
                </ul>
            </div>
            
            <div class="feature-card">
                <h4>💾 导出选项</h4>
                <ul>
                    <li><strong>完整导出</strong> - 包含所有节点详细信息</li>
                    <li><strong>自定义导出</strong> - 用户指定文件名</li>
                    <li><strong>快速导出</strong> - 仅核心思维导图数据</li>
                </ul>
            </div>
        </div>

        <h2>🛠️ 高级技巧</h2>
        <div class="highlight">
            <h3>💡 效率提升技巧</h3>
            <ul>
                <li><strong>批量操作</strong> - 使用Ctrl+快捷键快速操作</li>
                <li><strong>拖拽重组</strong> - 直接拖拽节点改变结构</li>
                <li><strong>主题切换</strong> - 不同场景使用不同主题</li>
                <li><strong>标签管理</strong> - 使用标签分类管理节点</li>
            </ul>
        </div>

        <h2>🚨 常见问题</h2>
        <h3>Q: 页面刷新后数据丢失怎么办？</h3>
        <p>A: NodeMind 具备自动保存功能，数据会自动恢复。如果仍有问题，可能是浏览器禁用了本地存储。</p>
        
        <h3>Q: 支持哪些浏览器？</h3>
        <p>A: 支持所有现代浏览器（Chrome、Firefox、Safari、Edge等），建议使用最新版本。</p>
        
        <h3>Q: 如何备份数据？</h3>
        <p>A: 使用 Ctrl+S 导出完整数据，包含所有节点详细信息，可作为完整备份。</p>

        <div style="text-align: center; margin-top: 40px; padding-top: 20px; border-top: 2px solid #eee;">
            <p><strong>🎉 开始使用 NodeMind，让思维可视化！</strong></p>
            <button class="btn-guide" onclick="window.close()">关闭指南</button>
        </div>
    </div>
</body>
</html>`;
            
            guideWindow.document.write(guideContent);
            guideWindow.document.close();
            guideWindow.focus();
            
            showMessage('📚 使用指南已打开');
        }

        // 新内容功能 - 保存当前脑图并创建空白脑图
        function createNewContent() {
            try {
                // 1. 先保存当前脑图
                var currentMind = getCurrentJsMind();
                if (currentMind) {
                    var mind_data = currentMind.get_data();
                    if (mind_data) {
                        // 生成时间戳文件名
                        var timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
                        var backupName = 'mindmap_backup_' + timestamp;
                        
                        // 构建保存数据
                        var exportData = {
                            mindmap: mind_data,
                            nodeDetails: nodeDatabase,
                            exportInfo: {
                                timestamp: new Date().toISOString(),
                                version: "1.0.0",
                                exported_by: "NodeMind",
                                backup_type: "auto_before_new_content"
                            }
                        };
                        
                        var mind_str = JSON.stringify(exportData, null, 2);
                        
                        // 自动保存备份文件
                        if (typeof jsMind !== 'undefined' && jsMind.util && jsMind.util.file) {
                            jsMind.util.file.save(mind_str, 'application/json', backupName + '.json');
                        } else {
                            // 备用方案
                            downloadFile(mind_str, backupName + '.json', 'application/json');
                        }
                        
                        showMessage('✅ 已保存当前脑图: ' + backupName + '.json');
                    }
                }
                
                // 2. 创建新的空白脑图数据
                var newMindData = {
                    meta: {
                        name: "新内容脑图",
                        author: "NodeMind",
                        version: "1.0.0"
                    },
                    format: "node_tree",
                    data: {
                        id: "new_root_" + Date.now(),
                        topic: "🧠 中心节点",
                        children: []
                    }
                };
                
                // 3. 更新当前活跃脑图
                var currentMindmap = getCurrentJsMind();
                if (currentMindmap) {
                    currentMindmap.show(newMindData);
                    
                    // 4. 清空节点数据库
                    nodeDatabase = {};
                    
                    // 5. 初始化新的根节点数据
                    nodeDatabase[newMindData.data.id] = {
                        id: newMindData.data.id,
                        title: newMindData.data.topic,
                        content: '',
                        relations: {
                            parent: null,
                            children: []
                        },
                        tags: {
                            categories: [],
                            technical: [],
                            status: []
                        },
                        time: {
                            created: new Date().toLocaleString(),
                            updated: new Date().toLocaleString()
                        },
                        details: {
                            description: '',
                            implementation: '',
                            testing: '',
                            notes: ''
                        }
                    };
                    
                    // 6. 清空详情面板（检查元素存在性）
                    var detailElement = document.getElementById('detail-info-content');
                    if (detailElement) {
                        detailElement.innerHTML = `
                            <div class="empty-state">
                                <div class="icon">📝</div>
                                <div>点击思维导图中的节点编辑详细描述</div>
                            </div>
                        `;
                    }
                    
                    var basicElement = document.getElementById('basic-info-content');
                    if (basicElement) {
                        basicElement.innerHTML = `
                            <div class="empty-state">
                                <div class="icon">📋</div>
                                <div>点击思维导图中的节点查看基本信息</div>
                            </div>
                        `;
                    }
                    
                    var historyElement = document.getElementById('history-info-content');
                    if (historyElement) {
                        historyElement.innerHTML = `
                            <div class="empty-state">
                                <div class="icon">📚</div>
                                <div>点击思维导图中的节点查看历史记录</div>
                            </div>
                        `;
                    }
                    
                    // 7. 更新状态显示
                    document.getElementById('selectedNode').textContent = '无';
                    
                    // 8. 自动保存新状态
                    setTimeout(function() {
                        autoSaveData();
                    }, 500);
                    
                    showMessage('✨ 新内容脑图已创建！中心节点已准备就绪');
                    console.log('新内容脑图创建完成');
                }
                
            } catch (error) {
                console.error('创建新内容失败:', error);
                showMessage('❌ 创建新内容失败: ' + error.message);
            }
        }

        // 添加键盘快捷键和帮助
        document.addEventListener('keydown', function(e) {
            // 导出功能快捷键
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                exportToFile();
                return;
            }
            
            if (e.ctrlKey && e.key === 'e') {
                e.preventDefault();
                exportToCustomFile();
                return;
            }
            
            if (e.ctrlKey && e.key === 'q') {
                e.preventDefault();
                quickExport();
                return;
            }
            
            if (e.ctrlKey && e.key === 'o') {
                e.preventDefault();
                triggerImport();
                return;
            }
            
            // 帮助快捷键
            if (e.ctrlKey && e.key === 'h') {
                e.preventDefault();
                                 alert('jsMind 拖拽演示 - 快捷键帮助:\n\n基本操作:\n• Ctrl+Enter - 添加子节点\n• Enter - 添加兄弟节点\n• F2 - 编辑节点内容\n• Delete - 删除节点\n• Space - 展开/收起节点\n• 方向键 - 选择相邻节点\n\n文件操作:\n• Ctrl+S - 导出完整JSON文件\n• Ctrl+E - 自定义文件名导出\n• Ctrl+Q - 快速导出（仅思维导图数据）\n• Ctrl+O - 导入文件（支持JSON/JM/MM格式）\n\n拖拽操作:\n• 鼠标左键拖拽节点移动\n• 拖拽到目标节点上释放\n• 支持跨分支拖拽\n• 实时视觉反馈\n\nCtrl+H - 显示此帮助');
            }
        });

        // ================ 根节点隐藏系统（专家建议方案2实施） ================
        
        console.log('🎯 采用jsMind官方custom_node_render机制实现根节点隐藏');
        
        // 🎯 官方方案：通过custom_node_render自动隐藏根节点，无需复杂配置
        
        console.log('✅ 根节点隐藏已通过官方custom_node_render机制实现');
        
        // 🎯 官方方案已完全实现根节点隐藏，无需额外处理

        // 🎯 新增：二级标签管理系统 - 标签组-标签结构
        function renderDetailInfoWithGroupedTags(nodeId) {
            var node = getCurrentJsMind().get_node(nodeId);
            if (!node || !node.data) return;
            
            var nodeData = node.data;
            var path = getNodePath(node);
            
            // 定义标签组配置
            var tagGroups = {
                '常规': {
                    icon: '📋',
                    categories: ['项目', '幻觉', '完成', '犯环'],
                    tags: nodeData.tags?.categories || []
                },
                'AI开发': {
                    icon: '🤖', 
                    categories: ['计划'],
                    tags: nodeData.tags?.technical || []
                }
            };
            
            var content = `
                <div style="padding: 20px;">
                    <h4 style="margin: 0 0 15px 0; color: #495057; font-size: 16px; font-weight: 600;">
                        📋 节点详细信息
                    </h4>
                    
                    <div class="path-breadcrumb" style="margin-bottom: 15px; font-size: 12px; color: #6c757d;">
                        节点路径: ${path.map((item, index) => 
                            index < path.length - 1 ? 
                            `<span style="color: #007bff;">${item.replace(/<[^>]*>/g, '')}</span> → ` : 
                            `<span style="color: #007bff; font-weight: 600;">${item.replace(/<[^>]*>/g, '')}</span>`
                        ).join('')}
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <strong style="color: #495057;">节点标题:</strong><br>
                        <span style="color: #333; font-size: 14px;">${node.topic}</span>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <strong style="color: #495057;">详细内容:</strong><br>
                        <div style="background: #f8f9fa; padding: 12px; border-radius: 4px; border: 1px solid #dee2e6; font-size: 13px; color: #333; min-height: 60px;">
                            ${nodeData.content || '暂无详细内容'}
                        </div>
                    </div>
                    
                    <!-- 🎯 二级标签管理区域 -->
                    <div style="margin-bottom: 15px;">
                        <h5 style="color: #495057; font-weight: 600; margin-bottom: 12px;">🏷️ 标签管理</h5>
                        
                        ${Object.keys(tagGroups).map(groupName => {
                            var group = tagGroups[groupName];
                            return `
                                <div class="tag-group-container" style="margin-bottom: 16px; border: 1px solid #e0e0e0; border-radius: 8px; background: #fafafa;">
                                    <!-- 标签组标题 -->
                                    <div class="tag-group-header" style="background: #f0f0f0; padding: 8px 12px; border-radius: 8px 8px 0 0; border-bottom: 1px solid #e0e0e0;">
                                        <span style="font-weight: 600; color: #333; font-size: 13px;">
                                            ${group.icon} ${groupName}
                                        </span>
                                    </div>
                                    
                                    <!-- 标签组内容 -->
                                    <div class="tag-group-content" style="padding: 12px;">
                                        ${group.categories.length > 0 ? `
                                            <div class="tag-category-row" style="margin-bottom: 8px;">
                                                <span style="font-size: 11px; color: #666; margin-right: 8px;">类别:</span>
                                                ${group.categories.map(category => 
                                                    `<span class="tag-category-item" style="background: #e3f2fd; color: #1976d2; padding: 2px 6px; border-radius: 10px; font-size: 10px; margin-right: 4px;">${category}</span>`
                                                ).join('')}
                                            </div>
                                        ` : ''}
                                        
                                        <div class="tag-items-row">
                                            <span style="font-size: 11px; color: #666; margin-right: 8px;">标签:</span>
                                            <div class="tag-list" style="display: inline-flex; flex-wrap: wrap; gap: 4px;">
                                                ${group.tags.length > 0 ? 
                                                    group.tags.map(tag => 
                                                        `<span class="tag-item" style="background: #e9ecef; color: #495057; padding: 3px 8px; border-radius: 12px; font-size: 11px; display: inline-flex; align-items: center; gap: 4px;">
                                                            ${tag}
                                                            <button type="button" onclick="removeGroupTag('${nodeId}', '${groupName}', '${tag}')" class="tag-remove" style="background: none; border: none; color: #6c757d; cursor: pointer; font-size: 12px; padding: 0; margin-left: 2px;">×</button>
                                                        </span>`
                                                    ).join('') : 
                                                    '<span style="color: #999; font-size: 11px; font-style: italic;">暂无标签</span>'
                                                }
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <strong style="color: #495057;">基本信息:</strong><br>
                        <div style="font-size: 13px; color: #666; line-height: 1.6;">
                            • 节点ID: ${nodeId}<br>
                            • 创建时间: ${nodeData.time?.created || '未设置'}<br>
                            • 修改时间: ${nodeData.time?.modified || '未设置'}<br>
                            • 作者: ${nodeData.author || '未设置'}
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #dee2e6; font-size: 12px; color: #6c757d;">
                        💡 提示：使用脑图管理区的"🔄 标签同步"按钮可同步标签管理脑图的内容
                    </div>
                </div>
            `;
            
            var detailElement = document.getElementById('detail-info-content');
            if (detailElement) {
                detailElement.innerHTML = content;
            }
        }

        // 🎯 移除标签组中的标签
        function removeGroupTag(nodeId, groupName, tag) {
            var node = getCurrentJsMind().get_node(nodeId);
            if (!node || !node.data) return;
            
            // 根据标签组映射到具体的标签类型
            var tagTypeMapping = {
                '常规': 'categories',
                'AI开发': 'technical'
            };
            
            var tagType = tagTypeMapping[groupName];
            if (!tagType) return;
            
            // 移除标签
            if (node.data.tags && node.data.tags[tagType]) {
                var tagIndex = node.data.tags[tagType].indexOf(tag);
                if (tagIndex > -1) {
                    node.data.tags[tagType].splice(tagIndex, 1);
                    
                    // 更新修改时间
                    if (!node.data.time) node.data.time = {};
                    node.data.time.modified = new Date().toISOString();
                    
                    // 标记未保存更改
                    if (!node.data.flags) node.data.flags = {};
                    node.data.flags.hasUnsavedChanges = true;
                    
                    // 重新渲染详情页
                    renderDetailInfoWithGroupedTags(nodeId);
                    
                    // 自动保存
                    autoSaveData();
                    
                    console.log(`✅ 已从${groupName}移除标签: ${tag}`);
                    showMessage(`已移除标签: ${tag}`);
                }
            }
        }

        // 🎯 标签同步功能 - 从标签管理脑图同步到当前节点
        function syncTagsFromMindmapToNode(nodeId) {
            console.log('🔄 开始标签同步...');
            
            // 1. 确保标签数据库是最新的
            syncMindmapToTagDatabase();
            
            // 2. 获取当前节点
            var node = getCurrentJsMind().get_node(nodeId);
            if (!node) {
                showMessage('❌ 未找到目标节点');
                return;
            }
            
            // 3. 确保节点有data结构
            if (!node.data) {
                node.data = createDefaultNodeData();
            }
            
            // 4. 清空当前节点的所有标签
            if (!node.data.tags) {
                node.data.tags = {
                    categories: [],
                    technical: [],
                    status: [],
                    priority: '',
                    custom: []
                };
            }
            
            // 5. 从标签数据库同步所有标签到当前节点
            var syncCount = 0;
            
            if (tagDatabase.categories) {
                node.data.tags.categories = [...tagDatabase.categories];
                syncCount += tagDatabase.categories.length;
            }
            
            if (tagDatabase.technical) {
                node.data.tags.technical = [...tagDatabase.technical];
                syncCount += tagDatabase.technical.length;
            }
            
            if (tagDatabase.status) {
                node.data.tags.status = [...tagDatabase.status];
                syncCount += tagDatabase.status.length;
            }
            
            if (tagDatabase.custom) {
                node.data.tags.custom = [...tagDatabase.custom];
                syncCount += tagDatabase.custom.length;
            }
            
            // 6. 更新时间戳
            if (!node.data.time) node.data.time = {};
            node.data.time.modified = new Date().toISOString();
            
            // 7. 标记未保存更改
            if (!node.data.flags) node.data.flags = {};
            node.data.flags.hasUnsavedChanges = true;
            
            // 8. 重新渲染详情页
            renderDetailInfoWithGroupedTags(nodeId);
            
            // 9. 自动保存
            autoSaveData();
            
            console.log(`✅ 标签同步完成，共同步 ${syncCount} 个标签`);
            showMessage(`✅ 标签同步完成，共同步 ${syncCount} 个标签`);
            
            return syncCount;
        }
    </script>
</body>
</html>